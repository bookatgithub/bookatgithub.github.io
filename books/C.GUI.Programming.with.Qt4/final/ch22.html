<html>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
<title>ch22.html</title>
<link rel="STYLESHEET" type="text/css" href="images/css1.css">
<link rel="STYLESHEET" type="text/css" href="images/css2.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch21lev1sec3.html><img src="images/prev.gif" width="20" height="20" border="0" align="absmiddle" alt="Previous Page"></a>
<a href=ch22lev1sec1.html><img src="images/next.gif" width="20" height="20" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<div style=""><div><a name="ch22"></a>

<h2 id="title-ID0EMGPM" class="docChapterTitle">22. Application Scripting</h2>



<p class="docText">
<img border="0" id="" width="330" height="181" src="images/NzlkOW1jM2FhMDc4L2lwdHJnZTFnMTRzOXIvMy83ZXBwdDJocF9lcl8vMmlzY2Nob25lYS5wZ3Jq.jpg" alt="" /></p>



<ul><li><p class="docList"><a name="iddle2333"></a><a name="iddle3389"></a><a name="iddle6158"></a><a name="iddle7046"></a><span class="docEmphasis"><a class="docLink" href="ch22lev1sec1.html#ch22lev1sec1">Overview of the ECMAScript Language</a></span></p></li><li><p class="docList"><span class="docEmphasis"><a class="docLink" href="ch22lev1sec2.html#ch22lev1sec2">Extending Qt Applications with Scripts</a></span></p></li><li><p class="docList"><span class="docEmphasis"><a class="docLink" href="ch22lev1sec3.html#ch22lev1sec3">Implementing GUI Extensions Using Scripts</a></span></p></li><li><p class="docList"><span class="docEmphasis"><a class="docLink" href="ch22lev1sec4.html#ch22lev1sec4">Automating Tasks through Scripting</a></span></p></li></ul>
<p class="docText"><a name="Scripts are"></a>&#83;crip&#116;s are pro&#103;rams &#119;ritten in an &#105;nterprete&#100; language that extend t&#104;e facilities of an existing system. Som&#101; sc&#114;ipts a&#114;e run as stand-a&#108;one applications, whe&#114;eas others execute embedd&#101;d in applications. Starting with &#118;ersion 4.3, Qt includes <span class="docEmphasis">QtScript</span><a name="that can"></a>, a module that can b&#101; used to make Qt applications scriptable using ECM&#65;Script, &#116;he stand&#97;rdized ve&#114;sion o&#102; JavaScript. Th&#105;s module is a complete &#114;ewrite of the earlier Trollte&#99;h product Qt &#83;crip&#116; for Application&#115; (QSA) and prov&#105;des full support for ECMAScript Editio&#110; 3.</p>
<p class="docText"><a name="is the"></a>ECMAScript is the official name of t&#104;e language standardized by Ecma International. It form&#115; the basis of JavaScript (Mozilla), JScript (Microsoft), and Acti&#111;nS&#99;ript (Adobe). A&#108;though the &#108;anguage's s&#121;ntax is super&#102;icially similar to C++ and J&#97;va, the underlying concept&#115; are rad&#105;cally d&#105;fferent and set i&#116; apart from m&#111;st other object-orien&#116;ed programming languages. In the first sec&#116;ion of this chapter, we will quickly revi&#101;w the ECMAScript language and show how &#116;o run ECM&#65;Script &#99;ode using Qt. &#73;f you &#97;lready know J&#97;vaScript or any &#111;ther ECMAScript-based language, you can &#112;rob&#97;bly just s&#107;im this section.</p>
<p class="docText"><a name="scripting support"></a>In the s&#101;cond &#115;ection, we will see how to add scripting supp&#111;rt to a Qt application. This makes it possi&#98;le for users to add their own functionality in ad&#100;ition to what the application already provide&#115;. This ap&#112;roa&#99;h is also fre&#113;uent&#108;y used to make it easie&#114; to support users; tech&#110;ical support staff can supply bug fixes and &#119;orkarounds &#105;n the fo&#114;m of scripts.</p>
<p class="docText"><a name="show how"></a>I&#110; the thir&#100; section, we will show how t&#111; develop GUI front-ends by comb&#105;ning ECMAScript code and forms created using <span class="docEmphasis">Qt De&#115;igner</span><a name="cycle associated"></a>. This technique is appealing to developers who dislike t&#104;e &quot;comp&#105;le, link, &#114;un&quot; cyc&#108;e associat&#101;d with C++ dev&#101;lopment and pref&#101;r the scripting approac&#104;. It als&#111; en&#97;bles users with Ja&#118;aScript experi&#101;nce to design ful&#108;y functional GUI interfaces without having &#116;o learn C++.</p>
<p class="docText"><a name="to develop"></a>Finally, in the last section, w&#101; will show how to develop scripts that rely on C++ compone&#110;t&#115; as part &#111;f t&#104;eir pr&#111;cessing. Th&#105;s can be done &#119;ith arbitrary C++ and C++/Qt components, which d&#111;n't &#110;e&#101;d to ha&#118;e been designed w&#105;th scriptability in mind. This app&#114;oach is especially useful when several program&#115; <a name="iddle8405"></a><a name="we want"></a>need to be written using the same basic compone&#110;ts, or when we want to make C++ functionality available to non-&#67;++ programm&#101;rs.</p>




<a name="ch22lev1sec1"></a>
<h3 class="docSection1Title" id="-100000">Overview of the ECMAScript Language</h3>
<p class="docText"><a name="a brief"></a>&#84;his se&#99;tion presen&#116;s a brief introdu&#99;tion to the ECMAScript language so &#116;hat you can understand the code snippets p&#114;esent&#101;d i&#110; the rest &#111;f the chap&#116;er and can start writing your &#111;wn scripts. The Mozilla Found&#97;tion's web site hosts a more complete tutorial at <a class="docLink" target="_blank" href="http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Guide">http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Guide</a>, and Da&#118;id Flanagan's <span class="docEmphasis">JavaScript: The Definitive Guid&#101;</span><a name="both as"></a> (O'R&#101;il&#108;y, 2006) is recomm&#101;nd&#101;d both &#97;s a tutorial and as a refe&#114;ence manual. The official ECMAScrip&#116; specifi&#99;ation is ava&#105;lable onl&#105;ne at <a class="docLink" target="_blank" href="http://www.ecmainternational.org/publications/standards/Ecma-262.htm">http://www.ecmainternational.org/publications/standards/Ecma-262.htm</a>.</p>
<p class="docText"><a name="The basic"></a>The ba&#115;ic ECMAScript control structu&#114;es—<tt>if</tt> statements, <tt>for</tt> loops, and <tt>w&#104;ile</tt><a name="as in"></a> loops—are the same as in C++ and Java. ECMASc&#114;ipt also provides more or less the same assignmen&#116;, relatio&#110;a&#108;, and arithm&#101;ti&#99; operators. ECMAScript &#115;trings support concatenati&#111;n with <tt>+</tt><a name="appending with"></a> and appending &#119;ith <tt>+=</tt>.</p>
<p class="docText"><a name="start by"></a>To get a f&#101;el &#102;or the ECMA&#83;cript syntax, w&#101; will start by studying the foll&#111;wing program, which prints a li&#115;t of all the prime numbers less than 1000:</p>
<div class="docText"><pre>const MAX = 1000;
var isPrime = new Array(MAX);

for (var i = 2; i &lt; MAX; ++i)
    isPrime[i] = true;

for (var i = 2; i &lt; MAX; ++i) {
    if (isPrime[i]) {
        for (var j = i; i * j &lt; MAX; ++j)
            isPrime[i * j] = false;
    }
}

for (var i = 2; i &lt; MAX; ++i) {
    if (isPrime[i])
        print(i);
}</pre></div><br />
<p class="docText"><a name="striking feature"></a>From a C++ program&#109;er's perspective, probably the most striking feature of ECMAScrip&#116; is that v&#97;riables a&#114;e not e&#120;p&#108;icitly typed; t&#104;e <tt>var</tt><a name="variables are"></a> keyword &#105;s all that is required to declare a varia&#98;le. Read-onl&#121; va&#114;iables are dec&#108;ared with <tt>cons&#116;</tt> instead of <tt>var</tt><a name="is that"></a>. Another no&#116;eworthy feature of the preceding &#112;rogram is that there is no <tt>main()</tt><a name="from the"></a> function. I&#110;stead, code that is located outside any func&#116;ion is ex&#101;cu&#116;ed immed&#105;ately, s&#116;arting from the &#116;op of the file and workin&#103; down to the bottom.</p>
<p class="docText"><a name="at the"></a>Unlike in C++, semicolo&#110;s &#97;t the end o&#102; statements a&#114;e generally o&#112;tional in ECMAScript. Usin&#103; sophisticated rules, the interprete&#114; can insert most missing <a name="iddle1342"></a><a name="iddle2872"></a><a name="iddle2880"></a><a name="iddle3275"></a><a name="iddle3998"></a><a name="iddle4066"></a><a name="iddle4072"></a><a name="iddle4078"></a><a name="iddle4085"></a><a name="iddle4427"></a><a name="iddle5708"></a><a name="iddle7787"></a><a name="iddle8257"></a><a name="iddle8287"></a><a name="iddle8297"></a><a name="typing semicolons"></a>semicolons itself. D&#101;spite this, typing semicolons ourselves is recommend&#101;d, t&#111; av&#111;id &#117;npleasan&#116; surprises.</p>
<p class="docText"><a name="To run"></a>T&#111; run the abov&#101; program, we can use the <tt>qs&#99;ript</tt><a name="in Qt"></a> interp&#114;eter l&#111;cated in Qt's <tt>&#101;xamples/script/&#113;script</tt><a name="the interpreter"></a> directory. If &#116;he interpreter is called with a file na&#109;e as a command-line argument, the file is taken to be ECMA&#83;cript and is executed; otherwise, an interactive session beg&#105;ns.</p>
<p class="docText"><a name="variable with"></a>If we &#100;o&#110;'t &#112;rov&#105;de an initial va&#108;ue when declaring a variable wi&#116;h <tt>var</tt>, the default value is <tt>undefined</tt>, &#97; special v&#97;lue of typ&#101; <tt>Unde&#102;ined</tt><a name="value of"></a>. W&#101; can later assign a&#110;y value of any type to the variable &#117;sing the assignment operator (<tt>=</tt>). Cons&#105;der the following examples:</p>
<div class="docText"><pre>var x;
typeof x;          // returns "undefined"

x = null;
typeof x;          // returns "null"

x = true;
typeof x;          // returns "boolean"

x = 5;
typeof x;          // returns "number"

x = "Hello";
typeof x;          // returns "string"</pre></div><br />
<p class="docText">The <tt>typeof</tt><a name="type associated"></a> &#111;pe&#114;ator r&#101;tu&#114;ns a lo&#119;ercase string &#114;epresentation of th&#101; data type associated with the v&#97;lue store&#100; i&#110; a variable. EC&#77;AScript defi&#110;es five primitive da&#116;a types: <tt>Undefined</tt>, <tt>N&#117;ll</tt>, <tt>Boolean</tt>, <tt>Number</tt>, and <tt>String</tt>. The <tt>Undefined</tt> a&#110;d <tt>Null</tt> types are special types for the <tt>undefined</tt> and <tt>null</tt> co&#110;s&#116;ants, res&#112;ect&#105;vely. Th&#101; <tt>Boole&#97;n</tt> type consists of two value&#115;, <tt>true</tt> and <tt>false</tt>. The <tt>Number</tt> type stores flo&#97;ting-poin&#116; numbers. &#84;he <tt>String</tt> type &#115;tores Uni&#99;ode strings.</p>
<p class="docText"><a name="to the"></a>Variables can also st&#111;re objects and functions, corre&#115;ponding to the data types <tt>Object</tt> and <tt>Func&#116;ion</tt>. For example:</p>
<div class="docText"><pre>x = new Array(10);
typeof x;          // returns "object"

x = print;
typeof x;          // returns "function"</pre></div><br />
<p class="docText"><a name="data types"></a>Like Java, ECMAScript distinguishes bet&#119;een primiti&#118;e data type&#115; and obj&#101;ct &#116;ypes. Primitive data t&#121;pes behave like C++ value &#116;ypes, such as <tt>int</tt> and <tt>QString</tt><a name="without the"></a>. These ar&#101; cr&#101;at&#101;d without t&#104;e <tt>new</tt><a name="are copied"></a> opera&#116;or and are copied by value. In c&#111;ntrast, object types must be created usin&#103; the <tt>new</tt><a name="and variables"></a> operator, and variables of thes&#101; types store only a reference (a pointer) to the &#111;bj&#101;ct. &#87;hen alloc&#97;ting obje&#99;ts with <tt>new</tt><a name="not need"></a>, we do &#110;ot need to worr&#121; about releasing their memor&#121;, si&#110;c&#101; the ga&#114;bage coll&#101;ctor does this auto&#109;atically.</p>
<p class="docText"><a name="we assign"></a>If we assign a value to a variable without declari&#110;g it first using the <tt>var</tt><a name="if we"></a> keyword, the variable will be c&#114;eated as a global variable. And if we try to read the <a name="iddle2647"></a><a name="iddle2874"></a><a name="iddle6817"></a><a name="iddle7678"></a><a name="iddle7888"></a><a name="iddle8288"></a><a name="we get"></a>valu&#101; of &#97; variable &#116;hat does&#110;'t &#101;xist, we get &#97; <tt>ReferenceError</tt> exc&#101;ption. We can catch the exception usin&#103; a <tt>try ... &#99;atch</tt> statem&#101;nt, as follows:</p>
<div class="docText"><pre>try {
    print(y);
} catch (e) {
    print(e.name + ": " + e.message);
}</pre></div><br />
<p class="docText">&#73;f the variable <tt>y</tt><a name="on the"></a> d&#111;es not exist, the me&#115;sage &quot;ReferenceError: y is &#110;ot defined&quot; is printed on the cons&#111;le.</p>
<p class="docText"><a name="our programs"></a>If undefined variables can cause ha&#118;oc in our pr&#111;gr&#97;ms, so can v&#97;riables t&#104;at are de&#102;ined but that hol&#100; the <tt>undefined</tt><a name="variable using"></a> cons&#116;ant—the d&#101;fa&#117;lt value if no i&#110;itializer &#105;s provided when dec&#108;aring a variable using <tt>var</tt>. To test for <tt>un&#100;efined</tt><a name="the strict"></a>, we can use the st&#114;ict comparison operators <tt>===</tt> or <tt>!==</tt>. For example:</p>
<div class="docText"><pre>var x;
...
var y = 0;
if (x !== undefined)
    y = x;</pre></div><br />
<p class="docText">The fami&#108;iar <tt>==</tt> and <tt>!=</tt><a name="are also"></a> com&#112;ari&#115;on oper&#97;tors are a&#108;so available in ECMASc&#114;ipt, but unlike <tt>===</tt><a name="and"></a> and <tt>!==</tt><a name="return"></a>, &#116;hey sometimes return <tt>true</tt><a name="the compared"></a> when the comp&#97;red value&#115; have di&#102;ferent &#116;ypes. For exa&#109;ple, <tt>24 == "24"</tt> and <tt>null == undefined</tt> return <tt>true</tt>, wher&#101;as <tt>24 === "24"</tt> and <tt>null === undefined</tt> r&#101;turn <tt>false</tt>.</p>
<p class="docText"><a name="illustrates how"></a>We will now review a more complex &#112;rogram that illustrates how to define our &#111;wn &#102;unc&#116;ions in E&#67;MAScript:</p>
<div class="docText"><pre>function square(x)
{
    return x * x;
}

function sumOfSquares(array)
{
    var result = 0;
    for (var i = 0; i &lt; array.length; ++i)
        result += square(array[i]);
    return result;
}

var array = new Array(100);
for (var i = 0; i &lt; array.length; ++i)
    array[i] = (i * 257) % 101;

print(sumOfSquares(array));</pre></div><br />
<p class="docText">&#70;unc&#116;ions are define&#100; using the <tt>function</tt><a name="parameters are"></a> keyword. &#73;n kee&#112;ing &#119;ith ECMAScript's dyn&#97;mic nature, th&#101; parameters are decl&#97;red with no type, and the func&#116;ion has no explicit return type.</p>
<p class="docText"><a name="iddle1211"></a><a name="iddle2311"></a><a name="iddle2875"></a><a name="iddle7887"></a>&#66;y looking at the code, we can guess that <tt>square()</tt> should &#98;e called wi&#116;h a <tt>Numbe&#114;</tt> and th&#97;t <tt>sumOfSq&#117;ares()</tt> should be called &#119;ith an <tt>Array</tt> object, &#98;ut this doesn't have to be the case. For example, <tt>square("7")</tt><a name="numbers in"></a> w&#105;ll retu&#114;n 49, beca&#117;se ECMAScript's m&#117;ltiplication oper&#97;tor will convert strings &#116;o numbers in a numeric context. Similarly, t&#104;e <tt>sumOfSquare()</tt> function will work no&#116; only for <tt>Array</tt><a name="have a"></a> objects but also for other objects that ha&#118;e a similar &#105;nterfa&#99;e.</p>
<p class="docText">In general, &#69;CMAScript a&#112;plies t&#104;e <span class="docEmphasis">duck typing</span><a name="must be"></a> principle: &quot;&#73;f it walks like a duck and quacks like a duck, i&#116; must be a &#100;u&#99;k&quot;. This stands in cont&#114;ast to the stron&#103; typing used by C++ and J&#97;va, where parameter types must be de&#99;lared and arguments must match the declared types.</p>
<p class="docText">In the &#112;receding example, <tt>sumOfSquares()</tt> was hard-coded t&#111; ap&#112;ly <tt>s&#113;uare()</tt><a name="of the"></a> &#111;n e&#97;ch element of the ar&#114;ay. We can make it more &#102;lexible by letting it accept a unary f&#117;nction as &#116;he secon&#100; argumen&#116; and renaming it <tt>sum()</tt>:</p>
<div class="docText"><pre>function sum(array, unaryFunc)
{
    var result = 0;
    for (var i = 0; i &lt; array.length; ++i)
        result += unaryFunc(array[i]);
    return result;
}

var array = new Array(100);
for (var i = 0; i &lt; array.length; ++i)
    array[i] = (i * 257) % 101;

print(sum(array, square));</pre></div><br />
<p class="docText">Th&#101; call <tt>sum(array, square)</tt><a name="to"></a> is equiva&#108;ent to <tt>sumOfSquares(array)</tt><a name="Instead of"></a>. Instead of defin&#105;ng a <tt>square()</tt><a name="also pass"></a> function, we can also pass an a&#110;onymous function to <tt>sum()</tt>:</p>
<div class="docText"><pre>print(sum(array, function(x) { return x * x; }));</pre></div><br />
<p class="docText"><a name="instead of"></a>And instead of d&#101;fi&#110;i&#110;g &#97;n <tt>array</tt> va&#114;iable, we can pass an &#97;rray literal:</p>
<div class="docText"><pre>print(sum([4, 8, 11, 15], function(x) { return x * x; }));</pre></div><br />
<p class="docText"><a name="than there"></a>ECMAScript &#108;ets us supply more arguments to a function than there &#97;re parame&#116;ers decl&#97;red. The extra argum&#101;nts are acc&#101;ssible through the <tt>ar&#103;uments</tt> array. Consider the foll&#111;wing example:</p>
<div class="docText"><pre>function sum(unaryFunc)
{
    var result = 0;
    for (var i = 1; i &lt; arguments.length; ++i)
        result += unaryFunc(arguments[i]);
    return result;
}

print(sum(square, 1, 2, 3, 4, 5, 6));</pre></div><br />
<p class="docText"><a name="page_514"></a>Here, the <tt>sum()</tt><a name="a variable"></a> function is de&#102;ined to take a variable number of arguments. The fir&#115;t argum&#101;nt &#105;s the fu&#110;c&#116;ion that we want to app&#108;y. The other arguments are the num&#98;ers that we want to sum. When iterating ove&#114; the <tt>ar&#103;umen&#116;s</tt><a name="it corresponds"></a> array, we mu&#115;t skip the item &#97;t index position 0 because it corr&#101;sponds to <tt>unaryFunc</tt>, &#116;he unary function. We could also omit the <tt>unaryFunc</tt><a name="it from"></a> pa&#114;ameter from the parameter list and extract it &#102;rom &#116;he <tt>argum&#101;nt&#115;</tt> array:</p>
<div class="docText"><pre>function sum()
{
    var unaryFunc = arguments[0];
    var result = 0;
    for (var i = 1; i &lt; arguments.length; ++i)
        result += unaryFunc(arguments[i]);
    return result;
}</pre></div><br />
<p class="docText">T&#104;e <tt>arguments</tt><a name="based on"></a> array c&#97;n be used to overl&#111;ad the behavior of functions bas&#101;d o&#110; t&#104;e types of the a&#114;guments or on th&#101;ir number. For example, s&#117;ppose that we want to let <tt>sum()</tt><a name="unary argument"></a> take an optiona&#108; unary argument followed by a list of numbers, allowi&#110;g us to invoke it as follows:</p>
<div class="docText"><pre>print(sum(1, 2, 3, 4, 5, 6));
print(sum(square, 1, 2, 3, 4, 5, 6));</pre></div><br />
<p class="docText"><a name="can implement"></a>Here's how we can impleme&#110;t <tt>&#115;um()</tt><a name="to support"></a> to su&#112;por&#116; this:</p>
<div class="docText"><pre>function sum()
{
    var unaryFunc = function(x) { return x; };
    var i = 0;

    if (typeof arguments[0] == "function") {
        unaryFunc = arguments[0];
        i = 1;
    }

    var result = 0;
    while (i &lt; arguments.length)
        result += unaryFunc(arguments[i++]);
    return result;
}</pre></div><br />
<p class="docText"><a name="supply a"></a>If w&#101; supply &#97; function as the first argumen&#116;, that function is applied to each number before &#105;t is add&#101;d t&#111; the su&#109;; otherwise, we us&#101; the identity func&#116;ion <tt>function(x) { return x; }</tt>.</p>
<p class="docText"><a name="arguably the"></a>For C++ programmers, arguabl&#121; the most difficult aspect of ECMAScript &#105;s its object model. ECMAScript is an <span class="docEmphasis">object-based</span><a name="of a"></a> object-oriente&#100; l&#97;nguage, se&#116;ting it a&#112;art &#102;rom C++, C#, Java, Sim&#117;la, and Smalltalk, which are al&#108; class-based. Instead of a class concep&#116;, ECMAScr&#105;pt prov&#105;des us with lowe&#114;-level mechanisms t&#104;at let us achieve the same resu&#108;ts.</p>
<p class="docText"><a name="iddle1791"></a><a name="iddle3247"></a><a name="iddle4093"></a><a name="iddle4539"></a><a name="iddle8034"></a><a name="iddle8258"></a><a name="iddle8399"></a><a name="us implement"></a>The first mechanism that lets us impleme&#110;t classes in ECMAScript is that of a constructor. A <span class="docEmphasis">cons&#116;ructor</span> is a function that can be invoked using the <tt>ne&#119;</tt> operator. Fo&#114; examp&#108;e, here is a c&#111;ns&#116;ructor for a <tt>&#83;hape</tt> object:</p>
<div class="docText"><pre>function Shape(x, y) {
    this.x = x;
    this.y = y;
}</pre></div><br />
<p class="docText">&#84;he <tt>Shape</tt> constructor has two para&#109;eters and in&#105;tializ&#101;s the new o&#98;ject's <tt>x</tt> and <tt>y</tt> pr&#111;perties (member v&#97;riables) based on the values passed to th&#101; constructor. The <tt>this</tt><a name="is essentially"></a> keyword refers &#116;o the object being created. In ECMAScript, an object i&#115; essent&#105;ally a c&#111;ll&#101;ct&#105;on of prope&#114;ties; properties can b&#101; added, removed, or modif&#105;ed at an&#121; ti&#109;e. A property is creat&#101;d the firs&#116; time it is set, so when we assign to <tt>&#116;his.x</tt> and <tt>this.y</tt> in the constructor, the <tt>x</tt> and <tt>&#121;</tt> properties are created as a result.</p>
<p class="docText"><a name="is to"></a>A co&#109;mon mistake for C++ and Java developers is to forget the <tt>this</tt><a name="been unlikely"></a> keyw&#111;rd &#119;hen accessi&#110;g &#111;bj&#101;ct prop&#101;rties. In the pr&#101;ceding example, this wou&#108;d have been &#117;nlikely, b&#101;cause a state&#109;ent such as <tt>x = x</tt><a name="very suspicious"></a> w&#111;uld have looked very suspic&#105;ous, but in other examples this would have le&#100; to the creation of spurious glo&#98;al variables.</p>
<p class="docText"><a name="a"></a>To instantiate a <tt>Shape</tt><a name="we use"></a> object, &#119;e use the <tt>new</tt> &#111;pe&#114;ator a&#115; follow&#115;:</p>
<div class="docText"><pre>var shape = new Shape(10, 20);</pre></div><br />
<p class="docText"><a name="use the"></a>If we use th&#101; <tt>typeof</tt><a name="on the"></a> ope&#114;ator on the <tt>shape</tt> variable, &#119;e obtain <tt>Obj&#101;ct</tt>, &#110;ot <tt>Shape</tt><a name="an object"></a>, as &#116;he data type. &#73;f we want to determine whether &#97;n object has been created using the <tt>Shape</tt> constructor, &#119;e can use the <tt>instanceof</tt> operator:</p>
<div class="docText"><pre>var array = new Array(100);
array instanceof Shape;            // returns false

var shape = new Shape(10, 20);
shape instanceof Shape;            // returns true</pre></div><br />
<p class="docText"><a name="as a"></a>ECMAScript &#108;ets any function serve as a constructor. However, if the func&#116;ion does&#110;'t &#112;erf&#111;rm &#97;ny modifications to th&#101; <tt>this</tt><a name="a constructor"></a> object, it doesn'&#116; make much sense to invoke it as a cons&#116;ructor. C&#111;nv&#101;rsely, &#97; constructor can be &#105;nvoked as a plain function, but again th&#105;s rarely makes sense.</p>
<p class="docText"><a name="provides built"></a>In add&#105;tion to the primitive data types, ECMAScript prov&#105;des built-in constructors that let us instantiate fundament&#97;l object t&#121;pe&#115;, notabl&#121; <tt>Ar&#114;ay</tt>, <tt>Date</tt>, an&#100; <tt>RegExp</tt><a name="create objects"></a>. &#79;ther constructors correspond to th&#101; pr&#105;mitive &#100;ata types, a&#108;lowing us to cr&#101;ate objects that store pr&#105;mitive values. The <tt>valueOf()</tt><a name="us retrieve"></a> member function l&#101;ts us retrieve the primitive value store&#100; in the object. For example:</p>
<div class="docText"><pre>var boolObj = new Boolean(true);
typeof boolObj;                    // returns "object"

var boolVal = boolObj.valueOf();
typeof boolVal;                    // returns "boolean"</pre></div><br />
<p class="docText"><a name="iddle4556"></a><a name="iddle7412"></a><a class="docLink" href="#ch22fig01">Figure 22.1</a><a name="global constants"></a> lists the built-in glo&#98;al constan&#116;s, functi&#111;ns, &#97;nd object&#115; provided b&#121; ECMAScript. In t&#104;e next section, we will see how to supplement &#116;his buil&#116;-in funct&#105;onality wi&#116;h additiona&#108;, application-specific c&#111;mponents written i&#110; C++.</p>
<a name="ch22fig01"></a><p><center>

<h5 class="docFigureTitle"><a name="Figure "></a>Figure 22.1. Built-in properties of th&#101; global object</h5>
<p><table cellspacing="0" class="allBorders" border="1"><colgroup align="left" span="2"><col width="200" /><col width="350" /></colgroup><thead></thead><tr><td class="docTableCell" align="left" valign="top" colspan="2" style="background-color:#E6E6E6"><span class="docEmphRomanAlt">Constants</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>NaN</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">IEEE 754 Not-a-Number (NaN) value</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Infi&#110;i&#116;y</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Positi&#118;e infinity (+</span><img alt="" src="images/U221E.GIF"/><span class="docEmphRomanAlt">)</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>&#117;ndefined</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt"><a name="for uninitialized"></a>&#68;efault value for unin&#105;tialized variables</span></td></tr></table></p><br />
<p><table cellspacing="0" class="allBorders" border="1"><colgroup align="left" span="2"><col width="200" /><col width="350" /></colgroup><thead></thead><tr><td class="docTableCell" align="left" valign="top" colspan="2" style="background-color:#E6E6E6"><span class="docEmphRomanAlt">F&#117;nctions</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>print(x)</tt><sup class="docFootnote"><a class="docLink" href="#ch22tn01">[*]</a></sup></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt"><a name="a value"></a>Prints a value on the console</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>eval(&#115;tr)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Exec&#117;tes an ECM&#65;Script prog&#114;am</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>parseInt(st&#114;, base)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Converts a strin&#103; to an integer value</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>parseFloat(&#115;tr)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Converts a string to a floating-point &#118;alue</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>isNaN(n)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Returns</span> <tt>true</tt> <span class="docEmphRomanAlt">if</span> <tt>n</tt> <span class="docEmphRomanAlt">is NaN</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>isF&#105;nite(n)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">R&#101;tu&#114;ns</span> <tt>tru&#101;</tt> <span class="docEmphRomanAlt">if</span> <tt>&#110;</tt> <span class="docEmphRomanAlt">is a numbe&#114; other than NaN, +</span><img alt="" src="images/U221E.GIF"/>, <span class="docEmphRomanAlt">or -</span><img alt="" src="images/U221E.GIF"/></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>decod&#101;URI(str)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Converts an 8-bit-e&#110;c&#111;de&#100; URI to &#85;nicode</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>de&#99;odeURIComponent(str)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Conv&#101;rts an 8-bit-encoded U&#82;I component to Unicode</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>encodeURI(str)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Convert&#115; a Unicode URI to an 8-bit-encoded URI</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>encodeURIComp&#111;ne&#110;t(&#115;tr)</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Conv&#101;rt&#115; a Unicode &#85;RI component &#116;o 8-bit-encoded</span></td></tr></table></p><br /><blockquote><p class="docFootnote"><sup><a name="ch22tn01">[*]</a></sup> Not speci&#102;ied &#98;y the ECMAS&#99;ript standard.</p></blockquote>
<p><table cellspacing="0" class="allBorders" border="1"><colgroup align="left" span="2"><col width="200" /><col width="350" /></colgroup><thead></thead><tr><td class="docTableCell" align="left" valign="top" colspan="2" style="background-color:#E6E6E6"><span class="docEmphRomanAlt">Clas&#115;es (Constructors)</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>&#79;bject</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Provides functiona&#108;ity common to all objects</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Function</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">E&#110;capsulates an ECMAScript function</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Array</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Re&#112;resents a resizable vector of items</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>String</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Stores a Un&#105;code st&#114;ing</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Bo&#111;le&#97;n</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Stores a &#66;oolean value (</span><tt>true</tt> <span class="docEmphRomanAlt">o&#114;</span> <tt>false</tt><span class="docEmphRomanAlt">)</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Number</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Stores a &#102;loating-point number</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Date</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Stores a date and t&#105;me</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>RegE&#120;p</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">&#80;rovi&#100;es regula&#114; expression pattern matching</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Error</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">B&#97;se type for error types</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>EvalError</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Raised w&#104;en using</span> <tt>eval()</tt> <span class="docEmphRomanAlt">wrongly</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>RangeEr&#114;or</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Raised when a numeric value is outside the legal range</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Refe&#114;enceE&#114;ror</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Ra&#105;sed whe&#110; t&#114;ying to ac&#99;ess an undefined variable</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Sy&#110;taxError</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Raised when a syntax e&#114;ror is &#100;e&#116;ected by</span> <tt>eva&#108;()</tt></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>TypeError</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Rais&#101;d when an argument has the w&#114;ong type</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>URIError</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Raised w&#104;en URI parsing fails</span></td></tr></table></p><br />
<p><table cellspacing="0" class="allBorders" border="1"><colgroup align="left" span="2"><col width="200" /><col width="350" /></colgroup><thead></thead><tr><td class="docTableCell" align="left" valign="top" colspan="2" style="background-color:#E6E6E6"><span class="docEmphRomanAlt">Object</span></td></tr><tr><td class="docTableCell" align="left" valign="top"><tt>Math</tt></td><td class="docTableCell" align="left" valign="top"><span class="docEmphRomanAlt">Provide&#115; mathematical constants and functions</span></td></tr></table></p><br />
</center></p><br />
<p class="docText"><a name="ECMAScript and"></a>We have seen ho&#119; to define a c&#111;ns&#116;ructor i&#110; E&#67;MAScript and how to a&#100;d member variables to the c&#111;nstructed object. Normally, we also want to defi&#110;e &#109;ember funct&#105;ons. Because funct&#105;ons are treated a&#115; first-class citizens in ECMAS&#99;ript, this turns out to be surprisingly easy. Here'&#115; a new version of the <tt>Shape</tt> constructor, this time &#119;ith two member functions, <tt>manhattanPos()</tt> and <tt>translat&#101;()</tt>:</p>
<div class="docText"><pre>function Shape(x, y) {
    this.x = x;
    this.y = y;

    this.manhattanPos = function() {
        return Math.abs(this.x) + Math.abs(this.y);
    };
    this.translate = function(dx, dy) {
        this.x += dx;
        this.y += dy;
    };
}</pre></div><br />
<p class="docText"><a name="member functions"></a>We &#99;an then invo&#107;e the memb&#101;r f&#117;nctions using the <tt>.</tt> (&#100;ot) operator:</p>
<div class="docText"><pre>var shape = new Shape(10, 20);
shape.translate(100, 100);
print(shape.x + ", " + shape.y + " (" + shape.manhattanPos() + ")");</pre></div><br />
<p class="docText">With t&#104;is approach, each <tt>Shape</tt> instance has &#105;ts own <tt>m&#97;nhattanP&#111;s</tt> and <tt>&#116;ranslate</tt> pr&#111;perties. Since these prope&#114;ties should be identical for &#97;ll <tt>Shape</tt><a name="than in"></a> instances, it is desirable to store them &#111;nly once rather than in every instance. ECMAScrip&#116; lets us a&#99;hieve this b&#121; us&#105;ng a pro&#116;otype. A <span class="docEmphasis">prototy&#112;e</span><a name="fallback for"></a> is an object that ser&#118;es as a fallback for other objects, providing an &#105;nitial &#115;et of pr&#111;perties. O&#110;e advantage &#111;f this approach is that it &#105;s possible to change the proto&#116;ype object at any time and the changes are imme&#100;iately reflected in all objects that wer&#101; cr&#101;at&#101;d w&#105;th that &#112;rototy&#112;e.</p>
<p class="docText">Consider the &#102;ollowing example:</p>
<div class="docText"><pre>function Shape(x, y) {
    this.x = x;
    this.y = y;
}

Shape.prototype.manhattanPos = function() {
    return Math.abs(this.x) + Math.abs(this.y);
};

Shape.prototype.translate = function(dx, dy) {
    this.x += dx;
    this.y += dy;
};</pre></div><br />
<p class="docText"><a name="iddle1217"></a><a name="iddle1220"></a><a name="iddle1343"></a><a name="iddle2035"></a><a name="iddle2047"></a><a name="iddle2048"></a><a name="iddle2382"></a><a name="iddle2383"></a><a name="iddle2449"></a><a name="iddle2472"></a><a name="iddle2473"></a><a name="iddle2873"></a><a name="iddle2924"></a><a name="iddle3208"></a><a name="iddle3323"></a><a name="iddle3328"></a><a name="iddle3768"></a><a name="iddle3974"></a><a name="iddle4073"></a><a name="iddle4079"></a><a name="iddle4271"></a><a name="iddle4272"></a><a name="iddle4429"></a><a name="iddle6743"></a><a name="iddle6818"></a><a name="iddle6823"></a><a name="iddle6832"></a><a name="iddle7788"></a><a name="iddle7904"></a><a name="iddle8255"></a><a name="iddle8289"></a><a name="iddle8352"></a><a name="iddle1466"></a><a name="iddle1567"></a><a name="iddle4385"></a><a name="iddle7413"></a><a name="iddle7821"></a>In this v&#101;rs&#105;on of <tt>Sh&#97;pe</tt>, we create the <tt>man&#104;attanPo&#115;</tt> and <tt>translate</tt> properties outs&#105;de the constructor, as properties of th&#101; <tt>Shape.prototype</tt> object. When we ins&#116;antiate a <tt>Shape</tt>, the newly created object keeps an internal pointer ba&#99;k to <tt>Shape.pr&#111;to&#116;ype</tt><a name="in our"></a>. When&#101;ve&#114; we retrieve t&#104;e value of a property &#116;hat doesn't exist in our <tt>Shape</tt><a name="looked up"></a> &#111;bj&#101;ct, &#116;he property is l&#111;oked u&#112; in the prototype as &#97; fallback. Thus, the <tt>Shape</tt><a name="the ideal"></a> prototype &#105;s the ideal place to put memb&#101;r functions, which should be shared by all <tt>&#83;hape</tt> &#105;nstanc&#101;s.</p>
<p class="docText"><a name="It might"></a>I&#116; might be &#116;empting to put all &#115;orts of propert&#105;es that we want to share between <tt>Shape</tt><a name="the prototype"></a> &#105;nstanc&#101;s i&#110; the prot&#111;type, si&#109;ilar to C++'s static member variables or Java'&#115; class variables. This idiom work&#115; for read-only properties (i&#110;cluding member functions) because the prototype ac&#116;s as a fal&#108;back when w&#101; re&#116;rieve th&#101; value of a prop&#101;rty. However, it does&#110;'t work as expected when we try to &#97;ssign a ne&#119; value to the &#115;hared variable; in&#115;tead, a fresh va&#114;iable is created directly &#105;n the <tt>Shape</tt><a name="any property"></a> object, shadowing any proper&#116;y of the same name in the prototype. This asymmetry between rea&#100; and write access to a variable is a frequent source of &#99;onfusion fo&#114; novic&#101; EC&#77;AScript p&#114;ogrammers.</p>
<p class="docText"><a name="inheritance to"></a>In class-&#98;ased languages such as C++ and Ja&#118;a, we can use class inheritance to create speci&#97;lized obj&#101;ct &#116;ypes. For exa&#109;ple, we would de&#102;ine a <tt>Shape</tt> class and then d&#101;rive <tt>Triangle</tt>, <tt>Square</tt>, and <tt>C&#105;rcle</tt> from <tt>Shape</tt><a name="be achieved"></a>. In ECMAScript, a similar eff&#101;ct can be achieved using prototypes. The followi&#110;g &#101;xa&#109;ple shows ho&#119; to define <tt>Ci&#114;cle</tt> objects tha&#116; are also <tt>Shape</tt> instanc&#101;s:</p>
<div class="docText"><pre>function Shape(x, y) {
    this.x = x;
    this.y = y;
}

Shape.prototype.area = function() { return 0; };

function Circle(x, y, radius) {
    Shape.call(this, x, y);
    this.radius = radius;
}

Circle.prototype = new Shape;
Circle.prototype.area = function() {
    return Math.PI * this.radius * this.radius;
};</pre></div><br />
<p class="docText">We start by defining &#97; <tt>Shape</tt> con&#115;tructo&#114; and associate &#97;n <tt>area()</tt> function with it, &#119;hich always returns 0. Then we de&#102;ine a <tt>Circle</tt> constructor, which ca&#108;ls the &quot;base class&quot; constructor using the <tt>call()</tt><a name="a"></a> function d&#101;fined for all function object&#115; (includ&#105;ng cons&#116;ructors), &#97;nd we add a <tt>&#114;adius</tt> prop&#101;rty. Outside the &#99;onstructor, we set the <tt>Circle</tt>'s prototype to be a <tt>Shape</tt> ob&#106;ect, and w&#101; ov&#101;rride <tt>Shap&#101;</tt>'s <tt>area()</tt> fun&#99;tion with a <tt>Circle</tt>-specific i&#109;plementation. This corresponds &#116;o the following C++ code:</p>
<div class="docText"><div class="codeSegmentsExpansionLinks">
              Code View:</div><pre class="">class Shape
{
public:
    Shape(double x, double y) {
        this-&gt;x = x;
        this-&gt;y = y;
    }

    virtual double area() const { return 0; }

    double x;
    double y;
};

class Circle : public Shape
{
public:
    Circle(double x, double y, double radius)
        : Shape(x, y)
    {
        this-&gt;radius = radius;
    }

    double area() const { return M_PI * radius * radius; }

    double radius;
};

					  </pre></div><br />
<p class="docText"><a name="iddle3248"></a><a name="iddle6159"></a>The <tt>instanceof</tt><a name="determine which"></a> ope&#114;ator walks through the prototype chain to dete&#114;mine w&#104;ich co&#110;s&#116;ructors &#104;ave been i&#110;voked. A&#115; a consequence, instances of a &#115;ubclas&#115; are als&#111; cons&#105;dered to be &#105;nstances of the base class:</p>
<div class="docText"><pre>var circle = new Circle(0, 0, 50);
circle instanceof Circle;          // returns true
circle instanceof Shape;           // returns true
circle instanceof Object;          // returns true
circle instanceof Array;           // returns false</pre></div><br />
<p class="docText"><a name="will show"></a>T&#104;is concludes our short introduction to ECMA&#83;cript. In the following sections, we will show how to u&#115;e this language in conjunction with C++/Qt applications to provide more &#102;lex&#105;bility &#97;nd custom&#105;zabili&#116;y to end-users or s&#105;mply to speed up the devel&#111;pment process.</p>

</div></div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch21lev1sec3.html><img src="images/prev.gif" width="20" height="20" border="0" align="absmiddle" alt="Previous Page"></a>
<a href=ch22lev1sec1.html><img src="images/next.gif" width="20" height="20" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>