<html>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
<title>ch24.html</title>
<link rel="STYLESHEET" type="text/css" href="images/css1.css">
<link rel="STYLESHEET" type="text/css" href="images/css2.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch23lev1sec3.html><img src="images/prev.gif" width="20" height="20" border="0" align="absmiddle" alt="Previous Page"></a>
<a href=ch24lev1sec1.html><img src="images/next.gif" width="20" height="20" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<div style=""><div><a name="ch24"></a>

<h2 id="title-ID0EGMPM" class="docChapterTitle">24. Embedded Programming</h2>



<p class="docText">
<img border="0" id="" width="128" height="126" src="images/NzlkOW1jM2FhMDc4L2lwdHJnZTFnMTRzOXIvMy83ZXBwdDRocF9lcl8vMmlzY2Nob25lYS5wZ3Jq.jpg" alt="" /></p>



<ul><li><p class="docList"><a name="iddle1216"></a><a name="iddle1808"></a><a name="iddle2368"></a><a name="iddle2850"></a><a name="iddle3187"></a><a name="iddle3252"></a><a name="iddle3385"></a><a name="iddle3573"></a><a name="iddle3848"></a><a name="iddle3854"></a><a name="iddle3891"></a><a name="iddle4290"></a><a name="iddle4304"></a><a name="iddle4400"></a><a name="iddle6132"></a><a name="iddle6379"></a><a name="iddle6382"></a><a name="iddle6383"></a><a name="iddle6385"></a><a name="iddle6668"></a><a name="iddle7419"></a><a name="iddle7795"></a><a name="iddle8460"></a><a name="iddle8641"></a><span class="docEmphasis"><a class="docLink" href="ch24lev1sec1.html#ch24lev1sec1">Getting Started with Qt/Embedded Linux</a></span></p></li><li><p class="docList"><span class="docEmphasis"><a class="docLink" href="ch24lev1sec2.html#ch24lev1sec2">Customizing Qt/Embedded Linux</a></span></p></li><li><p class="docList"><span class="docEmphasis"><a class="docLink" href="ch24lev1sec3.html#ch24lev1sec3">Integrating Qt Applications with Qtopia</a></span></p></li><li><p class="docList"><span class="docEmphasis"><a class="docLink" href="ch24lev1sec4.html#ch24lev1sec4">Using Qtopia APIs</a></span></p></li></ul>
<p class="docText"><a name="Developing software"></a>&#68;eveloping &#115;oftwar&#101; to &#114;un on m&#111;bile devices s&#117;ch as PDAs and mobile phon&#101;s can be very challenging beca&#117;se embedd&#101;d s&#121;stems &#103;enerally have s&#108;ower processors, less permane&#110;t storage (flash memory or &#104;ard disk), less memory, and smaller displays than de&#115;ktop computers.</p>
<p class="docText"><a name="Qtopia Core"></a>Qt/Embedded Linux (also called Qtopia Core) is &#97;n edition &#111;f Q&#116; optimiz&#101;d f&#111;r embedded Linu&#120;. Qt/Embedded L&#105;nux provides the same API and tools as the desktop versi&#111;ns &#111;f Q&#116; (Qt/Windows, Qt/X11, and Qt/M&#97;c), and adds the class&#101;s and tools necess&#97;ry for embedded programming. Through &#100;ual licensing, it is available for b&#111;th open source and commercial development.</p>
<p class="docText"><a name="can run"></a>Qt/Embed&#100;e&#100; L&#105;nux can &#114;un on a&#110;y hardwa&#114;e that runs Linu&#120;—including Intel x86, MIPS, ARM, StrongARM, &#77;otorola/F&#114;eesca&#108;e 68000, and PowerPC &#97;rchitectures.<sup class="docFootnote"><a class="docLink" href="#ch24fn01">[*]</a></sup><a name="implements its"></a> Unlik&#101; Qt/X11, it does not need t&#104;e X Window System; instead, it imple&#109;ents its own window system, QWS, enabling significant storage &#97;nd memory savings. To reduce its memory footprint even mor&#101;, Qt/&#69;mbedded Lin&#117;x can be re&#99;ompiled to e&#120;clude unused &#102;eatures. If the applicati&#111;ns and components used on a device ar&#101; kn&#111;wn &#105;n advance, they can be &#99;ompiled togeth&#101;r into a single ex&#101;cutable that links statically agains&#116; the Qt/Embedded Linux libraries.</p><blockquote><p class="docFootnote"><sup><a name="ch24fn01">[*]</a></sup><a name="expected to"></a> Starting &#119;ith version 4.4, Qt is expected to run on W&#105;ndows C&#69; as well.</p></blockquote>
<p class="docText"><a name="part of"></a>Qt/Em&#98;edded Linu&#120; a&#108;so benefits from va&#114;ious features that a&#114;e also part of the desktop versi&#111;ns &#111;f Q&#116;, including &#116;he extensive use &#111;f implicit data sharing (&quot;copy on write&quot;) &#97;s a memory-saving technique, su&#112;port for custom widget styles throug&#104; <tt>QStyle</tt><a name="make the"></a>, and a layout system that adapts t&#111; ma&#107;e the best &#117;se of the a&#118;ailable sc&#114;een space.</p>
<p class="docText"><a name="Qtopia PDA"></a>Qt/Embe&#100;ded Linux for&#109;s the basis of Trolltech's embedded o&#102;fer&#105;ng, whic&#104; also inc&#108;udes Qtopia Platform, &#81;topia PDA, and Qtopia Phone. The&#115;e provide classes and applications desi&#103;ned specifically for portable devices a&#110;d can be integrated with several third-party Ja&#118;a virtual m&#97;chines.</p>




<a name="ch24lev1sec1"></a>

<h3 class="docSection1Title" id="-100000">Getting Started with Qt/Embedded Linux</h3>
<p class="docText"><a name="iddle1740"></a><a name="iddle1923"></a><a name="iddle2369"></a><a name="iddle2846"></a><a name="iddle2885"></a><a name="iddle2929"></a><a name="iddle6175"></a><a name="iddle6475"></a><a name="iddle8439"></a><a name="iddle8454"></a><a name="iddle8727"></a><a name="be developed"></a>Qt/&#69;mbedded Lin&#117;x applica&#116;ions can be develope&#100; on any &#112;latform equipped with an appr&#111;pr&#105;ate too&#108; chain. The most &#99;ommon option i&#115; to build a GNU C++ cross-com&#112;iler on a Unix system. This process is simp&#108;ified by a script and a set of patches provided b&#121; Dan Kegel at <a class="docLink" target="_blank" href="http://kegel.com/crosstool/">http://kegel.com/crosstool/</a><a name="we have"></a>. For this chapter, we have used the Qtopia Ope&#110; S&#111;ur&#99;e Edition ve&#114;sion 4.2 a&#118;ailable from <a class="docLink" target="_blank" href="http://www.trolltech.com/products/qtopia/opensource/">http://www.trolltech.com/products/qtopia/opensource/</a><a name="This edition"></a>. T&#104;is edition is suitable o&#110;ly for Linux and includes i&#116;s own cop&#121; of &#81;t/Embedded Linu&#120; 4.2, along with ad&#100;itional tools to suppor&#116; Qtopia programming on a desktop PC.</p>
<p class="docText"><a name="supports cross"></a>Qt/Embedded Linu&#120;'s configuration system supports cr&#111;ss-compiling, through the <tt>configure</tt> script's <tt>-embedded</tt> and <tt>-x&#112;lat&#102;orm</tt><a name="to build"></a> &#111;pt&#105;ons. For &#101;xample, to build &#102;or the ARM archite&#99;ture we would type</p>
<div class="docText"><pre>./configure -embedded arm -xplatform qws/linux-arm-g++</pre></div><br />
<p class="docText"><a name="to Qt"></a>We can create custom &#99;onfigurati&#111;ns &#98;y adding new files to Qt's <tt>&#109;kspecs/qws</tt> director&#121;.</p>
<p class="docText"><a name="Linux framebuffer"></a>Qt/Embedded Linux draws directly &#116;o the Linux framebuffer (the memory ar&#101;a associated with the video display). &#84;he virtual framebuffer shown in <a class="docLink" href="#ch24fig01">Figure 24.1</a><a name="access the"></a> is an X11 applic&#97;tion that &#115;imulat&#101;s, p&#105;xel for &#112;ixel, the actual &#102;ramebuffer. &#84;o access the framebuffer, you might need to &#103;rant &#119;rite permis&#115;ions to the <tt>/dev/fb0</tt> &#100;evice.</p>
<a name="ch24fig01"></a><p><center>

<h5 class="docFigureTitle">Figure 24.1. &#81;t/Embedded Linux running in a &#118;irtual framebuffer</h5>

<p class="docText">
<img border="0" id="" width="334" height="491" src="images/NzlkOW1jM2FhMDc4L2lwdHJnZTFnMTRzOXIvMy83cC50aG9wZ2ovaXNxcGNpYTE-.jpg" alt="" /></p>



</center></p><br />
<p class="docText"><a name="iddle1613"></a><a name="iddle1701"></a><a name="iddle2171"></a><a name="iddle2296"></a><a name="iddle2298"></a><a name="iddle2442"></a><a name="iddle2444"></a><a name="iddle2964"></a><a name="iddle3427"></a><a name="iddle3901"></a><a name="iddle4509"></a><a name="iddle4713"></a><a name="iddle4848"></a><a name="iddle4850"></a><a name="iddle4888"></a><a name="iddle6133"></a><a name="iddle6176"></a><a name="iddle6476"></a><a name="iddle6477"></a><a name="iddle6674"></a><a name="iddle6678"></a><a name="iddle6682"></a><a name="iddle6801"></a><a name="iddle7094"></a><a name="iddle7112"></a><a name="iddle8455"></a><a name="iddle8477"></a><a name="one process"></a>To run Qt/Embedded L&#105;nux applications, we must first start one pr&#111;cess to act as a GUI server. The server is responsible fo&#114; alloc&#97;ting scre&#101;n r&#101;gi&#111;ns to client&#115; and for generating mous&#101; and keyboard e&#118;ents. Any Qt/&#69;mbedded Lin&#117;x application can b&#101;come a server by &#115;pecifying <tt>-qws</tt> on its comman&#100; line or by passing <tt>QApplication::Gu&#105;Server</tt> as the third parameter to the <tt>QA&#112;plication</tt> constructor.</p>
<p class="docText"><a name="and Unix"></a>Client applications communicate wi&#116;h the Qt/E&#109;bedded Linu&#120; s&#101;rv&#101;r using sha&#114;ed memory and Unix pi&#112;es. Behind the scenes, the cli&#101;nt&#115; draw th&#101;mselv&#101;s int&#111; the Linux f&#114;amebuffer and are responsible for &#112;ainting their own window deco&#114;ations.</p>
<p class="docText"><a name="with each"></a>Clients can communicate with each other using QCOP—&#116;he Qt Com&#109;unication P&#114;otoco&#108;. A client ca&#110; listen on &#97; named channel b&#121; creating a <tt>QCopChann&#101;l</tt><a name="connecting to"></a> o&#98;ject and co&#110;nect&#105;ng to its <tt>receiv&#101;d()</tt><a name="For example"></a> signal. For example:</p>
<div class="docText"><pre>QCopChannel *channel = new QCopChannel("System", this);
connect(channel, SIGNAL(received(const QString &amp;, const QByteArray &amp;)),
        this, SLOT(received(const QString &amp;, const QByteArray &amp;)));</pre></div><br />
<p class="docText"><a name="message consists"></a>A QCOP mes&#115;age consists of a name and an optio&#110;al <tt>QByteArray</tt><a name="static"></a>. The static <tt>QCopChannel::&#115;end()</tt> function broadcasts a message on a channel. For e&#120;a&#109;ple:</p>
<div class="docText"><pre>QByteArray data;
QDataStream out(&amp;data, QIODevice::WriteOnly);
out &lt;&lt; QDateTime::currentDateTime();

QCopChannel::send("System", "clockSkew(QDateTime)", data);</pre></div><br />
<p class="docText"><a name="data using"></a>The prec&#101;di&#110;g &#101;xample illustr&#97;tes a common idi&#111;m: We encode the data using <tt>QDataStream</tt><a name="format in"></a>, an&#100; w&#101; ma&#110;gle the data f&#111;rmat in the me&#115;sage name as though it were a C++ function to &#101;nsure that receiver interprets the <tt>QBy&#116;eArray</tt> correctly.</p>
<p class="docText"><a name="are"></a>Various environmen&#116; variables affect Qt/Embedded Linux app&#108;ications. T&#104;e most &#105;mporta&#110;t &#111;nes are <tt>QWS_&#77;OUSE_PROTO</tt> and <tt>QWS_KEYBOARD</tt><a name="keyboard type"></a>, which sp&#101;cify the mouse device and the key&#98;oard type. S&#101;e <a class="docLink" target="_blank" href="http://doc.trolltech.com/4.2/qtopiacore-envvars.html">http://doc.trolltech.com/4.2/qtopiacore-envvars.html</a> f&#111;r a complete lis&#116; of environm&#101;nt variables.</p>
<p class="docText"><a name="the application"></a>If we use Unix a&#115; our development platform, we can test t&#104;e application using the Qt virtual framebu&#102;fer (<tt>qvfb</tt><a name="simulates the"></a>), an X11 application that simulates the &#97;ctual fra&#109;ebuffer. Thi&#115; accele&#114;ates t&#104;e development cyc&#108;e considerably. To enable virtual &#98;uffer support in Qt/Embedded L&#105;nux, pas&#115; the <tt>-qvf&#98;</tt><a name="the"></a> option to the <tt>conf&#105;gure</tt><a name="Be aware"></a> script. Be &#97;ware that this option is not int&#101;nded for production use. T&#104;e virtual framebuffer application is located i&#110; <tt>tools/qvfb</tt><a name="be invoked"></a> and can be invoked as follow&#115;:</p>
<div class="docText"><pre>qvfb -width 320 -height 480 -depth 32</pre></div><br />
<p class="docText"><a name="alternative to"></a>An alte&#114;nativ&#101; to &#117;sing the X11-&#115;pecific virtual fra&#109;ebuffer is to use VN&#67; (Virtual Network Computing) to run the &#97;pplicati&#111;ns &#114;emotely. To enable &#86;NC support in Qt/&#69;mbedded Linux, pass the <tt>-qt-gfx-vnc</tt> option t&#111; <tt>configure</tt>. Then launch your &#81;t/Embedded Linux applications with the <tt>-displ&#97;y VNC:0</tt><a name="host on"></a> command-line option and run a VNC client pointing at th&#101; ho&#115;t on whi&#99;h your appli&#99;ations <a name="iddle1702"></a><a name="iddle2049"></a><a name="iddle2172"></a><a name="iddle2297"></a><a name="iddle2299"></a><a name="iddle2301"></a><a name="iddle2441"></a><a name="iddle2446"></a><a name="iddle3227"></a><a name="iddle3428"></a><a name="iddle3902"></a><a name="iddle4844"></a><a name="iddle4912"></a><a name="iddle4914"></a><a name="iddle5247"></a><a name="iddle5409"></a><a name="iddle5688"></a><a name="iddle5690"></a><a name="iddle6149"></a><a name="iddle6669"></a><a name="iddle6670"></a><a name="iddle6673"></a><a name="iddle6677"></a><a name="iddle6681"></a><a name="iddle6685"></a><a name="iddle7044"></a><a name="iddle8630"></a><a name="bit depth"></a>are r&#117;nning. The di&#115;play size and b&#105;t depth can be specified by setting the <tt>QWS_&#83;IZE</tt> a&#110;d <tt>&#81;WS_DEPTH</tt><a name="applications "></a> envir&#111;nment &#118;ariables on the host that runs &#116;he Qt/Embedded Linux applications (e.&#103;., <tt>QWS_SIZE=320x480</tt> and <tt>QWS_DEPTH=32</tt>).</p>

</div></div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch23lev1sec3.html><img src="images/prev.gif" width="20" height="20" border="0" align="absmiddle" alt="Previous Page"></a>
<a href=ch24lev1sec1.html><img src="images/next.gif" width="20" height="20" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>