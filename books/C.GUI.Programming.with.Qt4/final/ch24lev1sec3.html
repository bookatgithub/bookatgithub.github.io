<html>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
<title>ch24lev1sec3.html</title>
<link rel="STYLESHEET" type="text/css" href="images/css1.css">
<link rel="STYLESHEET" type="text/css" href="images/css2.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch24lev1sec2.html><img src="images/prev.gif" width="20" height="20" border="0" align="absmiddle" alt="Previous Page"></a>
<a href=ch24lev1sec4.html><img src="images/next.gif" width="20" height="20" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<div style=""><div><a name="ch24lev1sec3"></a>
<h3 class="docSection1Title" id="-100000">Integrating Qt Applications with Qtopia</h3>
<p class="docText"><a name="Since Qt"></a>&#83;ince &#81;t/E&#109;bedded Linu&#120; o&#102;fers the sam&#101; API as the de&#115;ktop editions of Qt, any standar&#100; Q&#116; applica&#116;ion can be re&#99;ompiled to run on Qt/Emb&#101;dded Linux. Howeve&#114;, in practice, it is usually wise to create de&#100;icated applications that account for the smal&#108;er screens, limited (or non-existent) keyboards, and re&#115;ource l&#105;mits th&#97;t are typi&#99;al of the sma&#108;l devices that run &#81;t/Embedded Linux. F&#117;rthermore, Qtopia provides additiona&#108; libraries &#119;ith feature&#115; specific to mob&#105;le devices that we mi&#103;ht want to use in our Qt/Embed&#100;ed Linux applications.</p>
<p class="docText"><a name="can start"></a>Befo&#114;e we can start writing applications that ma&#107;e use of the Qtopia APIs, we must build and install the Qtopia &#83;DK, in&#99;luding its o&#119;n separate c&#111;py &#111;f Qt/Embedde&#100; Linux. Here we &#97;re assuming the use of the Qtopia Open Sour&#99;e Edition ve&#114;sion 4.2, w&#104;ich includes almos&#116; everything in th&#101; Qtopia Phone Edition.</p>
<p class="docText"><a name="Qtopia is"></a>Buil&#100;ing Qtopia is differ&#101;nt from standard Unix p&#114;actice, because Qtopia should not be built insi&#100;e &#105;ts sour&#99;e directory. &#70;o&#114; example, if we down&#108;oad the package <tt>qtopia-opensour&#99;e-src-4.2.4.tar.gz</tt> to our <tt>$HOME/downloads</tt> direc&#116;ory, we wo&#117;ld prepar&#101; to build Qtopi&#97; as follows:</p>
<div class="docText"><pre>cd $HOME/downloads
gunzip qtopia-opensource-src-4.2.4.tar.gz
tar xvf qtopia-opensource-src-4.2.4.tar</pre></div><br />
<p class="docText"><a name="iddle1741"></a><a name="iddle3183"></a><a name="iddle5580"></a><a name="iddle6999"></a><a name="iddle8456"></a><a name="will be"></a>Now we m&#117;st make a directory in which Qtopia &#119;ill be built, for example:</p>
<div class="docText"><pre>cd $HOME
mkdir qtopia</pre></div><br />
<p class="docText"><a name="up the"></a>For conveni&#101;nce, the documentation recommend&#115; setting up the <tt>QPEDIR</tt> environment variable. For examp&#108;e:</p>
<div class="docText"><pre>export QPEDIR=$HOME/qtopia</pre></div><br />
<p class="docText"><a name="Now we"></a>Here we ha&#118;e assumed t&#104;e use o&#102; the &#66;ash shell. Now we are r&#101;ady to build Qtopi&#97;:</p>
<div class="docText"><pre>cd $QPEDIR
$HOME/downloads/qtopia-opensource-src-4.2.4/configure
make
make install</pre></div><br />
<p class="docText">We haven't specified any opt&#105;ons to <tt>c&#111;nf&#105;gure</tt>, but you migh&#116; wish to. Run <tt>configu&#114;e -help</tt> to see what options are availa&#98;le.</p>
<p class="docText"><a name="in"></a>After installation, all the Qtopia files &#119;ill be in <tt>$QPEDIR/image</tt><a name="result of"></a>, and all the files created by the us&#101;r as a result of interacting with Qtopia will be in <tt>$QPE&#68;IR/home</tt><a name="a Qtopia"></a>. In Q&#116;opia-spe&#97;k, an &quot;image&quot; &#105;s a Qtop&#105;a file syst&#101;m that resides on a &#100;esktop computer and is used by the Qto&#112;ia e&#110;v&#105;ronment when it i&#115; run in the virt&#117;al framebuffer.</p>
<p class="docText"><a name="its own"></a>Qtopia provide&#115; its own comprehensive documentation set, and &#105;t is well worth becoming familiar with it since Qtopi&#97; offers many classes that are not available (or relevant to) the d&#101;sk&#116;op editi&#111;ns &#111;f Q&#116;. The starting poin&#116; is <tt>$QPEDIR/doc/html/in&#100;ex.html</tt>.</p>
<p class="docText"><a name="Once building"></a>Once building and i&#110;s&#116;alling a&#114;e complete, we can d&#111; an initial &#116;est by running <tt>$QPEDIR/scr&#105;pts/runqtopia</tt><a name="launches the"></a>. This script launches the &#118;irtual framebuffer with a special skin and <tt>qpe</tt><a name="Qtopia environment"></a>, the Qto&#112;ia environment that contains the Qtopia a&#112;pli&#99;ation stack. &#73;t is p&#111;ss&#105;ble to start the v&#105;rtual framebuffer &#97;nd the Qtopia environment separat&#101;ly, &#98;ut then we h&#97;ve to start them in t&#104;e correct &#111;rder. If we ina&#100;vertently start <tt>qpe</tt><a name="corrupt the"></a> firs&#116;, Qtopia will write to the X11 framebuffer, &#119;hich at best will corrupt the screen. The <tt>runqtopia</tt> script can b&#101; ex&#101;cu&#116;ed with <tt>-h&#101;lp</tt><a name="options it"></a> &#116;o see the list of comm&#97;nd-line options it supports. Th&#101;se include <tt>-skin</tt>, with a list of s&#107;ins to cho&#111;se &#102;rom.</p>
<p class="docText"><a name="be popped"></a>The vir&#116;ual framebu&#102;fer has a context &#109;enu that can be popped up by right-clicking anywhere exce&#112;t the Qtopia area. The menu lets us adju&#115;t the display and terminate Qtopia.</p>
<p class="docText"><a name="a virtual"></a>Now that w&#101; ha&#118;e Qtopia ru&#110;n&#105;ng in a v&#105;rtual framebu&#102;fer, we can build one &#111;f the supplied example applic&#97;tions, jus&#116; to see ho&#119; the process works. Then, we &#119;ill create a very simple &#97;pplication from scratch.</p>
<p class="docText"><a name="iddle2636"></a><a name="iddle4482"></a><a name="iddle6381"></a><a name="iddle6386"></a><a name="iddle8304"></a>Chang&#101; directory to <tt>$QPEDIR/example&#115;/application</tt>. Qtopia has its own version of <tt>qmake</tt> called <tt>q&#116;opiamake</tt>, located in <tt>$QPEDIR/bin</tt>. Run this to create a &#109;akefile, and &#116;hen run <tt>m&#97;ke</tt>. This wi&#108;l create an &#101;xecutable call&#101;d <tt>example</tt>. Now run <tt>m&#97;ke install</tt>; this will copy <tt>example</tt> (and some &#111;th&#101;r f&#105;les) into Qt&#111;pia's <tt>image</tt> di&#114;ectory. Now, if we terminate Qtopia &#97;nd then start it again, using <tt>runqtopi&#97;</tt><a name="button that"></a>, our new &quot;Example&quot; application will be available. To run the examp&#108;e, click the 'Q' button that is in the middle at the bottom of the Qt&#111;pi&#97; area, then &#99;lick the Pac&#107;ages icon (&#116;he &quot;boxes&quot; icon, jus&#116; above the pointing h&#97;nd), and then click &quot;Example&quot; (see <a class="docLink" href="#ch24fig03">Figure 24.3</a>).</p>
<p class="docText"><a name="this section"></a>We &#119;ill finish t&#104;is sec&#116;ion by creat&#105;ng a small but usefu&#108; Qtopia application from scratch, since &#116;here are a few details that we must be aware of. Th&#101; application is called Unit Convert&#101;r and is shown in <a class="docLink" href="#ch24fig02">Figure 24.2</a><a name="uses the"></a>. It only uses the Qt AP&#73; and t&#104;erefo&#114;e has f&#101;w s&#117;rprises. In t&#104;e next section, we will creat&#101; a more complex example that use&#115; some of &#116;he Qtopi&#97;-specific APIs.</p>
<a name="ch24fig02"></a><p><center>

<h5 class="docFigureTitle"><a name="Figure "></a>Fig&#117;re 24.2. The Unit Convert&#101;r application</h5>

<p class="docText">
<img border="0" id="" width="205" height="274" src="images/NzlkOW1jM2FhMDc4L2lwdHJnZTFnMTRzOXIvMy83LnB2bmhyaWV0L3JzdWljdGNlanBvZ24-.jpg" alt="" /></p>



</center></p><br />
<p class="docText"><a name="Converter application"></a>The Unit Conve&#114;ter application will be made from three fil&#101;s: <tt>main.cpp</tt>, <tt>unitconverter.h</tt>, and <tt>unitconv&#101;rter.cpp</tt><a name="a new"></a>. Create a new director&#121; ca&#108;led <tt>unitco&#110;v&#101;rt&#101;r</tt>, then <tt>cd</tt> i&#110;to it and create &#116;he <tt>.cpp</tt> and <tt>.h</tt> files as empty fi&#108;es. Now run</p>
<div class="docText"><pre>qtopiamake -project</pre></div><br />
<p class="docText">t&#111; pr&#111;duce a <tt>.pro</tt> file. T&#104;e file will look som&#101;thing like this:</p>
<div class="docText"><pre>qtopia_project(qtopia app)

TARGET        = unitconverter
CONFIG       += qtopia_main no_quicklaunch
HEADERS      += unitconverter.h
SOURCES      += main.cpp \
                unitconverter.cpp
pkg.domain    = none</pre></div><br />
<p class="docText"><a name="it would"></a>Even if we wro&#116;e the code, built the executable, and i&#110;stalled it, it would not appear in Q&#116;opia's list of applications. To achieve that, we must specif&#121; wh&#101;re <a name="iddle2101"></a><a name="iddle3173"></a><a name="iddle3244"></a>&#116;he appli&#99;ation's pict&#117;res are, where &#105;ts <tt>.desktop</tt><a name="It is"></a> file is, and whe&#114;e that should go. It is also good &#112;rac&#116;ice to pr&#111;vide &#115;ome packaging inf&#111;rmation. For these reasons, we ha&#110;d-edit the <tt>.pro</tt> file so that it now lo&#111;ks like this:</p>
<div class="docText"><pre>qtopia_project(qtopia app)

TARGET        = unitconverter
CONFIG       += qtopia_main no_quicklaunch
HEADERS      += unitconverter.h
SOURCES      += main.cpp \
                unitconverter.cpp
INSTALLS     += desktop pics

desktop.files = unitconverter.desktop
desktop.path  = /apps/Applications
desktop.hint  = desktop

pics.files    = pics/*
pics.path     = /pics/unitconverter
pics.hint     = pics

pkg.name      = unitconverter
pkg.desc      = A program to convert between various units of measurement
pkg.version   = 1.0.0
pkg.domain    = window</pre></div><br />
<a name="ch24fig03"></a><p><center>

<h5 class="docFigureTitle">Figure 24.3. Locating the Exa&#109;ple Application</h5>

<p class="docText">
<img border="0" id="" width="450" height="268" src="images/NzlkOW1jM2FhMDc4L2lwdHJnZTFnMTRzOXIvMy83cGF0aG8uanAvaXNxcGNpZ2Et.jpg" alt="" /></p>



</center></p><br />
<p class="docText">The <tt>.pro</tt> file now contains an <tt>INSTALLS</tt> entry &#116;hat says &#116;hat the a&#112;pli&#99;ation's <tt>.desk&#116;op</tt><a name="the executable"></a> file and &#112;ictures must be in&#115;talled in addition to the execu&#116;able whe&#110; w&#101; run <tt>m&#97;ke install</tt>.</p>
<p class="docText">By convent&#105;on, pictures are stored i&#110; a <tt>pics</tt> subdirectory, and the <tt>pics.</tt><span class="docEmphasis"><tt>&#120;xx</tt></span> entries in the <tt>.pro</tt><a name="located and"></a> file specify w&#104;ere the source pictures are located and where they shoul&#100; b&#101; in&#115;talled. &#84;he <tt>des&#107;top.</tt><span class="docEmphasis"><tt>xxx</tt></span> entries spe&#99;ify the name of the appl&#105;cation's <tt>.desktop</tt> file and w&#104;ere it &#115;hould b&#101; installed. &#73;nstalling it in <tt>/a&#112;ps/Applications</tt><a name="when the"></a> ensures tha&#116; it appears in the list of applications s&#104;own when the user clicks the Packages icon. When the &#97;pplication is run on a desktop machine, absolute <a name="iddle3664"></a><a name="iddle3665"></a><a name="iddle6376"></a><a name="iddle6380"></a><a name="iddle6387"></a>paths s&#117;ch as <tt>/apps/&#65;pplica&#116;ions</tt> and <tt>/&#112;ics/&#101;xpens&#101;s</tt><a name="to Qtopia"></a> are actually relat&#105;ve to Qtopia's <tt>image</tt> directory (wi&#116;h <tt>apps</tt><a name="by"></a> be&#105;ng repl&#97;ced by <tt>bin</tt>).</p>
<p class="docText"><a name="The"></a>The <tt>uni&#116;converter.d&#101;sktop</tt><a name="some basic"></a> file provides some ba&#115;ic information about the application. Fo&#114; our purposes, it is used to ensure tha&#116; the application shows up in the list of applications. This is t&#104;e comp&#108;ete file:</p>
<div class="docText"><pre>[Desktop Entry]
Comment[]=A program to convert between various units of measurement
Exec=unitconverter
Icon=unitconverter/Example
Type=Application
Name[]=Unit Converter</pre></div><br />
<p class="docText"><a name="information we"></a>Th&#101; in&#102;orm&#97;tion we have provided &#105;s only a subset of wha&#116; can be specified. For examp&#108;e, we can pro&#118;ide inform&#97;tion about transla&#116;ions. Notice that &#116;he icon has no file extens&#105;on, such as <tt>.png</tt><a name="show the"></a>; we leave the Qtopia reso&#117;rce system to find and show the appropriate picture.</p>
<p class="docText"><a name="special and"></a>So &#102;ar, we have seen a special and manually edited <tt>.pro</tt> file &#97;nd a <tt>.deskt&#111;p</tt><a name="can write"></a> f&#105;le. We mu&#115;t do jus&#116; one more Qto&#112;ia-specific t&#104;ing, and then we can write <tt>unitconve&#114;ter.h</tt> a&#110;d <tt>&#117;nitconverter.cp&#112;</tt><a name="we must"></a> using &#115;tandard Qt in the standard way. &#70;or Qtopia, we must follow a particular idiom t&#111; hook into the rest of the &#101;nvironment; the complete <tt>main.cpp</tt> is reduced to just th&#101;se &#108;ines:</p>
<div class="docText"><pre>#include &lt;QtopiaApplication&gt;

#include "unitconverter.h"

QTOPIA_ADD_APPLICATION("UnitConverter", UnitConverter)
QTOPIA_MAIN</pre></div><br />
<p class="docText">The na&#109;e of the main &#119;indow's clas&#115;, included f&#114;om <tt>unitconverter.h</tt>, &#105;s <tt>UnitConverter</tt>. Used in co&#110;j&#117;nction wi&#116;h <tt>qtopiamake</tt> and the <tt>u&#110;itconvert&#101;r.h</tt> and <tt>unitconvert&#101;r.cpp</tt><a name="the Qtopia"></a> files, we can produce a Qtopia ap&#112;lication that will run in the Qtopia environm&#101;nt. The <tt>main()</tt><a name="by the"></a> function is defined b&#121; th&#101; <tt>QT&#79;PIA_MAIN</tt> mac&#114;o.</p>
<p class="docText"><a name="apart from"></a>Sinc&#101; the ap&#112;lication, apart from <tt>mai&#110;.cpp</tt><a name="uses only"></a>, uses only st&#97;ndard Qt c&#108;asses, it co&#117;ld also be compiled and &#114;un as a no&#114;mal Qt application. To do &#116;his, we would need to use the standard <tt>qmake</tt> a&#110;d change <tt>main.cpp</tt> to this:</p>
<div class="docText"><pre>#include &lt;QApplication&gt;

#include "unitconverter.h"

int main(int argc, char *argv[])
{
    QApplication app(argc, argv);
    UnitConverter converter;
    converter.show();
    return app.exec();
}</pre></div><br />
<p class="docText"><a name="would have"></a>In addition, we wo&#117;ld have to comment out the <tt>qtopia_project()</tt><a name="in the"></a> line in the <tt>.pro</tt> file.</p>
<p class="docText"><a name="iddle2582"></a><a name="iddle2680"></a><a name="iddle4303"></a><a name="iddle4310"></a><a name="convenient to"></a>For a&#112;pli&#99;ations that &#110;e&#101;d o&#110;ly Qt/&#69;mbedded Linux, it is often m&#111;re convenient to develop them as standa&#114;d Qt ap&#112;lic&#97;tions, perhaps wi&#116;h an explicit <tt>res&#105;ze()</tt><a name="the dimensions"></a> of the main window to the dimen&#115;ions of a phone or PDA, and turn them into Qt&#111;pia applications when they are ready f&#111;r alpha testing. Alternatively, we could have two diffe&#114;ent <tt>ma&#105;n.cpp</tt> fi&#108;es, perhaps <tt>&#109;ain_desktop.&#99;pp</tt> and <tt>main_qtopia.cpp</tt>, &#97;nd two <tt>.pro</tt> files.</p>
<p class="docText"><a name="is similar"></a>Most of &#116;he code for the Unit Converter applicati&#111;n i&#115; simila&#114; to that in the ot&#104;er Qt exa&#109;ples shown throughout the book, s&#111; we will not review it here.</p>
<p class="docText">To test &#116;he application, we must run <tt>make</tt>, then <tt>make install</tt>, and then <tt>ru&#110;qtopia</tt><a name="we can"></a>. Once Qtopia is running in the vi&#114;tual f&#114;amebu&#102;fer, &#119;e can click t&#104;e 'Q' button, then t&#104;e Packages icon, then &quot;Uni&#116; Converter&quot;. After this, we can e&#120;e&#114;cise t&#104;e application &#98;y changing the amoun&#116; and by selecting different &#117;nits in the comboboxes.</p>
<p class="docText"><a name="Qt applications"></a>Creating Qtopia appli&#99;ations is not very different from creating con&#118;entional Qt applications, apart from some initial setup dif&#102;ere&#110;c&#101;s (t&#104;e spec&#105;al <tt>.pro</tt> file and t&#104;e <tt>.desktop</tt> file) and &#117;sing <tt>qtopiamake</tt> instead of <tt>qmake</tt><a name="is reasonably"></a>. Testin&#103; embe&#100;d&#101;d appli&#99;ations is reasonably e&#97;sy since they can be built, installed, an&#100; then run from within the virtual f&#114;amebuffer. As for the applications the&#109;selves, although they can simply be convent&#105;onal Qt &#97;pplicati&#111;ns, &#105;n pract&#105;ce it is usually be&#116;ter to write specificall&#121; with the limitations of the embedded envi&#114;onmen&#116; in mind a&#110;d to use the &#81;topia-s&#112;ecific APIs to ensu&#114;e that they integrate well with the rest of &#116;he Qtopia application stack.</p>

</div></div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch24lev1sec2.html><img src="images/prev.gif" width="20" height="20" border="0" align="absmiddle" alt="Previous Page"></a>
<a href=ch24lev1sec4.html><img src="images/next.gif" width="20" height="20" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>