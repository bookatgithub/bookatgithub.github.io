<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Section 21.2.&nbsp; Python Database Application Programmer's Interface (DB-API)</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch21lev1sec1.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch21lev1sec3.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<br><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><TD valign="top"><a name="ch21lev1sec2"></a>

<h3 id="700181-921" class="docSection1Title">21.2. Python Database Application Programmer's Interface (DB-API)</H3>
<p class="docText"><a name="iddle1089"></a><a name="iddle1599"></a><a name="iddle1601"></a><a name="iddle1609"></a>Where can one find the interfaces necessary to talk to a database? Simple. Just go to the database topics section at the main Python Web site. There you will find links to the full and current DB-API (version 2.0), existing database modules, documentation, the special interest group, etc. Since its inception, the DB-API has been moved into PEP 249. (This PEP obsoletes the old DB-API 1.0 specification which is PEP 248.) What is the DB-API?</p>
<p class="docText">The API is a specification that states a set of required objects and database access mechanisms to provide consistent access across the various database adapters and underlying database systems. Like most community-based efforts, the API was driven by strong need.</P>
<p class="docText">In the &quot;old days,&quot; we had a scenario of many databases and many people implementing their own database adapters. It was a wheel that was being reinvented over and over again. These databases and adapters were implemented at different times by different people without any consistency of functionality. Unfortunately, this meant that application code using such interfaces also had to be customized to which database module they chose to use, and any changes to that interface also meant updates were needed in the application code.</P>
<p class="docText">A special interest group (SIG) for Python database connectivity was formed, and eventually, an API was born ... the DB-API version 1.0. The API provides for a consistent interface to a variety of relational databases, and porting code between different databases is much simpler, usually only requiring tweaking several lines of code. You will see an example of this later on in this chapter.</P>
<a name="ch21lev2sec4"></a>
<H4 id="title-IDAP1QJ" class="docSection2Title">21.2.1. Module Attributes</h4>
<p class="docText">The DB-API specification mandates that the features and attributes listed below must be supplied. A DB-API-compliant module must define the global attributes as shown in <a class="docLink" href="#ch21table01">Table 21.1</a>.</p>
<a name="ch21table01"></a><p><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><H5 class="docTableTitle">Table 21.1. DB-API Module Attributes</h5></caption><colgroup align="left" span="2"><col width="150"><col width="300"></colgroup><thead><TR><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Attribute</span></p></th><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Description</span></P></th></tr></thead><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>apilevel</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Version of DB-API module is compliant with</p></TD></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>threadsafety</tt></p></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Level of thread safety of this module</P></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>paramstyle</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">SQL statement parameter style of this module</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>Connect()</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>Connect()</tt> function</p></TD></tr><TR><td class="docTableCell" align="left" valign="top"><p class="docText"><span class="docEmphasis">(Various exceptions)</span></P></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">(<span class="docEmphasis">See <a class="docLink" href="#ch21table04">Table 21.4</a></span>)</P></td></tr></table></p><BR>
<a name="ch21lev3sec6"></a>
<h5 id="title-IDA15QJ" class="docSection3Title">Data Attributes</H5>
<p class="docText"><span class="docEmphBoldItalic">apilevel</span></p>
<p class="docText">This string (not float) indicates the highest version of the DB-API the module is compliant with, i.e., &quot;1.0&quot;, &quot;2.0&quot;, etc. If absent, &quot;1.0&quot; should be assumed as the default value.</P>
<p class="docText"><a name="iddle1514"></a><a name="iddle1603"></a><a name="iddle1607"></a><a name="iddle1610"></a><a name="iddle1612"></a><a name="iddle3007"></a><a name="iddle3383"></a><a name="iddle4182"></a><span class="docEmphBoldItalic">threadsafety</span></p>
<p class="docText">This an integer with these possible values:</P>
<UL><li><p class="docList">0: Not threadsafe, so threads should not share the module at all</p></li><li><p class="docList">1: Minimally threadsafe: threads can share the module but not connections</P></li><li><p class="docList">2: Moderately threadsafe: threads can share the module and connections but not cursors</P></li><li><p class="docList">3: Fully threadsafe: threads can share the module, connections, and cursors</p></LI></UL>
<p class="docText">If a resource is shared, a synchronization primitive such as a spin lock or semaphore is required for atomic-locking purposes. Disk files and global variables are not reliable for this purpose and may interfere with standard mutex operation. See the threading module or the chapter on multithreaded programming (<a class="docLink" href="ch16.html#ch16">Chapter 16</a>) on how to use a lock.</p>
<p class="docText"><span class="docEmphBoldItalic">paramstyle</span></p>
<p class="docText">The API supports a variety of ways to indicate how parameters should be integrated into an SQL statement that is eventually sent to the server for execution. This argument is just a string that specifies the form of string substitution you will use when building rows for a query or command (see <a class="docLink" href="#ch21table02">Table 21.2</a>).</p>
<a name="ch21table02"></a><p><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><h5 class="docTableTitle">Table 21.2. <tt>paramstyle</tt> Database Parameter Styles</h5></caption><colgroup align="left" span="3"><col width="100"><col width="170"><col width="250"></colgroup><thead><tr><th class="thead" scope="col" align="left" valign="bottom"><p class="docText"><span class="docEmphasis">Parameter Style</span></p></th><th class="thead" scope="col" align="left" valign="bottom"><p class="docText"><span class="docEmphasis">Description</span></p></th><th class="thead" scope="col" align="left" valign="bottom"><p class="docText"><span class="docEmphBoldItalic">Example</span></p></th></tr></thead><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>numeric</tt></p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Numeric positional style</P></td><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>WHERE name=:1</tt></p></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>named</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Named style</P></td><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>WHERE name=:name</tt></p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>pyformat</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Python dictionary <tt>printf()</tt> format conversion</p></TD><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>WHERE name=%(name)s</tt></p></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>qmark</tt></P></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Question mark style</p></td><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>WHERE name=?</tt></p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>format</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">ANSI C <tt>printf()</tt> format conversion</P></td><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>WHERE name=%s</tt></p></TD></tr></table></P><br>

<a name="ch21lev3sec7"></a>
<H5 id="title-IDAVIRJ" class="docSection3Title">Function Attribute(s)</H5>
<p class="docText"><tt>connect()</tt> Function access to the database is made available through <tt>Connection</tt> objects. A compliant module has to implement a <tt>connect()</tt> function, which creates and returns a <tt>Connection</tt> object. <a class="docLink" href="#ch21table03">Table 21.3</a> shows the arguments to <tt>connect()</tt>.</P>
<a name="ch21table03"></a><P><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><h5 class="docTableTitle">Table 21.3. <tt>connect()</tt> Function Attributes</h5></caption><colgroup align="left" span="2"><col width="175"><col width="250"></colgroup><thead><tr><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Parameter</span></P></th><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Description</span></p></th></TR></thead><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>user</tt></p></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">Username</p></td></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>password</tt></p></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Password</p></td></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>host</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Hostname</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>database</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Database name</p></TD></tr><TR><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>dsn</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Data source name</p></TD></TR></table></P><BR>
<p class="docText"><a name="iddle1611"></a><a name="iddle3384"></a>You can pass in database connection information as a string with multiple parameters (DSN) or individual parameters passed as positional arguments (if you know the exact order), or more likely, keyworded arguments. Here is an example of using <tt>connect()</tt> from PEP 249:</p>
<div class="docText"><pre>  connect(dsn='myhost:MYDB',user='guido',password='234$')</pre></div><br>
<p class="docText">The use of DSN versus individual parameters is based primarily on the system you are connecting to. For example, if you are using an API like ODBC or JDBC, you would likely be using a DSN, whereas if you are working directly with a database, then you are more likely to issue separate login parameters. Another reason for this is that most database adapters have not implemented support for DSN. Below are some examples of non-DSN <a name="iddle1515"></a><a name="iddle1604"></a><a name="iddle1606"></a><a name="iddle1821"></a><a name="iddle1852"></a><a name="iddle3177"></a><a name="iddle4451"></a><tt>connect()</tt> calls. Note that not all adapters have implemented the specification exactly, e.g., <tt>MySQLdb</tt> uses <tt>db</tt> instead of <tt>database</tt>.</p>
<div class="docText"><pre>&#8226; MySQLdb.connect(host='dbserv', db='inv', user='smith')
&#8226; PgSQL.connect(database='sales')
&#8226; psycopg.connect(database='template1', user='pgsql')
&#8226; gadfly.dbapi20.connect('csrDB', '/usr/local/database')
&#8226; sqlite3.connect('marketing/test')</pre></div><BR>

<a name="ch21lev3sec8"></a>
<h5 id="title-IDA2PRJ" class="docSection3Title">Exceptions</H5>
<p class="docText">Exceptions that should also be included in the compliant module as globals are shown in <a class="docLink" href="#ch21table04">Table 21.4</a>.</p>
<a name="ch21table04"></a><P><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><h5 class="docTableTitle">Table 21.4. DB-API Exception Classes</H5></caption><colgroup align="left" span="2"><col width="150"><col width="250"></colgroup><thead><TR><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Exception</span></p></th><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Description</span></p></th></tr></thead><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>Warning</tt></p></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Root warning exception class</p></td></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>Error</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Root error exception class</p></td></tr><tr><td class="docTableCell" align="left" valign="top">
<blockquote><p><p class="docList"><tt>InterfaceError</tt></p></p></blockquote></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Database interface (not database) error</p></TD></tr><TR><td class="docTableCell" align="left" valign="top">
<blockquote><P><p class="docList"><tt>DatabaseError</tt></p></P></blockquote></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">Database error</P></td></tr><tr><TD class="docTableCell" align="left" valign="top"><blockquote><p><p class="docList"><blockquote><P><p class="docList"><tt>DataError</tt></p></P></blockquote></p></P></blockquote></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Problems with the processed data</p></td></tr><TR><td class="docTableCell" align="left" valign="top"><blockquote><p><p class="docList"><blockquote><P><p class="docList"><tt>OperationalError</tt></p></p></blockquote></p></P></blockquote></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Error during database operation execution</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><blockquote><p><p class="docList"><blockquote><p><p class="docList"><tt>IntegrityError</tt></p></p></blockquote></p></p></blockquote></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Database relational integrity error</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><blockquote><p><p class="docList"><blockquote><P><p class="docList"><tt>InternalError</tt></P></P></blockquote></P></p></blockquote></td><td class="docTableCell" align="left" valign="top"><p class="docText">Error that occurs within the database</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><blockquote><p><p class="docList"><blockquote><P><p class="docList"><tt>ProgrammingError</tt></P></p></blockquote></p></p></blockquote></td><TD class="docTableCell" align="left" valign="top"><p class="docText">SQL command failed</p></td></TR><tr><td class="docTableCell" align="left" valign="top"><blockquote><p><p class="docList"><blockquote><P><p class="docList"><tt>NotSupportedError</tt></P></p></blockquote></p></p></blockquote></td><td class="docTableCell" align="left" valign="top"><p class="docText">Unsupported operation occurred</p></td></tr></table></p><br>


<a name="ch21lev2sec5"></a>
<h4 id="title-IDA3XRJ" class="docSection2Title">21.2.2. <tt>Connection</tt> Objects</h4>
<p class="docText">Connections are how your application gets to talk to the database. They represent the fundamental communication mechanism by which commands are sent to the server and results returned. Once a connection has been established (or a pool of connections), you create cursors to send requests to and receive replies from the database.</P>
<a name="ch21lev3sec9"></a>

<h5 id="title-IDAOYRJ" class="docSection3Title">Methods</H5>
<p class="docText"><a name="iddle2863"></a><tt>Connection</tt> objects are not required to have any data attributes but should define the methods shown in <a class="docLink" href="#ch21table05">Table 21.5</a>.</p>
<a name="ch21table05"></a><P><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><h5 class="docTableTitle">Table 21.5. <tt>Connection</tt> Object Methods</H5></caption><colgroup align="left" span="2"><col width="200"><col width="300"></colgroup><thead><tr><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Method Name</span></P></th><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Description</span></P></th></TR></thead><TR><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>close()</tt></p></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Close database connection</p></TD></tr><TR><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>commit()</tt></P></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Commit current transaction</p></td></tr><TR><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>rollback()</tt></p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Cancel current transaction</p></td></TR><TR><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>cursor()</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Create (and return) a cursor or cursor-like object using this connection</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>errorhandler(cxn, cur, errcls, errval)</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Serves as a handler for given connection cursor</P></td></TR></table></p><BR>
<p class="docText">When <tt>close()</tt> is used, the same connection cannot be used again without running into an exception.</p>
<p class="docText">The <tt>commit()</tt> method is irrelevant if the database does not support transactions or if it has an auto-commit feature that has been enabled. You can implement separate methods to turn auto-commit off or on if you wish. Since this method is required as part of the API, databases that do not have the concept of transactions should just implement &quot;pass&quot; for this method.</P>
<p class="docText">Like <tt>commit(), rollback()</tt> only makes sense if transactions are supported in the database. After execution, <tt>rollback()</tt> should leave the database in the same state as it was when the transaction began. According to PEP 249, &quot;Closing a connection without committing the changes first will cause an implicit rollback to be performed.&quot;</p>
<p class="docText">If the RDBMS does not support cursors, <tt>cursor()</tt> should still return an object that faithfully emulates or imitates a real cursor object. These are just the minimum requirements. Each individual adapter developer can always add special attributes specifically for their interface or database.</P>
<p class="docText">It is also recommended but not required for adapter writers to make all database module exceptions (see above) available via a connection. If not, then it is assumed that <tt>Connection</tt> objects will throw the corresponding module-level exception. Once you have completed using your connection and cursors closed, you should <tt>commit()</tt> any operations and <tt>close()</tt> your connection.</P>


<a name="ch21lev2sec6"></a>

<H4 id="title-IDA03RJ" class="docSection2Title">21.2.3. <tt>Cursor</tt> Objects</H4>
<p class="docText"><a name="iddle1556"></a><a name="iddle1605"></a><a name="iddle3179"></a>Once you have a connection, you can start talking to the database. As we mentioned above in the introductory section, a cursor lets a user issue database commands and retrieve rows resulting from queries. A Python DB-API cursor object functions as a cursor for you, even if cursors are not supported in the database. In this case, the database adapter creator must implement <tt>CURSOR</tt> objects so that they act like cursors. This keeps your Python code consistent when you switch between database systems that have or do not have cursor support.</p>
<p class="docText">Once you have created a cursor, you can execute a query or command (or multiple queries and commands) and retrieve one or more rows from the results set. <a class="docLink" href="#ch21table06">Table 21.6</a> shows data attributes and methods that cursor objects have.</p>
<a name="ch21table06"></a><p><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><H5 class="docTableTitle">Table 21.6. <tt>Cursor</tt> Object Attributes</h5></caption><colgroup align="left" span="2"><col width="150"><col width="300"></colgroup><thead><TR><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Object Attribute</span></p></th><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Description</span></P></th></tr></thead><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>arraysize</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Number of rows to fetch at a time with <tt>fetch many()</tt>; defaults to 1</p></TD></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>connection</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Connection that created this cursor (optional)</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>description</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Returns cursor activity (7-item tuples): <tt>(name, type_code, display_size, internal_ size, precision, scale, null_ok)</tt>; only name and type_code are required</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>lastrowid</tt></p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Row ID of last modified row (optional; if row IDs not supported, default to None)</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>rowcount</tt></p></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">Number of rows that the last <tt>execute*()</tt> produced or affected</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>callproc(</tt> <span class="docEmphasis"><tt>func</tt></span><tt>[,</tt> <span class="docEmphasis"><tt>args</tt></span><tt>])</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Call a stored procedure</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>close()</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Close cursor</p></TD></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>execute(</tt><span class="docEmphasis"><tt>op</tt></span><tt>[,</tt> <span class="docEmphasis"><tt>args</tt></span><tt>])</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Execute a database query or command</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>executemany(</tt><span class="docEmphasis"><tt>op</tt></span><tt>,</tt> <span class="docEmphasis"><tt>args</tt></span><tt>)</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Like <tt>execute()</tt> and <tt>map()</tt> combined; prepare and execute a database query or command over given arguments</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><a name="iddle1522"></a><a name="iddle1613"></a><tt>fetchone()</tt></p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Fetch next row of query result</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>fetchmany ([</tt><span class="docEmphasis"> <tt>size</tt></span><tt>=cursor.arraysize])</tt></p></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">Fetch next size rows of query result</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>fetchall()</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Fetch all (remaining) rows of a query result</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>__iter__()</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Create iterator object from this cursor (optional; also see <tt>next())</tt></p></TD></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>messages</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">List of messages (set of tuples) received from the database for cursor execution (optional)</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>next()</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Used by iterator to fetch next row of query result (optional; like <tt>fetchone()</tt>, also see __<tt>iter</tt>__())</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>nextset()</tt></p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Move to next results set (if supported)</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>rownumber</tt></p></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">Index of cursor (by row, 0-based) in current result set (optional)</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>setinput-sizes(</tt><span class="docEmphasis"><tt>sizes</tt></span><tt>)</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Set maximum input-size allowed (required but implementation optional)</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>setoutput size(</tt><span class="docEmphasis"><tt>size</tt></span><tt>[,</tt> <span class="docEmphasis"><tt>col</tt></span><tt>])</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Set maximum buffer size for large column fetches (required but implementation optional)</p></TD></tr></table></p><BR>
<p class="docText">The most critical attributes of cursor objects are the <tt>execute*()</tt> and the <tt>fetch*()</tt> methods ... all the service requests to the database are performed by these. The <tt>arraysize</tt> data attribute is useful in setting a default size for <tt>fetchmany()</tt>. Of course, closing the cursor is a good thing, and if your database supports stored procedures, then you will be using <tt>callproc()</tt>.</p>

<a name="ch21lev2sec7"></a>
<h4 id="title-IDAV0EVD" class="docSection2Title">21.2.4. Type Objects and Constructors</h4>
<p class="docText">Oftentimes, the interface between two different systems are the most fragile. This is seen when converting Python objects to C types and vice versa. Similarly, there is also a fine line between Python objects and native database objects. As a programmer writing to Python's DB-API, the parameters you send to a database <a name="iddle1582"></a><a name="iddle1602"></a><a name="iddle3547"></a>are given as strings, but the database may need to convert it to a variety of different, supported data types that are correct for any particular query.</P>
<p class="docText">For example, should the Python string be converted to a VARCHAR, a TEXT, a BLOB, or a raw BINARY object, or perhaps a DATE or TIME object if that is what the string is supposed to be? Care must be taken to provide database input in the expected format, so because of this another requirement of the DB-API is to create constructors that build special objects that can easily be converted to the appropriate database objects. <a class="docLink" href="#ch21table07">Table 21.7</a> describes classes that can be used for this purpose. SQL NULL values are mapped to and from Python's NULL object, <tt>None</tt>.</P>
<a name="ch21table07"></a><p><table cellspacing="0" FRAME="hsides" RULES="none" cellpadding="5"><caption><h5 class="docTableTitle">Table 21.7. Type Objects and Constructors</h5></caption><colgroup align="left" span="2"><col width="170"><col width="275"></colgroup><thead><tr><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Type Object</span></p></th><th class="thead" scope="col" align="left" valign="top"><p class="docText"><span class="docEmphasis">Description</span></p></th></tr></thead><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>Date(</tt><span class="docEmphasis"><tt>yr</tt></span><tt>,</tt> <span class="docEmphasis"><tt>mo</tt></span><tt>,</tt> <span class="docEmphasis"><tt>dy</tt></span><tt>)</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Object for a date value</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>Time(</tt><span class="docEmphasis"><tt>hr</tt></span><tt>,</tt> <span class="docEmphasis"><tt>min</tt></span><tt>,</tt> <span class="docEmphasis"><tt>sec</tt></span><tt>)</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Object for a time value</P></TD></TR><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>Timestamp(</tt><span class="docEmphasis"><tt>yr</tt></span><tt>,</tt> <span class="docEmphasis"><tt>mo</tt></span><tt>,</tt> <span class="docEmphasis"><tt>dy</tt></span><tt>,</tt> <span class="docEmphasis"><tt>hr</tt></span><tt>,</tt> <span class="docEmphasis"><tt>min</tt></span><tt>,</tt> <span class="docEmphasis"><tt>sec</tt></span><tt>)</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Object for a timestamp value</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>DateFromTicks(</tt><span class="docEmphasis"><tt>ticks</tt></span><tt>)</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Date object given number of seconds since the epoch</p></TD></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>TimeFromTicks(</tt><span class="docEmphasis"><tt>ticks</tt></span><tt>)</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Time object given number of seconds since the epoch</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>TimestampFromTicks(</tt><span class="docEmphasis"><tt>ticks</tt></span><tt>)</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Timestamp object given number of seconds since the epoch</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>Binary(</tt><span class="docEmphasis"><tt>string</tt></span><tt>)</tt></p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">Object for a binary (long) string value</P></td></TR><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>STRING</tt></p></TD><TD class="docTableCell" align="left" valign="top"><p class="docText">Object describing string-based columns, e.g., VARCHAR</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>BINARY</tt></P></td><TD class="docTableCell" align="left" valign="top"><p class="docText">Object describing (long) binary columns, i.e., RAW, BLOB</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>NUMBER</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Object describing numeric columns</p></TD></tr><tr><TD class="docTableCell" align="left" valign="top"><p class="docText"><tt>DATETIME</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Object describing date/time columns</P></TD></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText"><tt>ROWID</tt></p></td><td class="docTableCell" align="left" valign="top"><p class="docText">Object describing &quot;row ID&quot; columns</p></td></tr></table></p><br>
<a name="ch21lev3sec10"></a>

<h5 id="title-IDAAMHVD" class="docSection3Title">Changes to API Between Versions</H5>
<p class="docText"><a name="iddle1054"></a><a name="iddle1594"></a>Several important changes were made when the DB-API was revised from version 1.0 (1996) to 2.0 (1999):</p>
<UL><li><p class="docList">Required <tt>dbi</tt> module removed from API</P></li><LI><p class="docList">Type objects were updated</p></LI><LI><p class="docList">New attributes added to provide better database bindings</P></LI><li><p class="docList"><tt>callproc()</tt> semantics and return value of <tt>execute()</tt> redefined</p></li><LI><p class="docList">Conversion to class-based exceptions</p></LI></ul>
<p class="docText">Since version 2.0 was published, some of the additional optional DB-API extensions that you read about above were added in 2002. There have been no other significant changes to the API since it was published. Continuing discussions of the API occur on the DB-SIG mailing list. Among the topics brought up over the last 5 years include the possibilities for the next version of the DB-API, tentatively named DB-API 3.0. These include the following:</P>
<ul><LI><p class="docList">Better return value for <tt>nextset()</tt> when there is a new result set</P></li><li><p class="docList">Switch from <tt>float</tt> to <tt>Decimal</tt></p></li><LI><p class="docList">Improved flexibility and support for parameter styles</p></li><LI><p class="docList">Prepared statements or statement caching</p></li><li><p class="docList">Refine the transaction model</P></LI><li><p class="docList">State the role of API with respect to portability</p></li><li><p class="docList">Add unit testing</p></li></ul>
<p class="docText">If you have strong feelings about the API, feel free to participate and join in the discussion. Here are some references you may find handy.</p>
<ul><li><p class="docList"><a class="docLink" target="_blank" href="http://python.org/topics/database">http://python.org/topics/database</a></p></li><LI><p class="docList"><a class="docLink" target="_blank" href="http://www.linuxjournal.com/article/2605">http://www.linuxjournal.com/article/2605</a></p></LI><li><p class="docList"><a class="docLink" target="_blank" href="http://wiki.python.org/moin/DbApi3">http://wiki.python.org/moin/DbApi3</a></P></li></UL>


<a name="ch21lev2sec8"></a>
<h4 id="title-IDATPHVD" class="docSection2Title">21.2.5. Relational Databases</H4>
<p class="docText">So, you are now ready to go. A burning question must be, &quot;Interfaces to which database systems are available to me in Python?&quot; That inquiry is similar to, &quot;Which platforms is Python available for?&quot; The answer is, &quot;Pretty much all of them.&quot; Following is a list that is comprehensive but not exhaustive:</P>
<p class="docText"><span class="docEmphBoldItalic">Commercial RDBMSs</span></P>
<UL><li><p class="docList">Informix</p></li><LI><p class="docList">Sybase</p></LI><li><p class="docList">Oracle</P></li><LI><p class="docList">MS SQL Server</P></li><li><p class="docList">DB/2</p></li><LI><p class="docList">SAP</p></li><LI><p class="docList">Interbase</p></li><li><p class="docList">Ingres</P></LI></ul>
<p class="docText"><span class="docEmphBoldItalic">Open Source RDBMSs</span></p>
<ul><li><p class="docList">MySQL</p></li><li><p class="docList">PostgreSQL</p></li><li><p class="docList">SQLite</p></li><LI><p class="docList">Gadfly</p></LI></ul>
<p class="docText"><span class="docEmphBoldItalic">Database APIs</span></P>
<ul><LI><p class="docList">JDBC</p></LI><LI><p class="docList">ODBC</P></LI></ul>
<p class="docText">To find a current list of what databases are supported, check out:</p>
<blockquote>
<p class="docText"><a class="docLink" target="_blank" href="http://python.org/topics/database/modules.html">http://python.org/topics/database/modules.html</a></p>
</blockquote>

<a name="ch21lev2sec9"></a>
<H4 id="title-IDAVCYBD" class="docSection2Title">21.2.6. Databases and Python: Adapters</h4>
<p class="docText">For each of the databases supported, there exists one or more adapters that let you connect to the target database system from Python. Some databases, such as Sybase, SAP, Oracle, and SQLServer, have more than one adapter available. The best thing to do is to find out which ones fit your needs best. Your questions for each candidate may include: how good its performance is, how useful is its documentation and/or Web site, whether it has an active community or not, what the overall quality and stability of the driver is, etc. You have to keep in mind that most adapters provide just the basic necessities to get you connected to the database. It is the extras that you may be looking for. Keep in mind that you are responsible for higher-level code like threading and thread management as well as management of database connection pools, etc.</P>
<p class="docText">If you are squeamish and want less hands-onfor example, if you wish to do as little SQL or database administration as much as possiblethen you may wish to consider object-relational mappers, covered later on in this chapter.</p>
<p class="docText"><a name="iddle1056"></a><a name="iddle1058"></a><a name="iddle1570"></a><a name="iddle1575"></a><a name="iddle3023"></a>Let us now look at some examples of how to use an adapter module to talk to a relational database. The real secret is in setting up the connection. Once you have this and use the DB-API objects, attributes, and object methods, your core code should be pretty much the same regardless of which adapter and RDBMS you use.</P>

<a name="ch21lev2sec10"></a>
<h4 id="title-IDAIEYBD" class="docSection2Title">21.2.7. Examples of Using Database Adapters</H4>
<p class="docText">First, let us look at a some sample code, from creating a database to creating a table and using it. We present examples using MySQL, PostgreSQL, and SQLite.</P>
<a name="ch21lev3sec11"></a>
<h5 id="title-IDATEYBD" class="docSection3Title">MySQL</h5>
<p class="docText">We will use MySQL as the example here, along with the only MySQL Python adapter: <tt>MySQLdb</tt>, aka MySQL-python. In the various bits of code, we will also show you (deliberately) examples of error situations so that you have an idea of what to expect, and what you may wish to create handlers for.</p>
<p class="docText">We first log in as an administrator to create a database and grant permissions, then log back in as a normal client.</p>
<div class="docText"><pre>  &gt;&gt;&gt; <span class="docEmphStrong">import</span> MySQLdb
  &gt;&gt;&gt; cxn = MySQLdb.connect(user='root')
  &gt;&gt;&gt; cxn.query('DROP DATABASE test')
  Traceback (most recent call last):
    File "&lt;stdin&gt;", line 1, in ?
  _mysql_exceptions.OperationalError: (1008, &quot;Can't drop
  database 'test'; database doesn't exist&quot;)
  &gt;&gt;&gt; cxn.query('CREATE DATABASE test')
  &gt;&gt;&gt; cxn.query(&quot;GRANT ALL ON test.* to ''@'localhost'&quot;)
  &gt;&gt;&gt; cxn.commit()
  &gt;&gt;&gt; cxn.close()</pre></div><BR>
<p class="docText">In the code above, we did not use a cursor. Some adapters have <tt>Connection</tt> objects, which can execute SQL queries with the <tt>query()</tt> method, but not all. We recommend you either not use it or check your adapter to make sure it is available.</p>
<p class="docText">The <tt>commit()</tt> was optional for us as auto-commit is turned on by default in MySQL. We then connect back to the new database as a regular user, create a table, and perform the usual queries and commands using SQL to get our job done via Python. This time we use cursors and their <tt>execute()</tt> method.</p>
<p class="docText">The next set of interactions shows us creating a table. An attempt to create it again (without first dropping it) results in an error.</P>
<div class="docText"><pre>  &gt;&gt;&gt; cxn = MySQLdb.connect(db='test')
  &gt;&gt;&gt; cur = cxn.cursor()
  &gt;&gt;&gt; cur.execute('CREATE TABLE users(login VARCHAR(8), uid INT)')
  0L</pre></div><br>
<p class="docText">Now we will insert a few rows into the database and query them out.</p>
<div class="docText"><pre>  &gt;&gt;&gt; cur.execute("INSERT INTO users VALUES('john', 7000)")
  1L
  &gt;&gt;&gt; cur.execute("INSERT INTO users VALUES('jane', 7001)")
  1L
  &gt;&gt;&gt; cur.execute("INSERT INTO users VALUES('bob', 7200)")
  1L
  &gt;&gt;&gt; cur.execute("SELECT * FROM users WHERE login LIKE 'j%'")
  2L
  &gt;&gt;&gt; <span class="docEmphStrong">for</span> data <span class="docEmphStrong">in</span> cur.fetchall():
  ... <span class="docEmphStrong">print</span> '%s\t%s' % data
  ...
  john   7000
  jane   7001</pre></div><br>
<p class="docText">The last bit features updating the table, either updating or deleting rows.</P>
<div class="docText"><pre>  &gt;&gt;&gt; cur.execute("UPDATE users SET uid=7100 WHERE uid=7001")
  1L
  &gt;&gt;&gt; cur.execute("SELECT * FROM users")
  3L
  &gt;&gt;&gt; for data in cur.fetchall():
  ...  print '%s\t%s' % data
  ...
  john    7000
  jane    7100
  bob     7200
  &gt;&gt;&gt; cur.execute('DELETE FROM users WHERE login="bob"')
  1L
  &gt;&gt;&gt; cur.execute('DROP TABLE users')
  0L
  &gt;&gt;&gt; cur.close()
  &gt;&gt;&gt; cxn.commit()
  &gt;&gt;&gt; cxn.close()</pre></div><BR>
<p class="docText">MySQL is one of the most popular open source databases in the world, and it is no surprise that a Python adapter is available for it. Keep in mind that no database modules are available in the Python standard libraryall <a name="iddle1061"></a><a name="iddle1581"></a><a name="iddle3445"></a>adapters are third-party packages that have to be downloaded and installed separately from Python. Please see the References section toward the end of the chapter to find out how to download it.</p>

<a name="ch21lev3sec12"></a>
<h5 id="title-IDAFIZBD" class="docSection3Title">PostgreSQL</h5>
<p class="docText">Another popular open source database is PostgreSQL. Unlike MySQL, there are no less than three current Python adapters available for Postgres: <tt>psycopg</tt>, PyPgSQL, and PyGreSQL. A fourth, PoPy, is now defunct, having contributed its project to combine with that of PyGreSQL back in 2003. Each of the three remaining adapters has its own characteristics, strengths, and weaknesses, so it would be a good idea to practice due diligence to determine which is right for you.</p>
<p class="docText">The good news is that the interfaces are similar enough that you can create an application that, say, measures the performance between all three (if that is a metric that is important to you). Here we show you the setup code to get a <tt>Connection</tt> object for each:</p>
<p class="docText"><span class="docEmphBoldItalic">psycopg</span></p>
<div class="docText"><pre>  &gt;&gt;&gt; <span class="docEmphStrong">import</span> psycopg
  &gt;&gt;&gt; cxn = psycopg.connect(user='pgsql')</pre></div><br>
<p class="docText"><span class="docEmphBoldItalic">PyPgSQL</span></p>
<div class="docText"><pre>  &gt;&gt;&gt; <span class="docEmphStrong">from</span> pyPgSQL <span class="docEmphStrong">import</span> PgSQL
  &gt;&gt;&gt; cxn = PgSQL.connect(user='pgsql')</pre></div><br>
<p class="docText"><span class="docEmphBoldItalic">PyGreSQL</span></p>
<div class="docText"><pre>  &gt;&gt;&gt; <span class="docEmphStrong">import</span> pgdb
  &gt;&gt;&gt; cxn = pgdb.connect(user='pgsql')</pre></div><br>
<p class="docText">Now comes some generic code that will work for all three adapters.</p>
<div class="docText"><pre>  &gt;&gt;&gt; cur = cxn.cursor()
  &gt;&gt;&gt; cur.execute('SELECT * FROM pg_database')
  &gt;&gt;&gt; rows = cur.fetchall()
  &gt;&gt;&gt; <span class="docEmphStrong">for</span> i <span class="docEmphStrong">in</span> rows:
  ...  <span class="docEmphStrong">print</span> i
  &gt;&gt;&gt; cur.close()
  &gt;&gt;&gt; cxn.commit()
  &gt;&gt;&gt; cxn.close()</pre></div><BR>
<p class="docText">Finally, you can see how their outputs are slightly different from one another.</p>
<p class="docText"><a name="iddle1063"></a><a name="iddle1589"></a><a name="iddle3901"></a><span class="docEmphBoldItalic">PyPgSQL</span></P>
<div class="docText"><pre>  sales
  template1
  template0</pre></div><br>
<p class="docText"><span class="docEmphBoldItalic">psycopg</span></P>
<div class="docText"><pre>  ('sales', 1, 0, 0, 1, 17140, '140626', '3221366099',
  '', None, None)
  ('template1', 1, 0, 1, 1, 17140, '462', '462', '', None,
  '{pgsql=C*T*/pgsql}')
  ('template0', 1, 0, 1, 0, 17140, '462', '462', '', None,
  '{pgsql=C*T*/pgsql}')</pre></div><br>
<p class="docText"><span class="docEmphBoldItalic">PyGreSQL</span></P>
<div class="docText"><pre>  ['sales', 1, 0, False, True, 17140L, '140626',
  '3221366099', '', None, None]
  ['template1', 1, 0, True, True, 17140L, '462', '462',
  '', None, '{pgsql=C*T*/pgsql}']
  ['template0', 1, 0, True, False, 17140L, '462',
  '462', '', None, '{pgsql=C*T*/pgsql}']</pre></div><br>

<a name="ch21lev3sec13"></a>
<H5 id="title-IDADNZBD" class="docSection3Title">SQLite</H5>
<p class="docText">For extremely simple applications, using files for persistent storage usually suffices, but the most complex and data-driven applications demand a full relational database. SQLite targets the intermediate systems and indeed is a hybrid of the two. It is extremely lightweight and fast, plus it is serverless and requires little or no administration.</P>
<p class="docText">SQLite has seen a rapid growth in popularity, and it is available on many platforms. With the introduction of the <tt>pysqlite</tt> database adapter in Python 2.5 as the <tt>sqlite3</tt> module, this marks the first time that the Python standard library has featured a database adapter in any release.</P>

<p class="docText">
<img border="0" alt="" id="195131084199" width="50" height="47" SRC="images/2_5.jpg"></p>


<p class="docText">It was bundled with Python not because it was favored over other databases and adapters, but because it is simple, uses files (or memory) as its backend store like the DBM modules do, does not require a server, and does not have licensing issues. It is simply an alternative to other similar persistent storage solutions included with Python but which happens to have a SQL interface.</p>
<p class="docText">Having a module like this in the standard library allows users to develop rapidly in Python using SQLite, then migrate to a more powerful RDBMS such as MySQL, PostgreSQL, Oracle, or SQL Server for production purposes if this is their intention. Otherwise, it makes a great solution to stay with for those who do not need all that horsepower.</p>
<p class="docText">Although the database adapter is now provided in the standard library, you still have to download the actual database software yourself. However, once you have installed it, all you need to do is start up Python (and import the adapter) to gain immediate access:</P>
<div class="docText"><pre>  &gt;&gt;&gt; <span class="docEmphStrong">import</span> sqlite3
  &gt;&gt;&gt; cxn = sqlite3.connect('sqlite_test/test')
  &gt;&gt;&gt; cur = cxn.cursor()
  &gt;&gt;&gt; cur.execute('CREATE TABLE users(login VARCHAR(8), uid
        INTEGER)')
  &gt;&gt;&gt; cur.execute('INSERT INTO users VALUES("john", 100)')
  &gt;&gt;&gt; cur.execute('INSERT INTO users VALUES("jane", 110)')
  &gt;&gt;&gt; cur.execute('SELECT * FROM users')
  &gt;&gt;&gt; <span class="docEmphStrong">for</span> eachUser <span class="docEmphStrong">in</span> cur.fetchall():
  ...     <span class="docEmphStrong">print</span> eachUser
  ...
  (u'john', 100)
  (u'jane', 110)
  &gt;&gt;&gt; cur.execute('DROP TABLE users')
  &lt;sqlite3.Cursor object at 0x3d4320&gt;
  &gt;&gt;&gt; cur.close()
  &gt;&gt;&gt; cxn.commit()
  &gt;&gt;&gt; cxn.close()</pre></div><br>
<p class="docText">Okay, enough of the small examples. Next, we look at an application similar to our earlier example with MySQL, but which does a few more things:</P>
<ul><LI><p class="docList">Creates a database (if necessary)</p></LI><LI><p class="docList">Creates a table</p></li><li><p class="docList">Inserts rows into the table</p></LI><li><p class="docList">Updates rows in the table</p></LI><li><p class="docList">Deletes rows from the table</p></li><LI><p class="docList">Drops the table</P></li></ul>
<p class="docText">For this example, we will use two other open source databases. SQLite has become quite popular of late. It is very small, lightweight, and extremely fast for all the most common database functions. Another database involved in this example is Gadfly, a mostly SQL-compliant RDBMS written entirely in Python. (Some of the key data structures have a C module available, but Gadfly can run without it [slower, of course].)</p>
<p class="docText">Some notes before we get to the code. Both SQLite and Gadfly require the user to give the location to store database files (while MySQL has a default area and does not require this information from the use). The most <a name="iddle1057"></a><a name="iddle1059"></a><a name="iddle1573"></a><a name="iddle1576"></a><a name="iddle2230"></a><a name="iddle3024"></a>current incarnation of Gadfly is not yet fully DB-API 2.0 compliant, and as a result, is missing some functionality, most notably the cursor attribute <tt>rowcount</tt> in our example.</p>

<a name="ch21lev3sec14"></a>
<h5 id="title-IDANRZBD" class="docSection3Title">Database Adapter Example Application</h5>
<p class="docText">In the example below, we want to demonstrate how to use Python to access a database. In fact, for variety, we added support for three different database systems: Gadfly, SQLite, and MySQL. We are going to create a database (if one does not already exist), then run through various database operations such as creating and dropping tables, and inserting, updating, and deleting rows. <a class="docLink" href="#ch21list01">Example 21.1</a> will be duplicated for the upcoming section on ORMs as well.</p>
<a name="ch21list01"></a><h5 id="title-IDAESZBD" class="docExampleTitle">Example 21.1. Database Adapter Example (<tt>ushuffle_db.py</tt>)</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<p class="docText"><span class="docEmphasis">This script performs some basic operations using a variety of databases (MySQL, SQLite, Gadfly) and a corresponding Python database adapter.</span></P>


<pre>1   #!/usr/bin/env python
2
3   <span class="docEmphStrong">import</span> os
4   <span class="docEmphStrong">from</span> random <span class="docEmphStrong">import</span> randrange <span class="docEmphStrong">as</span> rrange
5
6   COLSIZ = 10
7   RDBMSs = {'s': 'sqlite', 'm': 'mysql', 'g': 'gadfly'}
8   DB_EXC = None
9
10  <span class="docEmphStrong">def</span> setup():
11      <span class="docEmphStrong">return</span> RDBMSs[raw_input('''
12  Choose a database system:
13
14 (M)ySQL
15 (G)adfly
16 (S)QLite
17
18  Enter choice: ''').strip().lower()[0]]
19
20  <span class="docEmphStrong">def</span> connect(db, dbName):
21      <span class="docEmphStrong">global</span> DB_EXC
22      dbDir = '%s_%s' % (db, dbName)
23
24      <span class="docEmphStrong">if</span> db == 'sqlite':
25          <span class="docEmphStrong">try</span>:
26              <span class="docEmphStrong">import</span> sqlite3
27          <span class="docEmphStrong">except</span> ImportError, e:
28               <span class="docEmphStrong">try</span>:
29                   <span class="docEmphStrong">from</span> pysqlite2 <span class="docEmphStrong">import</span> dbapi2 <span class="docEmphStrong">as</span> sqlite3
30               <span class="docEmphStrong">except</span> ImportError, e:
31                   <span class="docEmphStrong">return</span> None
32
33          DB_EXC = sqlite3
34          <span class="docEmphStrong">if not</span> os.path.isdir(dbDir):
35              os.mkdir(dbDir)
36          cxn = sqlite.connect(os.path.join(dbDir, dbName))
37
38      <span class="docEmphStrong">elif</span> db == 'mysql':
39          <span class="docEmphStrong">try</span>:
40               <span class="docEmphStrong">import</span> MySQLdb
41               <span class="docEmphStrong">import</span> _mysql_exceptions <span class="docEmphStrong">as</span> DB_EXC
42          <span class="docEmphStrong">except</span> ImportError, e:
43               <span class="docEmphStrong">return</span> None
44
45          <span class="docEmphStrong">try</span>:
46               cxn = MySQLdb.connect(db=dbName)
47          <span class="docEmphStrong">except</span> _mysql_exceptions.OperationalError, e:
48          cxn = MySQLdb.connect(user='root')
49               <span class="docEmphStrong">try:</span>
50                     cxn.query('DROP DATABASE %s' % dbName)
51               <span class="docEmphStrong">except</span> DB_EXC.OperationalError, e:
52                    <span class="docEmphStrong">pass</span>
53               cxn.query('CREATE DATABASE %s' % dbName)
54               cxn.query("GRANT ALL ON %s.* to ''@'localhost'" % dbName)
55           cxn.commit()
56               cxn.close()
57               cxn = MySQLdb.connect(db=dbName)
58
59      <span class="docEmphStrong">elif</span> db == 'gadfly':
60           <span class="docEmphStrong">try</span>:
61                 <span class="docEmphStrong">from</span> gadfly <span class="docEmphStrong">import</span> gadfly
62                 DB_EXC = gadfly
63           <span class="docEmphStrong">except</span> ImportError, e:
64                 <span class="docEmphStrong">return</span> None
65
66           <span class="docEmphStrong">try</span>:
67                 cxn = gadfly(dbName, dbDir)
68           <span class="docEmphStrong">except</span> IOError, e:
69                 cxn = gadfly()
70                 <span class="docEmphStrong">if not</span> os.path.isdir(dbDir):
71                     os.mkdir(dbDir)
72                 cxn.startup(dbName, dbDir)
73      <span class="docEmphStrong">else</span>:
74           <span class="docEmphStrong">return</span> None
75      <span class="docEmphStrong">return</span> cxn
76
77  <span class="docEmphStrong">def</span> create(cur):
78      <span class="docEmphStrong">try</span>
79          cur.execute('''
80            CREATE TABLE users (
81              login VARCHAR(8),
82              uid INTEGER,
83              prid INTEGER)
84          ''')
85      <span class="docEmphStrong">except</span> DB_EXC.OperationalError, e:
86           drop(cur)
87           create(cur)
88
89   drop = <span class="docEmphStrong">lambda</span> cur: cur.execute('DROP TABLE users')
90
91   NAMES = (
92       ('aaron', 8312), ('angela', 7603), ('dave', 7306),
93       ('davina',7902), ('elliot', 7911), ('ernie', 7410),
94       ('jess', 7912), ('jim', 7512), ('larry', 7311),
95       ('leslie', 7808), ('melissa', 8602), ('pat', 7711),
96       ('serena', 7003), ('stan', 7607), ('faye', 6812),
97       ('amy', 7209),
98   )
99
100  <span class="docEmphStrong">def</span> randName():
101      pick = list(NAMES)
102      <span class="docEmphStrong">while</span> len(pick) &gt; 0:
103          <span class="docEmphStrong">yield</span> pick.pop(rrange(len(pick)))
104
105  <span class="docEmphStrong">def</span> insert(cur, db):
106      <span class="docEmphStrong">if</span> db == 'sqlite':
107          cur.executemany(&quot;INSERT INTO users VALUES(?, ?, ?)&quot;,
108          [(who, uid, rrange(1,5)) <span class="docEmphStrong">for</span> who, uid <span class="docEmphStrong">in</span> randName()])
109      <span class="docEmphStrong">elif</span> db == 'gadfly':
110           <span class="docEmphStrong">for</span> who, uid <span class="docEmphStrong">in</span> randName():
111             cur.execute(&quot;INSERT INTO users VALUES(?, ?, ?)&quot;,
112                (who, uid, rrange(1,5)))
113      <span class="docEmphStrong">elif</span> db == 'mysql':
114           cur.executemany(&quot;INSERT INTO users VALUES(%s, %s, %s)&quot;,
115           [(who, uid, rrange(1,5)) <span class="docEmphStrong">for</span> who, uid <span class="docEmphStrong">in</span> randName()])
116
117  getRC = <span class="docEmphStrong">lambda</span> cur: cur.rowcount <span class="docEmphStrong">if</span> hasattr(cur,
     'rowcount') <span class="docEmphStrong">else</span> -1
118
119  <span class="docEmphStrong">def</span> update(cur):
120      fr = rrange(1,5)
121      to = rrange(1,5)
122      cur.execute(
123          &quot;UPDATE users SET prid=%d WHERE prid=%d&quot; % (to, fr))
124      <span class="docEmphStrong">return</span> fr, to, getRC(cur)
125
126  <span class="docEmphStrong">def</span> delete(cur):
127      rm = rrange(1,5)
128      cur.execute('DELETE FROM users WHERE prid=%d' % rm)
129      <span class="docEmphStrong">return</span> rm, getRC(cur)
130
131  <span class="docEmphStrong">def</span> dbDump(cur):
132      cur.execute('SELECT * FROM users')
133      <span class="docEmphStrong">print</span> '\n%s%s%s' % ('LOGIN'.ljust(COLSIZ),
134          'USERID'.ljust(COLSIZ), 'PROJ#'.ljust(COLSIZ))
135      <span class="docEmphStrong">for</span> data <span class="docEmphStrong">in</span> cur.fetchall():
136           <span class="docEmphStrong">print</span> '%s%s%s' % tuple([str(s).title().ljust(COLSIZ) \
137               <span class="docEmphStrong">for</span> s <span class="docEmphStrong">in</span> data])
138
139  <span class="docEmphStrong">def</span> main():
140      db = setup()
141      <span class="docEmphStrong">print</span> '*** Connecting to %r database' % db
142      cxn = connect(db, 'test')
143      <span class="docEmphStrong">if not</span> cxn:
144           <span class="docEmphStrong">print</span> 'ERROR: %r not supported, exiting' % db
145           <span class="docEmphStrong">return</span>
146      cur = cxn.cursor()
147
148      <span class="docEmphStrong">print</span> '\n*** Creating users table'
149         create(cur)
150
151      <span class="docEmphStrong">print</span> '\n*** Inserting names into table'
152      insert(cur, db)
153      dbDump(cur)
154
155      <span class="docEmphStrong">print</span> '\n*** Randomly moving folks',
156      fr, to, num = update(cur)
157      <span class="docEmphStrong">print</span> 'from one group (%d) to another (%d)' % (fr, to)
158      <span class="docEmphStrong">print</span> '\t(%d users moved)' % num
159      dbDump(cur)
160
161      <span class="docEmphStrong">print</span> '\n*** Randomly choosing group',
162      rm, num = delete(cur)
163      <span class="docEmphStrong">print</span> '(%d) to delete' % rm
164      <span class="docEmphStrong">print</span> '\t(%d users removed)' % num
165      dbDump(cur)
166
167      <span class="docEmphStrong">print</span> '\n*** Dropping users table'
168      drop(cur)
169      cur.close()
170      cxn.commit()
171      cxn.close()
172
173  <span class="docEmphStrong">if</span>__name__ == '__main__':
174     main()</pre><br>

</TD></tr></table></P>

<a name="ch21lev3sec15"></a>
<h5 id="title-IDAGO0BD" class="docSection3Title">Line-by-Line Explanation</H5>
<a name="ch21lev4sec1"></a>
<h5 id="title-IDAPO0BD" class="docSection4Title">Lines 118</H5>
<p class="docText">The first part of this script imports the necessary modules, creates some global &quot;constants&quot; (the column size for display and the set of databases we are supporting), and features the <tt>setup()</tt> function, which prompts the user to select the RDBMS to use for any particular execution of this script.</P>
<p class="docText">The most notable constant here is <tt>DB_EXC</tt>, which stands for DataBase EXCeption. This variable will eventually be assigned the database exception module for the specific database system that the users chooses to use to run this application with. In other words, if users choose MySQL, <tt>DB_EXC</tt> will be <tt>_mysql_exceptions</tt>, etc. If we developed this application in more of an object-oriented fashion, this would simply be an instance attribute, i.e., <tt>self.db_exc_module</tt> or something like that.</P>

<a name="ch21lev4sec2"></a>
<H5 id="title-IDAJP0BD" class="docSection4Title">Lines 2075</h5>
<p class="docText">The guts of consistent database access happens here in the <tt>connect()</tt> function. At the beginning of each section, we attempt to load the requested database modules. If a suitable one is not found, <tt>None</tt> is returned to indicate that the database system is not supported.</p>
<p class="docText">Once a connection is made, then all other code is database and adapter independent and should work across all connections. (The only exception in our script is <tt>insert().)</tt> In all three subsections of this set of code, you will notice that a valid connection should be passed back as <tt>cxn</tt>.</p>
<p class="docText">If SQLite is chosen (lines 24-36), we attempt to load a database adapter. We first try to load the standard library's <tt>sqlite3</tt> module (Python 2.5+). If that fails, we look for the third-party <tt>pysqlite2</tt> package. This is to support 2.4.x and older systems with the pysqlite adapter installed. If a suitable adapter is found, we then check to ensure that the directory exists because the database is file based. (You may also choose to create an in-memory database.) When the <tt>connect()</tt> call is made to SQLite, it will either use one that already exists or make a new one using that path if it does not.</P>
<p class="docText">MySQL (lines 38-57) uses a default area for its database files and does not require this to come from the user. Our code attempts to connect to the specified database. If an error occurs, it could mean either that the database does not exist or that it does exist but we do not have permission to see it. Since this is just a test application, we elect to drop the database altogether (ignoring any error if the database does not exist), and re-create it, granting all permissions after that.</p>
<p class="docText">The last database supported by our application is Gadfly (lines 59-75). (At the time of writing, this database is mostly but not fully DB-API-compliant, and you will see this in this application.) It uses a startup mechanism similar to that of SQLite: it starts up with the directory where the database files should be. If it is there, fine, but if not, you have to take a roundabout way to start up a new database. (Why this is, we are not sure. We believe that the <tt>startup()</tt> functionality should be merged into that of the constructor <tt>gadfly.gadfly().)</tt></P>

<a name="ch21lev4sec3"></a>
<h5 id="title-IDAZQ0BD" class="docSection4Title">Lines 7789</H5>
<p class="docText">The <tt>create()</tt> function creates a new users table in our database. If there is an error, that is almost always because the table already exists. If this is the case, drop the table and re-create it by recursively calling this function again. This code is dangerous in that if the recreation of the table still fails, you will have infinite recursion until your application runs out of memory. You will fix this problem in one of the exercises at the end of the chapter.</p>
<p class="docText">The table is dropped from the database with the one-liner <tt>drop()</tt>.</P>

<a name="ch21lev4sec4"></a>
<H5 id="title-IDANR0BD" class="docSection4Title">Lines 91103</h5>

<p class="docText">This is probably the most interesting part of the code outside of database activity. It consists of a constant set of names and user IDs followed by the generator <tt>randName()</tt> whose code can be found in <a class="docLink" href="ch11.html#ch11">Chapter 11</a> (Functions) in <a class="docLink" href="ch11lev1sec10.html#ch11lev1sec10">Section 11.10</a>. The <tt>NAMES</tt> constant is a tuple that must be converted to a list for use with <tt>randName()</tt> because we alter it in the generator, randomly removing one name at a time until the list is exhausted. Well, if <tt>NAMES</tt> was a list, we would only use it once. Instead, we make it a tuple and copy it to a list to be destroyed each time the generator is used.</p>

<a name="ch21lev4sec5"></a>
<h5 id="title-IDAQS0BD" class="docSection4Title">Lines 105115</h5>
<p class="docText">The <tt>insert()</tt> function is the only other place where database-dependent code lives, and the reason is that each database is slightly different in one way or another. For example, both the adapters for SQLite and MySQL are DB-API-compliant, so both of their cursor objects have an <tt>executemany()</tt> function, whereas Gadfly does not, so rows have to be inserted one at a time.</P>
<p class="docText">Another quirk is that both SQLite and Gadfly use the <tt>qmark</tt> parameter style while MySQL uses <tt>format</tt>. Because of this, the format strings are different. If you look carefully, however, you will see that the arguments themselves are created in a very similar fashion.</p>

<p class="docText">What the code does is this: for each name-userID pair, it assigns that individual to a project group (given by its project ID or <tt>prid)</tt>. The project ID is chosen randomly out of four different groups <tt>(randrange(1,5))</tt>.</p>

<a name="ch21lev4sec6"></a>

<H5 id="title-IDART0BD" class="docSection4Title">Line 117</h5>
<p class="docText">This single line represents a conditional expression (read as: Python ternary operator) that returns the rowcount of the last operation (in terms of rows altered), or if the cursor object does not support this attribute (meaning it is not DB-API-compliant), it returns -1.</p>
<p class="docText">Conditional expressions were added in Python 2.5, so if you are using 2.4.x or older, you will need to convert it back to the &quot;old-style&quot; way of doing it:</p>
<div class="docText"><pre>  getRC = <span class="docEmphStrong">lambda</span> cur: (hasattr(cur, 'rowcount') \
      <span class="docEmphStrong">and</span> [cur.rowcount] <span class="docEmphStrong">or</span> [-1])[0]</pre></div><BR>
<p class="docText">If you are confused by this line of code, don't worry about it. Check the FAQ to see why this is, and get a taste of why conditional expressions were finally added to Python in 2.5. If you <span class="docEmphasis">are</span> able to figure it out, then you have developed a solid understanding of Python objects and their Boolean values.</P>

<p class="docText">
<img border="0" alt="" id="195131084199" width="50" height="47" SRC="images/2_5.jpg"></p>



<a name="ch21lev4sec7"></a>
<h5 id="title-IDAEV0BD" class="docSection4Title">Lines 119129</h5>
<p class="docText">The <tt>update()</tt> and <tt>delete()</tt> functions randomly choose folks from one group. If the operation is update, move them from their current group to another (also randomly chosen); if it is delete, remove them altogether.</p>

<a name="ch21lev4sec8"></a>
<h5 id="title-IDAVV0BD" class="docSection4Title">Lines 131137</h5>
<p class="docText">The <tt>dbDump()</tt> function pulls all rows from the database, formats them for printing, and displays them to the user. The <span class="docEmphStrong"><tt>print</tt></span> statement to display each user is the most obfuscated, so let us take it apart.</p>

<p class="docText">First, you should see that the data were extracted after the SELECT by the <tt>fetchall()</tt> method. So as we iterate each user, take the three columns (<tt>login, uid, prid</tt>), convert them to strings (if they are not already), titlecase it, and format the complete string to be <tt>COLSIZ</tt> columns left-justified (right-hand space padding). Since the code to generate these three strings is a list (via the list comprehension), we need to convert it to a tuple for the format operator ( % ).</p>

<a name="ch21lev4sec9"></a>
<h5 id="title-IDARW0BD" class="docSection4Title">Lines 139174</h5>
<p class="docText">The director of this movie is <tt>main()</tt>. It makes the individual functions to each function described above that defines how this script works (assuming that it does not exit due to either not finding a database adapter or not being able to obtain a connection [lines 143-145]). The bulk of it should be fairly self-explanatory given the proximity of the <span class="docEmphStrong"><tt>print</tt></span> statements. The last bits of <tt>main()</tt> close the cursor, and commit and close the connection. The final lines of the script are the usual to start the script.</p>




</TD></TR></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch21lev1sec1.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch21lev1sec3.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>