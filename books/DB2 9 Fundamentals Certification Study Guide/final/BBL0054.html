<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Locking</title>
<link rel="STYLESHEET" type="text/css" href="images/css1.css">
<link rel="STYLESHEET" type="text/css" href="images/css2.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=BBL0053.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=BBL0055.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<br><div class="chapter">
<a name=""></a>
<div class="section">
<h2 class="first-section-title">
<a name="856"></a><a name="ch07le"></a>Locking</h2>
<p class="first-para">The one thing that all four of the isolation levels available have in common is that they all acquire one or more locks. But just what is a lock? A <i class="emphasis">lock</i> is a mechanism <a name="857"></a><a name=""></a>that is used to associate a data resource with a single transaction, for the sole purpose of controlling how other transactions interact with that resource while it is associated with the transaction that has it locked. (The transaction that has a data resource associated with it is said to "hold" or "own" the lock.) Essentially, locks in a database environment serve the same purpose as they do in a house or a car: They determine who can and cannot gain access to a particular resource-which can be one or more table spaces, tables, and/or rows. The DB2 Database Manager imposes locks to prohibit "owning" transactions from accessing uncommitted data that has been written by other transactions and to prevent other transactions from making data modifications that might adversely affect the owning transaction. When an owning transaction is terminated (by being committed or by being rolled back), any changes made to the resource that was locked are either made permanent or removed, and all locks on the resource that had been acquired by the owning transaction are released. Once unlocked, a resource can be locked again and manipulated by another active transaction. <a class="internaljump" href="#ch0">Figure 7-5</a> illustrates the principles of transaction/resource locking.</p>
<div class="figure">
<a name="858"></a><a name="ch0"></a><span class="figuremediaobject"><a href="images/fig497_01_0.jpg" NAME="IMG_116" target="_parent"><img alt="Image from book" id="IMG_116" src="images/fig497_01.jpg" height="341" width="317" title="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 7-5: </span>How DB2 9 prevents uncontrolled concurrent access to a resource through the use of locks.</span>
</div>
<a name="859"></a><a name=""></a>
<div class="section">
<h3 class="sect3-title">
<a name="860"></a><a name="ch07le"></a>Lock Attributes and Lock States</h3>
<p class="first-para">All locks used by DB2 have the following basic attributes:</p>
<ul class="simple-list">
<li class="first-listitem">
<p class="para">
<b>Object:</b> This attribute identifies the data resource that is being locked. The DB2 Database Manager implicitly acquires locks on data resources (specifically, table spaces, tables, and rows) whenever they are needed.</p>
</li>
<li class="listitem">
<p class="para">
<b>Size:</b> This attribute identifies the physical size of the portion of the data resource that is being locked. A lock does not always have to control an entire data resource. For example, rather than giving an application exclusive control over an entire table, the DB2 Database Manager can elect to give an application exclusive control over one or more specific rows within a table.</p>
</li>
<li class="listitem">
<p class="para">
<b>Duration:</b> This attribute identifies the length of time a lock is held. The isolation level used has a significant impact on the duration of a lock. (For example, the lock acquired for a Repeatable Read transaction that accesses 500 rows is likely to have a long duration if all 500 rows are to be updated; on the other hand, the lock acquired for a Cursor Stability transaction is likely to have a much shorter duration.)</p>
</li>
<li class="listitem">
<p class="para">
<b>State (or Mode):</b> This attribute identifies the type of access allowed for the lock owner, as well as the type of access permitted for concurrent users of the locked data resource. <a class="internaljump" href="#ch07t">Table 7-2</a> shows the various lock states available (along with their effects) in order of increasing control.</p>
</li>
</ul>
<a name="861"></a><a name="ch07t"></a>
<table linktabletoexcel="yes" id="ch07table02" class="table" border="1">
<caption class="table-title">
<span class="table-title"><span class="table-titlelabel">Table 7-2: </span>Lock States</span>
<br>
<a  class="object-link" target="_blank"><IMG HEIGHT="11" BORDER="0" WIDTH="13" SRC="images/b24-bluearrow.gif" ALT=""> Open table as spreadsheet</a>
</caption>
<thead>
<tr valign="top">
<th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Lock State (Mode)</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Applicable Objects</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Lock Owner Access</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Concurrent Transaction Access</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Other Locks Acquired</b>
</p>
</th>
</tr>
</thead>
<tbody>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Intent None (IN)</p>
</td><td class="td" align="left">
<p class="table-para">Table spaces, Tables</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read all data, including uncommitted data, stored in the locked resource; however, lock owner cannot modify data stored in the locked resource.</p>
<p class="table-para">Intent None locks are typically acquired for read-only transactions that have no intention of modifying data (thus, additional locks will not be acquired on the transaction's behalf).</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read and modify data stored in the locked resource, however, they cannot delete data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">None</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Intent Share (IS)</p>
</td><td class="td" align="left">
<p class="table-para">Table spaces, Tables</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read all data (excluding uncommitted data) stored in the locked resource; however, lock owner cannot modify data stored in the locked resource.</p>
<p class="table-para">Intent Share locks are typically acquired for transactions that do not convey the intent to modify data (transactions that execute SELECT FOR UPDATE, UPDATE WHERE, or INSERT statements convey the intent to modify data).</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read and modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">If the lock is held on a table, a Share (S) or a Next Key Share (NS) lock is acquired on each row read from that table.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Next Key Share (NS)</p>
</td><td class="td" align="left">
<p class="table-para">Rows</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read all data (excluding uncommitted data) stored in the locked resource; however, lock owner cannot modify data stored in the locked resource.</p>
<p class="table-para">Next Key Share locks are typically acquired in place of a Share (S) lock for transactions that are running under the Read Stability (RS) or Cursor Stability (CS) isolation level.</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read all data (excluding uncommitted data) stored in the locked resource; however, they cannot modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">None</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Share (S)</p>
</td><td class="td" align="left">
<p class="table-para">Tables, Rows</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read all data (excluding uncommitted data) stored in the locked resource; however, lock owner cannot modify data stored in the locked resource.</p>
<p class="table-para">Share locks are typically acquired for transactions that do not convey the intent to modify data (transactions that execute SELECT FOR UPDATE, UPDATE WHERE, or INSERT statements convey the intent to modify data) that are running under the Repeatable Read (RR) isolation level.</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read all data (excluding uncommitted data) stored in the locked resource; however, they cannot modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">Individual rows in a table can be Share (S) locked, provided the table itself is not Share (S) locked. (If the table is Share (S) locked, row-level locks cannot be acquired.)</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Intent Exclusive (IX)</p>
</td><td class="td" align="left">
<p class="table-para">Table spaces, Tables</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read and modify data stored in the locked resource.</p>
<p class="table-para">Intent Exclusive locks are typically acquired for transactions that convey the intent to modify data (transactions that execute SELECT FOR UPDATE, UPDATE WHERE, or INSERT statements convey the intent to modify data).</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read and modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">When the lock owner works with an Intent Exclusive (IX)-locked table, a Share (S) or a Next Key Share (NS) lock is acquired on every row read from that table, and both an Update (U) and an Exclusive (X) lock is acquired on every row to be modified.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Share With Intent Exclusive (SIX)</p>
</td><td class="td" align="left">
<p class="table-para">Tables</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read and modify data stored in the locked resource.</p>
<p class="table-para">Share With Intent Exclusive locks are typically acquired when a transaction holding a Share (S) lock on a resource attempts to acquire an Intent Exclusive (IX) lock on the same resource (or vice versa).</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read all data (excluding uncommitted data) stored in the locked resource; however, they cannot modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">When the lock owner works with a Share With Intent Exclusive (SIX) locked table, an Exclusive (X) lock is acquired on every row in that table that is to be modified.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Update (U)</p>
</td><td class="td" align="left">
<p class="table-para">Tables, Rows</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can modify all data (excluding uncommitted data) stored in the locked resource; however, lock owner cannot read data stored in the locked resource.</p>
<p class="table-para">Update locks are typically acquired for transactions that modify data with INSERT, UPDATE, or DELETE statements.</p>
</td><td class="td" align="left">
<p class="table-para">Uncommitted data) stored in the locked resource; however, they cannot modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">An Update (U) locked table, an Exclusive (X) lock is acquired on every row to be modified in that table.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Next Key Weak Exclusive (NW)</p>
</td><td class="td" align="left">
<p class="table-para">Rows</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read all data (excluding uncommitted data) stored in the locked resource; however, lock owner cannot modify data stored in the locked resource.</p>
<p class="table-para">Next Key Weak Exclusive locks are typically acquired on the next available row in a table whenever a row is inserted into any index of a noncatalog table.</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can read all data (excluding uncommitted data) stored in the locked resource; however, they cannot modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">None</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Exclusive (X)</p>
</td><td class="td" align="left">
<p class="table-para">Tables, Rows</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read and modify data stored in the locked resource.</p>
<p class="table-para">Exclusive locks are typically acquired for transactions that retrieve data with SELECT statements and then modify the data retrieved with INSERT, UPDATE, or DELETE statements.</p>
</td><td class="td" align="left">
<p class="table-para">Transactions using the Uncommitted Read isolation level can read all data, including uncommitted data, stored in the locked resource; however they cannot modify data stored in the locked resource.</p>
<p class="table-para">All other transactions can neither read, nor modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">Individual rows in a table can be Exclusive (X) locked, provided the table itself is not Exclusive (X) locked.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Weak Exclusive (WE)</p>
</td><td class="td" align="left">
<p class="table-para">Rows</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read and modify data stored in the locked resource.</p>
<p class="table-para">Weak Exclusive locks are typically acquired on a row when it is inserted into a nonsystem catalog table.</p>
</td><td class="td" align="left">
<p class="table-para">Transactions using the Uncommitted Read isolation level can read all data, including uncommitted data, stored in the locked resource; however, they cannot modify data stored in the locked resource.</p>
<p class="table-para">All other transactions can neither read nor modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">None</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Super Exclusive (Z)</p>
</td><td class="td" align="left">
<p class="table-para">Table spaces, Tables</p>
</td><td class="td" align="left">
<p class="table-para">Lock owner can read and modify data stored in the locked resource.</p>
<p class="table-para">Super Exclusive locks are typically acquired on a table whenever the lock owner attempts to alter that table, drop that table, create an index for that table, drop an index that has already been defined for that table, or reorganize the contents of the table (while the table is offline) by running the REORG utility.</p>
</td><td class="td" align="left">
<p class="table-para">Other transactions can neither read nor modify data stored in the locked resource.</p>
</td><td class="td" align="left">
<p class="table-para">None</p>
</td>
</tr>
</tbody>
<tfoot>
<tr valign="">
<td class="td" align="left" colspan="5">
<p class="table-para">Adapted from Table 4 on pages 60&ndash;61 of the <I xmlns:crossref="http://www.jclark.com/xt/java/com.books24x7.xsl.Crossref" class="citetitle">IBM DB2 Version 9 for Linux, UNIX, and Windows Performance Guide</I>.</p>
</td>
</tr>
</tfoot>
</table>
<a name="862"></a><a name=""></a><a name="863"></a><a name="IDX-"></a><a name="864"></a><a name="IDX-"></a><a name="865"></a><a name=""></a>
</div>
<div class="section">
<h3 class="sect3-title">
<a name="866"></a><a name="ch07le"></a>How Locks Are Acquired</h3>
<p class="first-para">Except for occasions where the Uncommitted Read isolation level is used, it is never necessary for a transaction to request a lock explicitly. That's because the DB2 Database Manager implicitly acquires locks as they are needed; once acquired, these locks remain under the DB2 Database Manager's control until they are no longer needed. By default, the DB2 Database Manager always attempts to acquire row-level locks. However, it is possible to control whether the DB2 Database Manager will attempt to acquire row-level locks or table-level locks on a specific table resource by executing a special form of the <span class="fixed">ALTER TABLE</span> SQL statement. The syntax for this form of the <span class="fixed">ALTER TABLE</span> statement is:</p>
<div class="informalexample">
<pre class="literallayout">
ALTER TABLE [<i class="emphasis">TableName</i>] LOCKSIZE [ROW | TABLE]
</pre>
</div>
<p class="para">where:</p>
<div class="informaltable">
<table border="0">
<tbody>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<i class="emphasis">TableName</i>
</p>
</td><td class="td" align="left">
<p class="table-para">Identifies the name of an existing table for which the level of locking that all transactions are to use when accessing it is to be specified.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="para">For example, when executed, the SQL statement</p>
<div class="informalexample">
<pre class="literallayout">
ALTER TABLE employee LOCKSIZE ROW
</pre>
</div>
<p class="para">will force the DB2 Database Manager to acquire row-level locks for every transaction that accesses a table named <span class="fixed">EMPLOYEE</span>. (This is the default behavior.) On the other hand, if the SQL statement</p>
<div class="informalexample">
<pre class="literallayout">
ALTER TABLE employee LOCKSIZE TABLE
</pre>
</div>
<p class="para">is executed, the DB2 Database Manager will attempt to acquire table-level locks for every transaction that accesses the <span class="fixed">EMPLOYEE</span> table.</p>
<p class="para">But what if you don't want every transaction that works with a particular table to acquire table-level locks? What if, instead, you want one specific transaction to acquire table-level locks and all other transactions to acquire row-level locks when working with that particular table? In this case, you leave the default locking behavior alone (row-level locking) and use the <span class="fixed">LOCK TABLE</span> SQL statement to <a name="867"></a><a name=""></a>acquire a table-level lock for the appropriate individual transaction. The syntax for the <span class="fixed">LOCK TABLE</span> statement is:</p>
<div class="informalexample">
<pre class="literallayout">
LOCK TABLE [<i class="emphasis">TableName</i>] IN [SHARE | EXCLUSIVE] MODE
</pre>
</div>
<p class="para">where:</p>
<div class="informaltable">
<table border="0">
<tbody>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<i class="emphasis">TableName</i>
</p>
</td><td class="td" align="left">
<p class="table-para">Identifies the name of an existing table to be locked.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="para">As you can see, the <span class="fixed">LOCK TABLE</span> statement allows a transaction to acquire a table-level lock on a particular table in one of two modes: <span class="fixed">SHARE</span> mode and <span class="fixed">EXCLUSIVE</span> mode. If a table is locked using the <span class="fixed">SHARE</span> mode, a table-level Share (<span class="fixed">S</span>) lock is acquired on behalf of the requesting transaction, and other concurrent transactions are allowed to read, but not change, data stored in the locked table. On the other hand, if a table is locked using the <span class="fixed">EXCLUSIVE</span> mode, a table-level Exclusive (<span class="fixed">X</span>) lock is acquired, and other concurrent transactions can neither access nor modify data stored in the locked table.</p>
<p class="para">For example, if executed, the SQL statement</p>
<div class="informalexample">
<pre class="literallayout">
LOCK TABLE employee IN SHARE MODE
</pre>
</div>
<p class="para">would acquire a table-level Share (<span class="fixed">S</span>) lock on the <span class="fixed">EMPLOYEE</span> table on behalf of the current transaction (provided no other transaction holds a lock on this table), and other concurrent transactions would be allowed to read, but not change, the data stored in the table. On the other hand, if the statement</p>
<div class="informalexample">
<pre class="literallayout">
LOCK TABLE employee IN EXCLUSIVE MODE
</pre>
</div>
<p class="para">were executed, a table-level Exclusive (<span class="fixed">X</span>) lock would be acquired, and no other transaction would be allowed to read or modify data stored in the <span class="fixed">EMPLOYEE</span> table until the owning transaction is terminated.</p>
<div class="section">
<h4 class="sect4-title">
<a name="868"></a><a name="ch07le"></a>Lock Granularity and Concurrency</h4>
<p class="first-para">When it comes to deciding whether to use row-level locks or table-level locks, it is important to keep in mind that any time a transaction holds a lock on a particular resource, other transactions may be denied access to that resource until the owning transaction is terminated. Therefore, row-level locks are usually <a name="869"></a><a name=""></a>better than table-level locks, because they restrict access to a much smaller resource. However, because each lock acquired requires some amount of storage space (to hold) and some degree of processing time (to manage), often there is considerably less overhead involved when a single table-level lock is acquired, rather than several individual row-level locks.</p>
<p class="para">To a certain extent, lock granularity (row-level locking versus table-level locking) can be controlled through the use of the <span class="fixed">ALTER TABLE</span> and <span class="fixed">LOCK TABLE</span> SQL statements-the <span class="fixed">ALTER TABLE</span> statement controls granularity at a global level, while the <span class="fixed">LOCK TABLE</span> statement controls granularity at an individual transaction level. So when is it more desirable to control granularity at the global level rather than at an individual transaction level? It all depends on the situation.</p>
<p class="last-para">Suppose you have a read-only lookup table table that is to be accessed by multiple concurrent transactions. Forcing the DB2 Database Manager to acquire Share (<span class="fixed">S</span>) table-level locks globally for every transaction that attempts to access this table might improve overall performance, since the locking overhead required would be greatly reduced. On the other hand, suppose you have a table that needs to be accessed frequently by read-only transactions and periodically by a single transaction designed to perform basic maintenance. Forcing the DB2 Database Manager to only acquire an Exclusive (<span class="fixed">X</span>) table-level lock at the transaction level whenever the maintenance transaction executes makes more sense than forcing the DB2 Database Manager to acquire Exclusive (<span class="fixed">X</span>) table-level locks globally for every transaction that needs to access the table. If this approach is used, the read-only transactions are locked out of the table only when the maintenance transaction runs; in all other situations, they can access the table concurrently while requiring very little locking overhead.</p>
</div>
</div>
<div class="section">
<h3 class="sect3-title">
<a name="870"></a><a name="ch07le"></a>Which Locks Are Acquired?</h3>
<p class="first-para">Although it is possible to control whether the DB2 Database Manager will acquire row-level locks or table-level locks, it is not possible to control what type of lock will actually be acquired for a given transaction. Instead, the DB2 Database Manager implicitly makes that decision by analyzing the transaction to determine what type of processing it has been designed to perform. For the purpose of deciding which particular type of lock is needed for a given situation, the DB2 Database Manager places all transactions into one of the following categories:</p>
<a name="871"></a><a name=""></a>
<ul class="itemizedlist">
<li class="first-listitem">
<p class="first-para">Read-Only</p>
</li>
<li class="listitem">
<p class="first-para">Intent-to-Change</p>
</li>
<li class="listitem">
<p class="first-para">Change</p>
</li>
<li class="listitem">
<p class="first-para">Cursor-Controlled</p>
</li>
</ul>
<p class="para">The characteristics used to assign transactions to these categories, along with the types of locks that are acquired for each, are shown in <a class="internaljump" href="#ch07t">Table 7-3</a>.</p>
<a name="872"></a><a name="ch07t"></a>
<table linktabletoexcel="yes" id="ch07table03" class="table" border="1">
<caption class="table-title">
<span class="table-title"><span class="table-titlelabel">Table 7-3: </span>Types of Transactions Available and Their Associated Locks</span>
<br>
<a  class="object-link" target="_blank"><IMG HEIGHT="11" BORDER="0" WIDTH="13" SRC="images/b24-bluearrow.gif" ALT=""> Open table as spreadsheet</a>
</caption>
<thead>
<tr valign="top">
<th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Type Of Transaction <span class="unicode">&hellip;</span></b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Description<span class="unicode">&hellip;</span></b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Locks Acquired <span class="unicode">&hellip;</span></b>
</p>
</th>
</tr>
</thead>
<tbody>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Read-Only</p>
</td><td class="td" align="left">
<p class="table-para">Transactions that contain SELECT SQL statements (which are intrinsically read-only), SELECT SQL statements that have the FOR READ ONLY clause specified, or SQL statements that are ambiguous, but are presumed to be read-only because of the BLOCKING option specified as part of the precompile and/or bind process</p>
</td><td class="td" align="left">
<p class="table-para">Intent Share (IS) and/or Share (S) locks for table spaces, tables, and rows</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Intent-to-Change</p>
</td><td class="td" align="left">
<p class="table-para">Transactions that contain SELECT SQL statements that have the FOR UPDATE clause specified or SQL statements that are ambiguous, but are presumed to be intended for change because of the way they are interpreted by the SQL precompiler</p>
</td><td class="td" align="left">
<p class="table-para">Share (S), Update (U), and Exclusive (X) locks for tables; Update (U), Intent Exclusive (IX), and Exclusive (X) locks for rows</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Change</p>
</td><td class="td" align="left">
<p class="table-para">Transactions that contain INSERT, UPDATE, or DELETE SQL statements but not UPDATE WHERE CURRENT OF or DELETE WHERE CURRENT OF SQL statements</p>
</td><td class="td" align="left">
<p class="table-para">Intent Exclusive (IX) and/or Exclusive (X) locks for table spaces, tables, and rows</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">Cursor-Controlled</p>
</td><td class="td" align="left">
<p class="table-para">Transactions that contain UPDATE WHERE CURRENT OF or DELETE WHERE CURRENT OF SQL statements</p>
</td><td class="td" align="left">
<p class="table-para">Intent Exclusive (IX) and/or Exclusive (X) locks for table spaces, tables, and rows</p>
</td>
</tr>
</tbody>
</table>
<p class="last-para">It is important to keep in mind that in some cases, a single transaction will consist of multiple transaction types. For example, a transaction that contains an SQL statement that performs an insert operation against a table using the results of a subquery actually does two different types of processing: Read-Only and Change. Because of this, locks needed for the resources referenced in the subquery are <a name="873"></a><a name=""></a>determined using the rules for Read-Only transactions, while the locks needed for the target table of the insert operation are determined using the rules for Change transactions.</p>
</div>
<div class="section">
<h3 class="sect3-title">
<a name="874"></a><a name="ch07lev"></a>Locks and Performance</h3>
<p class="first-para">Although the DB2 Database Manager implicitly acquires locks as they are needed and, aside from using the <span class="fixed">ALTER TABLE</span> and <span class="fixed">LOCK TABLE</span> SQL statements to force the DB2 Database Manager to acquire table-level locks, locking is out of your control, there are several factors that can influence how locking affects performance. These factors include:</p>
<ul class="itemizedlist">
<li class="first-listitem">
<p class="first-para">Lock compatibility</p>
</li>
<li class="listitem">
<p class="first-para">Lock conversion</p>
</li>
<li class="listitem">
<p class="first-para">Lock escalation</p>
</li>
<li class="listitem">
<p class="first-para">Lock waits and timeouts</p>
</li>
<li class="listitem">
<p class="first-para">Deadlocks</p>
</li>
<li class="listitem">
<p class="first-para">Concurrency and granularity</p>
</li>
</ul>
<p class="para">Knowing what these factors are and understanding how they can affect overall performance can assist you in designing database applications that work well in multi-user database environments and, indirectly, give you more control over how locks are used.</p>
<div class="section">
<h4 class="sect4-title">
<a name="875"></a><a name="ch07le"></a>Lock Compatibility</h4>
<p class="first-para">If the state of a lock placed on a data resource by one transaction is such that another lock can be placed on the same resource by another transaction before the first lock acquired is released, the locks are said to be <i class="emphasis">compatible</i>. Any time one transaction holds a lock on a data resource and another transaction attempts to acquire a lock on the same resource, the DB2 Database Manager will examine each lock's state and determine whether they are compatible. <a class="internaljump" href="#ch07t">Table 7-4</a> contains a lock compatibility matrix that identifies which locks are compatible and which are not.</p>
<a name="876"></a><a name="ch07t"></a>
<table linktabletoexcel="yes" id="ch07table04" class="table" border="1">
<caption class="table-title">
<span class="table-title"><span class="table-titlelabel">Table 7-4: </span>Lock Compatibility Matrix</span>
<br>
<a  class="object-link" target="_blank"><IMG HEIGHT="11" BORDER="0" WIDTH="13" SRC="images/b24-bluearrow.gif" ALT=""> Open table as spreadsheet</a>
</caption>
<thead>
<tr valign="top">
<th class="th" scope="col" align="left" valign="top" colspan="2">&nbsp;</th><th class="th" scope="col" align="left" valign="top" colspan="11">
<p class="table-para">
<b class="bold">Lock Requested by Second Transaction</b>
</p>
</th>
</tr>
<tr valign="top">
<th class="th" scope="col" align="left">&nbsp;</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Lock State</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">IN</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">IS</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">NS</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">S</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">IX</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">SIX</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">U</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">NW</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">X</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">WE</b>
</p>
</th><th class="th" scope="col" align="left">
<p class="table-para">
<b class="bold">Z</b>
</p>
</th>
</tr>
</thead>
<tbody>
<tr valign="top">
<td class="td" rowspan="11" align="left">
<p class="table-para">
<b class="bold">Lock Held by First Transaction</b>
</p>
</td><td class="td" align="left">
<p class="table-para">
<b class="bold">IN</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">IS</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">NS</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">S</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">IX</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">SIX</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">U</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">NW</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">X</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">WE</b>
</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">
<b class="bold">Z</b>
</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">o</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left">
<p class="table-para">No</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">&nbsp;</td><td class="td" align="left">&nbsp;</td><td class="td" align="left">
<p class="table-para">Yes</p>
</td><td class="td" align="left" valign="top" colspan="10">
<p class="table-para">Locks are compatible; therefore, the lock request is granted immediately.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">&nbsp;</td><td class="td" align="left">&nbsp;</td><td class="td" align="left">
<p class="table-para">No</p>
</td><td class="td" align="left" valign="top" colspan="10">
<p class="table-para">Locks are not compatible; therefore, the requesting transaction must wait for the held lock to be released or for a lock timeout to occur before the lock request can be granted.</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">&nbsp;</td><td class="td" align="left">&nbsp;</td><td class="td" align="left" valign="top" colspan="11">
<p class="table-para">
<b class="bold">Lock States:</b>
</p>
</td>
</tr>
<tr valign="top">
<td class="td" rowspan="6" align="left">&nbsp;</td><td class="td" rowspan="6" align="left">&nbsp;</td><td class="td" align="left">
<p class="table-para">IN</p>
</td><td class="td" align="left" valign="top" colspan="5">
<p class="table-para">Intent None</p>
</td><td class="td" align="left">
<p class="table-para">U</p>
</td><td class="td" align="left" valign="top" colspan="4">
<p class="table-para">Update</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">IS</p>
</td><td class="td" align="left" valign="top" colspan="5">
<p class="table-para">Intent Share</p>
</td><td class="td" align="left">
<p class="table-para">NW</p>
</td><td class="td" align="left" valign="top" colspan="4">
<p class="table-para">Next Key Weak Exclusive</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">NS</p>
</td><td class="td" align="left" valign="top" colspan="5">
<p class="table-para">Next Key Share</p>
</td><td class="td" align="left">
<p class="table-para">X</p>
</td><td class="td" align="left" valign="top" colspan="4">
<p class="table-para">Exclusive</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">S</p>
</td><td class="td" align="left" valign="top" colspan="5">
<p class="table-para">Share</p>
</td><td class="td" align="left">
<p class="table-para">WE</p>
</td><td class="td" align="left" valign="top" colspan="4">
<p class="table-para">Weak Exclusive</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">IX</p>
</td><td class="td" align="left" valign="top" colspan="5">
<p class="table-para">Intent Exclusive</p>
</td><td class="td" align="left">
<p class="table-para">Z</p>
</td><td class="td" align="left" valign="top" colspan="4">
<p class="table-para">Super Exclusive</p>
</td>
</tr>
<tr valign="top">
<td class="td" align="left">
<p class="table-para">SIX</p>
</td><td class="td" align="left" valign="top" colspan="5">
<p class="table-para">Share With Intent Exclusive</p>
</td><td class="td" align="left">&nbsp;</td><td class="td" align="left" valign="top" colspan="4">&nbsp;</td>
</tr>
</tbody>
<tfoot>
<tr valign="">
<td class="td" align="left" colspan="13">
<p class="table-para">Adapted from Table 5 on page 72 of the <I xmlns:crossref="http://www.jclark.com/xt/java/com.books24x7.xsl.Crossref" class="citetitle">IBM DB2 Version 9 for Linux, UNIX, and Windows Performance Guide</I>.</p>
</td>
</tr>
</tfoot>
</table>
<a name="877"></a><a name="IDX-"></a><a name="878"></a><a name=""></a>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="879"></a><a name="ch07le"></a>Lock Conversion</h4>
<p class="first-para">If a transaction holding a lock on a resource needs to acquire a more restrictive lock on the same resource, the DB2 Database Manager will attempt to change the state of the existing lock to the more restrictive state. The action of changing the state of an existing lock to a more restrictive state is known as <i class="emphasis">lock conversion</i>. Lock conversion occurs because a transaction can hold only one lock on a specific data resource at any given time. <a class="internaljump" href="#ch0">Figure 7-6</a> illustrates a simple lock conversion process.</p>
<div class="figure">
<a name="880"></a><a name="ch0"></a><span class="figuremediaobject"><a href="images/fig508_01_0.jpg" NAME="IMG_117" target="_parent"><img alt="Image from book" id="IMG_117" src="images/fig508_01.jpg" height="327" width="296" title="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 7-6: </span>A simple lock conversion scenario-in this example, a Share (S) lock is converted to an Exclusive (X) lock.</span>
</div>
<p class="para">In most cases, lock conversion is performed on row-level locks, and the conversion process is fairly straightforward. For example, if an Update (<span class="fixed">U</span>) lock is held and an Exclusive (<span class="fixed">X</span>) lock is needed, the Update (<span class="fixed">U</span>) lock will be converted to an Exclusive (<span class="fixed">X</span>) lock. However, Share (<span class="fixed">S</span>) locks and Intent Exclusive (<span class="fixed">IX</span>) locks are special cases, since neither lock is considered more restrictive than the other.</p>
<a name="881"></a><a name=""></a>
<p class="last-para">As a result, if one of these locks is held and the other is requested, the held lock is converted to a Share With Intent Exclusive (<span class="fixed">SIX</span>) lock. With all other conversions, the lock state of the current lock is changed to the lock state being requested-provided the lock state being requested is a more restrictive state. (Lock conversion only occurs if the lock held can increase its restriction.) Once a lock has been converted, it stays at the highest level attained until the transaction holding the lock is terminated and the lock is released.</p>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="882"></a><a name="ch07le"></a>Lock Escalation</h4>
<p class="first-para">When a connection to a database is first established, a specific amount of memory is set aside to hold a structure that DB2 uses to manage locks. This structure, known as the <i class="emphasis">lock list</i>, is where the locks held by every application concurrently connected to a database are stored after they are acquired. (The actual amount of memory that gets set aside for the lock list is determined by the <span class="fixed">locklist</span> database configuration parameter.)</p>
<p class="para">Because a limited amount of memory is available, and because this memory must be shared by everyone, the DB2 Database Manager imposes a limit on the amount of space each transaction is allowed to use in the lock list to store its own locks. (This limit is determined by the <span class="fixed">maxlocks</span> database configuration parameter). To prevent a specific database agent from exceeding its lock list space limitations, a process known as <i class="emphasis">lock escalation</i> is performed whenever too many locks (regardless of their type) have been acquired on behalf of a single transaction. During lock escalation, space in the lock list is freed by converting several row-level locks into a single table-level lock. <a class="internaljump" href="#ch0">Figure 7-7</a> illustrates a simple lock escalation process.</p>
<div class="figure">
<a name="883"></a><a name="ch0"></a><span class="figuremediaobject"><a href="images/fig510_01_0.jpg" NAME="IMG_118" target="_parent"><img alt="Image from book" id="IMG_118" src="images/fig510_01.jpg" height="299" width="244" title="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 7-7: </span>Lock escalation-several individual row-level locks are changed to a single table-level lock.</span>
</div>
<a name="884"></a><a name=""></a>
<p class="para">So just how does lock escalation work? When a transaction requests a lock and the database's lock list is full, one of the tables associated with the transaction is selected, a table-level lock is acquired on behalf of the transaction, and all row-level locks for that table are released to create space in the lock list. The table-level lock acquired is then added to the lock list. If this process does not free up the storage space needed to acquire the lock that was requested, another table is selected and the process is repeated until enough free space is made available-only then will the requested lock be acquired and the transaction be allowed to continue execution. If however, the lock list space needed is still unavailable after all of the transaction's row-level locks have been escalated, an SQL error code is generated, all changes that have been made to the database since the transaction was initiated are rolled back, and the transaction is gracefully terminated.</p>
<table border="0" cellspacing="0" cellpadding="0" class="tip">
<tr>
<td valign="top" class="admon-check"></td><td valign="top" class="admon-title">Tip&nbsp;</td><td valign="top" class="admon-body">
<p class="first-para">Use of the <span class="fixed">ALTER TABLE SQL</span> statement or the <span class="fixed">LOCK TABLE</span> SQL statement does not prevent normal lock escalation from occurring. However, it may reduce the frequency with which lock escalations take place.</p>
</td>
</tr>
</table>
<a name="885"></a><a name=""></a>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="886"></a><a name="ch07le"></a>Lock Waits and Timeouts</h4>
<p class="first-para">Any time a transaction holds a lock on a particular resource (table space, table, or row), other transactions may be denied access to that resource until the owning transaction terminates and frees all locks it has acquired. Thus, without some sort of lock timeout detection mechanism in place, a transaction might wait indefinitely for a lock to be released. For example, suppose a transaction in one user's application is waiting for a lock being held by a transaction in another user's application to be released. If the other user leaves his or her workstation without performing some interaction that will allow the application to terminate and release all locks held, the application waiting for the lock to be released will be unable to continue processing for an indeterminable amount of time. Unfortunately, it would also be impossible to terminate the application waiting for the lock to be released without compromising data consistency.</p>
<p class="para">To prevent situations like these from occurring, an important feature known as <i class="emphasis">lock timeout detection</i> has been incorporated into the DB2 Database Manager. When used, this feature prevents applications from waiting indefinitely for a lock to be released. By assigning a value to the <span class="fixed">locktimeout</span> configuration parameter in the appropriate database configuration file, you can control when lock timeout detection occurs. This parameter specifies the amount of time that any transaction will wait to obtain a requested lock; if the requested lock is not acquired before the time interval specified in the <span class="fixed">locktimeout</span> configuration parameter has elapsed, the waiting application receives an error message, and the transaction requesting the lock is rolled back. Once the transaction has been rolled back, the waiting application will, by default, be terminated. (This behavior prevents data inconsistency from occurring.)</p>
<table border="0" cellspacing="0" cellpadding="0" class="tip">
<tr>
<td valign="top" class="admon-check"></td><td valign="top" class="admon-title">Tip&nbsp;</td><td valign="top" class="admon-body">
<p class="first-para">By default, the <span class="fixed">locktimeout</span> configuration is set to -1, which means that applications will wait indefinitely to acquire the locks they need. In many cases, this value should be changed to something other than the default value. In addition, applications should be written such that they capture any timeout (or deadlock) SQL return code returned by the DB2 Database Manager and respond appropriately.</p>
</td>
</tr>
</table>
<a name="887"></a><a name=""></a>
</div>
<div class="section">
<h4 class="sect4-title">
<a name="888"></a><a name="ch07le"></a>Deadlocks</h4>
<p class="first-para">In most cases, the problem of one transaction waiting indefinitely for a lock to be released can be resolved by establishing lock timeouts. However, that is not the case when lock contention creates a situation known as a <i class="emphasis">deadlock</i>. The best way to illustrate how a deadlock can occur is by example: Suppose Transaction 1 acquires an Exclusive (<span class="fixed">X</span>) lock on Table A, and Transaction 2 acquires an Exclusive (<span class="fixed">X</span>) lock on Table B. Now, suppose Transaction 1 attempts to acquire an Exclusive (<span class="fixed">X</span>) lock on Table B, and Transaction 2 attempts to acquire an Exclusive (<span class="fixed">X</span>) lock on Table A. We have already seen that processing by both transactions will be suspended until their second lock request is granted. However, because neither lock request can be granted until one of the owning transactions releases the lock it currently holds (by performing a commit or rollback operation), and because neither transaction can perform a commit or rollback operation because they both have been suspended (and are waiting on locks), a deadlock has occurred. <a class="internaljump" href="#ch0">Figure 7-8</a> illustrates this deadlock scenario.</p>
<div class="figure">
<a name="889"></a><a name="ch0"></a><span class="figuremediaobject"><a href="images/fig512_01_0.jpg" NAME="IMG_119" target="_parent"><img alt="Image from book" id="IMG_119" src="images/fig512_01.jpg" height="303" width="350" title="Click To expand" border="0"></a></span>
<br style="line-height: 1">
<span class="figure-title"><span class="figure-titlelabel">Figure 7-8: </span>A deadlock scenario-Transaction 1 is waiting for Transaction 2 to release its lock on Table B, and Transaction 2 is waiting for Transaction 1 to release its lock on Table A; however, neither transaction can release their respective locks because they have been suspended and are waiting to acquire other locks.</span>
</div>
<a name="890"></a><a name=""></a>
<p class="para">A deadlock is more precisely referred to as a <i class="emphasis">deadlock cycle,</i> because the transactions involved form a circle of wait states; each transaction in the circle waits for a lock held by another transaction in the circle to be released (see <a class="internaljump" href="#ch0">Figure 7-8</a>). When a deadlock cycle occurs, all transactions involved will wait indefinitely for a lock to be released unless some outside agent steps in and breaks the cycle. With DB2, this agent is a background process, known as the <i class="emphasis">deadlock</i> <i class="emphasis">detector</i>, and its sole responsibility is to locate and resolve any deadlocks found in the locking subsystem.</p>
<p class="para">Each database has its own deadlock detector, which is activated as part of the database initialization process. Once activated, the deadlock detector stays "asleep" most of the time but "wakes up" at preset intervals and examines the locking subsystem to determine whether a deadlock situation exists. Normally, the deadlock detector wakes up, sees that there are no deadlocks in the locking subsystem, and goes back to sleep. If, however, the deadlock detector discovers a deadlock cycle, it randomly selects one of the transactions involved to roll back and terminate; the transaction chosen (referred to as the <i class="emphasis">victim process</i>) is then sent an SQL error code, and every lock it had acquired is released. The remaining transaction(s) can then proceed, because the deadlock cycle has been broken. It is possible, but very unlikely, that more than one deadlock cycle exists in a database's locking subsystem. If several deadlock cycles exist, the detector locates each one and terminates one of the offending transactions in the same manner, until all deadlock cycles have been broken. Eventually, the deadlock detector goes back to sleep, only to wake up again at the next predefined interval and repeat the process.</p>
<p class="last-para">While most deadlock cycles involve two or more resources, a special type of deadlock, known as a <i class="emphasis">conversion deadlock</i>, can occur on one individual resource. Conversion deadlocks occur when two or more transactions that already hold compatible locks on an object request new, incompatible locks on that same object. This typically takes place when two or more concurrent transactions search for rows in a table by performing an index scan, and then try to modify one or more of the rows retrieved.</p>
</div>
</div>
</div>
</div>
</div>
</DIV>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=BBL0053.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=BBL0055.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>