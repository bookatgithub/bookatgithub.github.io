<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Varying-List SELECT</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch12lev1sec6.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch13.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch12lev1sec7"></A><H3 class="docSection1Title">Varying-List <TT>SELECT</TT></H3>
<P class="docText">Varying-list <TT>SELECT</TT> is the last class of dynamic SQL. You use it to explicitly prepare and execute SQL <TT>SELECT</TT> statements when you do not know in advance which columns will be retrieved by an application program.<A NAME="ch12index197"></A><A NAME="ch12index198"></A><A NAME="ch12index199"></A><A NAME="ch12index200"></A><A NAME="ch12index201"></A></P>
<P class="docText">Varying-list <TT>SELECT</TT> provides the most flexibility for dynamic <TT>SELECT</TT> statements. You can change tables, columns, and predicates "on-the-fly."</P>
<A NAME="ch12note06"></A><div class="docNote"><p class="docNoteTitle">WARNING</p>

<P class="docText">Because everything about the query can change during one invocation of the program, the number and type of host variables needed to store the retrieved rows cannot be known beforehand. The lack of knowledge regarding what is being retrieved adds considerable complexity to your application programs. (Note that FORTRAN and VS/COBOL programs cannot perform varying-list <TT>SELECT</TT> dynamic SQL statements.)</P></div><br>
<P class="docText">The <TT>SQLDA</TT>, as I mentioned, is the vehicle for communicating information about dynamic SQL between DB2 and the application program. It contains information about the type of SQL statement to be executed, the data type of each column accessed, and the address of each host variable needed to retrieve the columns. The <TT>SQLDA</TT> must be hard-coded into the COBOL II program's <TT>WORKING-STORAGE</TT> area, as shown here:<A NAME="ch12index202"></A><A NAME="ch12index203"></A><A NAME="ch12index204"></A><A NAME="ch12index205"></A></P>
<pre>

</pre><BR><pre>
EXEC-SQL
    INCLUDE SQLDA
END_EXEC.
</pre><BR>
<P class="docText"><A class="docLink" HREF="#ch12table01">Table 12.1</A> defines each item in the <TT>SQLDA</TT> when it is used with varying-list <TT>SELECT</TT>.</P>
<A NAME="ch12table01"></A><P><TABLE CELLSPACING="0" FRAME="hsides" RULES="groups" CELLPADDING="5"><CAPTION><h5 class="docTableTitle">Table 12.1. <TT>SQLDA</TT> Data Element Definitions</h5></CAPTION><COLGROUP><COL width="275"><COL width="275"></COLGROUP><THEAD><TR><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><TT>SQLDA</TT> <span class="docEmphStrong">Field Name</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Use in</span> <TT>DESCRIBE</TT> <span class="docEmphStrong">or</span> <TT>PREPARE</TT> <span class="docEmphStrong">Statement</span></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLDAID</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Descriptive only; usually set to the literal <TT>"SQLDA"</TT> to aid in program debugging</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLDABC</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Length of the <TT>SQLDA</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLN</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of occurrences of <TT>SQLVAR</TT> available</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLD</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of occurrences of <TT>SQLVAR</TT> used</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLTYPE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Data type and indicator of whether <TT>NULL</TT>s are allowed for the column; for UDTs, <TT>SQLTYPE</TT> is set based on the base data type</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLLEN</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">External length of the column value; <TT>0</TT> for LOBs</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLDATA</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Address of a host variable for a specific column</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLIND</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Address of <TT>NULL</TT> indicator variable for the preceding host variable</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SQLNAME</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Name or label of the column<A NAME="ch12index206"></A><A NAME="ch12index207"></A><A NAME="ch12index208"></A><A NAME="ch12index209"></A></P></TD></TR></TABLE></P><br>
<P class="docText">The steps needed to code varying-list <TT>SELECT</TT> dynamic SQL to your application program vary according to the amount of information known about the SQL beforehand. <A class="docLink" HREF="#ch12list05">Listing 12.5</A> details the steps necessary when you know that the statement to be executed is a <TT>SELECT</TT> statement. The code differs from fixed-list <TT>SELECT</TT> in three ways: The <TT>PREPARE</TT> statement uses the <TT>SQLDA</TT>, the <TT>FETCH</TT> statement uses the <TT>SQLDA</TT>, and a step is added to store host variable addresses in the <TT>SQLDA</TT>.<A NAME="ch12index210"></A><A NAME="ch12index211"></A><A NAME="ch12index212"></A><A NAME="ch12index213"></A><A NAME="ch12index214"></A></P>
<A NAME="ch12list05"></A><H5 class="docExampleTitle">Listing 12.5. Varying-List <TT>SELECT</TT> Dynamic SQL</H5><A NAME="ch12index215"></A><A NAME="ch12index216"></A><A NAME="ch12index217"></A><A NAME="ch12index218"></A>

<PRE>
SQL to execute: SELECT PROJNO, PROJNAME, RESPEMP
                FROM DSN8810.PROJ
                WHERE PROJNO = 'A00'
                AND PRSTDATE = '1988-10-10';
<span class="docEmphasis">Move the "SQL to execute" to STRING-VARIABLE</span>
EXEC SQL DECLARE CSR3 CURSOR FOR VLSQL;
EXEC SQL
    PREPARE VLSQL INTO SQLDA FROM :STRING-VARIABLE;
EXEC SQL OPEN CSR3;
<span class="docEmphasis">Load storage addresses into the SQLDA</span>
<span class="docEmphasis">Loop until no more rows to FETCH</span>
    EXEC SQL FETCH CSR3 USING DESCRIPTOR SQLDA;
EXEC SQL CLOSE CSR3;
</PRE><BR>

<P class="docText">When <TT>PREPARE</TT> is executed, DB2 returns information about the columns being returned by the <TT>SELECT</TT> statement. This information is in the <TT>SQLVAR</TT> group item of the <TT>SQLDA</TT>. Of particular interest is the <TT>SQLTYPE</TT> field. For each column to be returned, this field indicates the data type and whether <TT>NULL</TT>s are permitted. Note that in the <TT>SQLDA</TT> layout presented previously, all possible values for <TT>SQLTYPE</TT> are coded as 88-level COBOL structures. They can be used in the logic of your application program to test for specific data types. The valid values for <TT>SQLTYPE</TT> are shown in <A class="docLink" HREF="#ch12table02">Table 12.2</A>.<A NAME="ch12index219"></A><A NAME="ch12index220"></A><A NAME="ch12index221"></A><A NAME="ch12index222"></A><A NAME="ch12index223"></A><A NAME="ch12index224"></A></P>
<A NAME="ch12table02"></A><P><TABLE CELLSPACING="0" FRAME="hsides" RULES="groups" CELLPADDING="5"><CAPTION><h5 class="docTableTitle">Table 12.2. Valid Values for <TT>SQLTYPE</TT></h5></CAPTION><COLGROUP><COL width="183.33333333333331"><COL width="183.33333333333331"><COL width="183.33333333333331"></COLGROUP><THEAD><TR><TH class="thead" align="left" valign="top" colspan="3"><P class="docText"><TT>SQLTYPE</TT> <span class="docEmphStrong">Value</span></P></TH></TR><TR><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><TT>NULL</TT> <span class="docEmphStrong">Allowed</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><TT>NULL</TT> <span class="docEmphStrong">Not Allowed</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Data Type</span></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>384</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>385</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>DATE</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>388</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>389</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>TIME</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>392</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>393</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>TIMESTAMP</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>400</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>401</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">null-terminated graphic string</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>404</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>405</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>BLOB</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>408</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>409</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CLOB</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>412</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>413</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>DBCLOB</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>448</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>449</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Small <TT>VARCHAR</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>452</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>453</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Fixed <TT>CHAR</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>456</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>457</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Long <TT>VARCHAR</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>460</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>461</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>VARCHAR</TT> optionally null-terminated</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>464</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>465</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Small <TT>VARGRAPHIC</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>468</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>469</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Fixed <TT>GRAPHIC</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>472</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>473</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Long <TT>VARGRAPHIC</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>480</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>481</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>FLOAT</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>484</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>485</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>DECIMAL</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>496</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>497</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>INTEGER</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>500</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>501</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SMALLINT</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>904</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>905</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>ROWID</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>961</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>962</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>BLOB</TT> locator</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>964</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>965</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CLOB</TT> locator</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>968</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>969</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>DBCLOB</TT> locator</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>972</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>973</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">result set locator</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>976</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>977</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">table locator</P></TD></TR></TABLE></P><br>
<P class="docText">The first value listed is returned when <TT>NULL</TT>s are permitted; the second is returned when <TT>NULL</TT>s are not permitted. These two codes aid in the detection of the data type for each column. The application program issuing the dynamic SQL must interrogate the <TT>SQLDA</TT>, analyzing each occurrence of <TT>SQLVAR</TT>. This information is used to determine the address of a storage area of the proper size to accommodate each column returned. The address is stored in the <TT>SQLDATA</TT> field of the <TT>SQLDA</TT>. If the column can be <TT>NULL</TT>, the address of the <TT>NULL</TT> indicator is stored in the <TT>SQLIND</TT> field of the <TT>SQLDA</TT>. When this analysis is complete, data can be fetched using varying-list <TT>SELECT</TT> and the <TT>SQLDA</TT> information.<A NAME="ch12index225"></A><A NAME="ch12index226"></A><A NAME="ch12index227"></A><A NAME="ch12index228"></A><A NAME="ch12index229"></A></P>
<P class="docText">Note that the group item, <TT>SQLVAR</TT>, occurs 750 times. This number is the limit for the number of columns that can be returned by one SQL <TT>SELECT</TT>. You can modify the column limit number by changing the value of the <TT>SQLN</TT> field to a smaller number but not to a larger one. Coding a smaller number reduces the amount of storage required. If a greater number of columns is returned by the dynamic <TT>SELECT</TT>, the <TT>SQLVAR</TT> fields are not populated.</P>
<P class="docText">You can also code dynamic SQL without knowing anything about the statement to be executed. An example is a program that must read SQL statements from a terminal and execute them regardless of statement type. You can create this type of program by coding two <TT>SQLDA</TT>s: one full <TT>SQLDA</TT> and one minimal <TT>SQLDA</TT> (containing only the first 16 bytes of the full <TT>SQLDA</TT>) that <TT>PREPARE</TT>s the statement and determines whether it is a <TT>SELECT</TT>. If the statement is not a <TT>SELECT</TT>, you can simply <TT>EXECUTE</TT> the non-<TT>SELECT</TT> statement. If it is a <TT>SELECT</TT>, <TT>PREPARE</TT> it a second time with a full <TT>SQLDA</TT> and follow the steps in <A class="docLink" HREF="#ch12list06">Listing 12.6</A>.<A NAME="ch12index230"></A><A NAME="ch12index231"></A><A NAME="ch12index232"></A><A NAME="ch12index233"></A><A NAME="ch12index234"></A><A NAME="ch12index235"></A><A NAME="ch12index236"></A><A NAME="ch12index237"></A><A NAME="ch12index238"></A><A NAME="ch12index239"></A><A NAME="ch12index240"></A></P>
<A NAME="ch12list06"></A><H5 class="docExampleTitle">Listing 12.6. Varying-List <TT>SELECT</TT> Dynamic SQL with Minimum <TT>SQLDA</TT></H5>

<PRE>
EXEC SQL INCLUDE SQLDA
EXEC SQL INCLUDE MINSQLDA
<span class="docEmphasis">Read "SQL to execute" from external source</span>
<span class="docEmphasis">Move the "SQL to execute" to STRING-VARIABLE</span>
EXEC SQL DECLARE CSR3 CURSOR FOR VLSQL;
EXEC SQL
    PREPARE VLSQL INTO MINSQLDA FROM :STRING-VARIABLE;
IF SQLD IN MINSQLDA = 0
    EXECUTE IMMEDIATE <span class="docEmphasis">(SQL statement was not a SELECT)</span>
    FINISHED.
EXEC SQL
    PREPARE VLSQL INTO SQLDA FROM :STRING-VARIABLE;
EXEC SQL OPEN CSR3;
<span class="docEmphasis">Load storage addresses into the SQLDA</span>
<span class="docEmphasis">Loop until no more rows to FETCH</span>
    EXEC SQL FETCH CSR3 USING DESCRIPTOR SQLDA;
EXEC SQL CLOSE CSR3;
</PRE><BR>

<P class="docText">In this section, I've provided a quick introduction to varying-list <TT>SELECT</TT> dynamic SQL. If you want to code parameter markers or need further information on acquiring storage or pointer variables, consult the appropriate compiler manuals and the following DB2 manuals:<A NAME="ch12index241"></A><A NAME="ch12index242"></A><A NAME="ch12index243"></A><A NAME="ch12index244"></A><A NAME="ch12index245"></A></P>
<BLOCKQUOTE><P><P class="docList"><span class="docEmphasis">DB2 Application Programming and SQL Guide</span></P></P><P><P class="docList"><span class="docEmphasis">DB2 SQL Reference</span></P></P></BLOCKQUOTE>
<A NAME="ch12lev2sec4"></A><H4 class="docSection2Title">Varying-List <TT>SELECT</TT> Guidelines</H4>
<P class="docText">The following guidelines should be adhered to when developing varying-list <TT>SELECT</TT> dynamic SQL programs.</P>
<A NAME="ch12lev4sec30"></A><H5 class="docSection3Title">Use Varying-List <TT>SELECT</TT> with Care</H5>
<P class="docText">Be sure that you understand the fundamental capabilities of varying-list <TT>SELECT</TT> dynamic SQL before trying to use it. You should understand completely the <TT>SQLDA</TT>, pointer variables, and how the language you're using implements pointers before proceeding.<A NAME="ch12index246"></A><A NAME="ch12index247"></A><A NAME="ch12index248"></A><A NAME="ch12index249"></A><A NAME="ch12index250"></A></P>
<ul></ul></td></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch12lev1sec6.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch13.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
</body>
</html>
