<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>IMS (Information Management System)</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch18lev1sec2.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch18lev1sec4.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch18lev1sec3"></A><H3 class="docSection1Title">IMS (Information Management System)</H3>
<P class="docText">IMS is IBM's pre-relational database management system offering. It is based on the structuring of related data items in inverted trees or hierarchies. Although usually perceived as only a DBMS, IMS is a combination of two components:<A NAME="ch18index863"></A><A NAME="ch18index864"></A><A NAME="ch18index865"></A></P>
<UL><LI><P class="docList">IMS/DB, the database management system</P></LI><LI><P class="docList">IMS/TM, the transaction management environment or data communications component (previously known as IMS/DC, and still called by that name by many DBAs and systems programmers)</P></LI></UL>
<P class="docText">You can use these IMS components separately or together. Online access to IMS databases is achieved through IMS/TM or CICS. Access to IMS databases is provided also in a batch environment. When an IMS database is accessed through IMS/TM, it is said to be <span class="docEmphasis">online</span>; when it is accessed in batch, it is said to be <span class="docEmphasis">offline</span>. IMS/TM provides an online environment in which you can run application programs that communicate with a terminal, much like CICS. Like CICS, IMS/TM can be used by programs that access not only IMS databases but also DB2 tables.<A NAME="ch18index866"></A><A NAME="ch18index867"></A><A NAME="ch18index868"></A></P>
<P class="docText">IMS and CICS are alike in many respects, but they also have significant differences, outlined in the following paragraphs. For example, IMS uses a facility called MFS (Message Format Services) to format messages to terminals and printers; CICS uses BMS (Basic Mapping Support). IMS/TM controls its environment not through tables, but through a series of macros known as a SYSGEN. The SYSGEN defines the terminals, programs, transactions, and the general online environment for IMS/TM. Another difference is that all IMS programs require a program specification block (PSB), which defines the access to IMS/DB databases and IMS/TM resources. Along with IMS DBDs that define the structure of the IMS databases to be accessed, the PSBs are defined to control a program's scope of operation. An additional control block, the ACB (application control block), is used in the online world (and optionally in the batch environment) to combine the PSBs and DBDs into a single control block defining the control structure and scope of all IMS programs.<A NAME="ch18index869"></A><A NAME="ch18index870"></A></P>
<P class="docText">All IMS/TM activity is processed through a region. There are two types of regions. One control region manages IMS activity and processes commands. Application programs execute from dependent regions. As many as 255 dependent regions can exist for each IMS/TM subsystem. See <A class="docLink" HREF="#ch18fig26">Figure 18.26</A> for clarification.<A NAME="ch18index871"></A><A NAME="ch18index872"></A></P>
<A NAME="ch18fig26"></A><p><CENTER><H5 class="docFigureTitle">Figure 18.26. IMS/TM regions.</H5>
<p class="docText"><IMG BORDER="0"  width="500" height="340" SRC="images/0672326132/graphics/18fig26.gif" ALT="graphics/18fig26.gif"></p></CENTER></p><br>
<A NAME="ch18lev2sec20"></A><H4 class="docSection2Title">Types of IMS Programs</H4>
<P class="docText">IMS programs are categorized, based on the environment in which they run and the types of databases they can access. The four types of IMS programs are batch programs, batch message processors, message processing programs, and fast path programs.<A NAME="ch18index873"></A><A NAME="ch18index874"></A></P>
<P class="docText">An <span class="docEmphasis">IMS batch program</span> is invoked by JCL and runs as an MVS batch job. IMS batch programs can access only offline IMS databases, unless IMS Data Base Recovery Control (DBRC) is used. When DB2 tables are accessed by IMS batch programs, they are commonly referred to as DL/I batch. DL/I (Data Language/I) is the language used to access data in IMS databases, just as SQL is the language used to access data in DB2 tables. Batch DL/I programs run independently of the IMS/TM environment.<A NAME="ch18index875"></A><A NAME="ch18index876"></A></P>
<P class="docText">The second type of IMS program is called a <span class="docEmphasis">batch message processor</span>, or BMP. BMPs are hybrid programs combining elements of both batch and online programs. A BMP runs under the jurisdiction of IMS/TM but is invoked by JES and operates as a batch program. All databases accessed by a BMP must be online to IMS/TM. The following are the two types of BMPs:<A NAME="ch18index877"></A><A NAME="ch18index878"></A></P>
<UL><LI><P class="docList">Terminal-oriented BMPs can access the IMS message queue to send or receive messages from IMS/TM terminals.</P></LI><LI><P class="docList">Batch-oriented BMPs do not access the message queue and cannot communicate with terminals.</P></LI></UL>
<P class="docText">True online IMS programs are called <span class="docEmphasis">message processing programs</span>, or MPPs. They are initiated by a transaction code, access online databases, and communicate with terminals through the message queue.</P>
<P class="docText">The final type of IMS program is a <span class="docEmphasis">fast path program</span>. Fast path programs are very high performance MPPs that access a special type of IMS database known as a fast path database.<A NAME="ch18index879"></A><A NAME="ch18index880"></A></P>
<A NAME="ch18lev2sec21"></A><H4 class="docSection2Title">The IMS Attach Facility</H4>
<P class="docText">As with the other environments, a specialized attachment facility is provided with DB2 to enable IMS to access DB2 resources. The IMS Attach Facility, due to the nature of IMS, provides more flexibility in connecting to DB2 than the Attach Facilities for TSO or CICS.<A NAME="ch18index881"></A><A NAME="ch18index882"></A></P>
<P class="docText">In <A class="docLink" HREF="#ch18fig27">Figure 18.27</A>, you can see that the following connections are supported using the IMS Attach Facility:</P>
<UL><LI><P class="docList">One DB2 subsystem can connect to multiple IMS subsystems.</P></LI><LI><P class="docList">One IMS subsystem can connect to multiple DB2 subsystems.</P></LI><LI><P class="docList">One IMS region can connect to multiple DB2 subsystems.</P></LI><LI><P class="docList">One IMS application program can access only one DB2 subsystem.</P></LI></UL>
<A NAME="ch18fig27"></A><p><CENTER><H5 class="docFigureTitle">Figure 18.27. The IMS Attach Facility.</H5>
<p class="docText"><IMG BORDER="0"  width="500" height="525" SRC="images/0672326132/graphics/18fig27.gif" ALT="graphics/18fig27.gif"></p></CENTER></p><br>
<P class="docText">DB2 is connected to IMS by a subsystem member (SSM). The SSM defines the parameters of the IMS Attach Facility for both online and batch connections. The following list outlines the SSM parameters:<A NAME="ch18index883"></A><A NAME="ch18index884"></A><A NAME="ch18index885"></A><A NAME="ch18index886"></A><A NAME="ch18index887"></A><A NAME="ch18index888"></A></P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5"><COLGROUP><COL width="83.33333333333333"><COL width="66.66666666666666"><COL width="400"></COLGROUP><THEAD></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SSN</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The DB2 subsystem identifier (for example, DSN).<A NAME="ch18index889"></A><A NAME="ch18index890"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>LIT</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The language interface token used to route SQL calls to the appropriate DB2 subsystem. Usually equal to SYS1.<A NAME="ch18index891"></A><A NAME="ch18index892"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>ESMT</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The name of the DB2 initialization module, which must be set to <TT>DSNMIN10</TT>.<A NAME="ch18index893"></A><A NAME="ch18index894"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RTT</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The optional Resource Translation Table to be used. The <TT>RTT</TT> can be used to override IMS region options, such as the capability to specify a plan name different from the program name.<A NAME="ch18index895"></A><A NAME="ch18index896"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>ERR</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The action IMS takes if the plan is not found or the DB2 subsystem is unavailable. The <TT>ERR</TT> options follow:<A NAME="ch18index897"></A><A NAME="ch18index898"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>R</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">IMS returns control to the application program and sets the <TT>SQLCODE</TT> in the SQLCA to <TT>-923</TT>. <TT>R</TT> is the default</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>Q</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">IMS causes an abend when operating in DL/1 batch. In an online environment, IMS <TT>PSTOP</TT>s the program and issues a <TT>U3051</TT> user abend code, backs out this transaction's activity to the last checkpoint, and requeues the input message.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top">
<P class="docText"><TT>A</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">IMS forces an abend with a <TT>U3047</TT> abend code. If executing in the online environment, the input message is deleted.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CRC</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The command recognition character to be used to identify a DB2 command in the IMS/TM environment using <TT>/SSR</TT>. <TT>CRC</TT> is not used in the DL/1 batch environment.<A NAME="ch18index899"></A><A NAME="ch18index900"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CONNECTION</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The connection name for a DL/1 batch program. This name must be unique for each concurrent batch IMS program that will access DB2. If a program is running with a given connection name, and another program with the same name tries to execute at the same time, the second program will fail. This parameter is invalid for the online attach.<A NAME="ch18index901"></A><A NAME="ch18index902"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>PLAN</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The name of the plan to be used by the batch IMS/DB2 application program. This parameter is required only if the plan name is different from the program name. This parameter is invalid for the online attach.<A NAME="ch18index903"></A><A NAME="ch18index904"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>PROGRAM</TT></P></TD><TD class="docTableCell" align="left" valign="top" colspan="2"><P class="docText">The name of the program to be run. This parameter is invalid for the online attach.<A NAME="ch18index905"></A><A NAME="ch18index906"></A><A NAME="ch18index907"></A><A NAME="ch18index908"></A><A NAME="ch18index909"></A><A NAME="ch18index910"></A></P></TD></TR></TABLE></P><br>
<A NAME="ch18lev2sec22"></A><H4 class="docSection2Title">Online Attach Considerations</H4>
<P class="docText">Enabling the IMS Attach Facility for the online environment is the responsibility of a system programmer. IMS-to-DB2 connections are defined by changing the JCL used to invoke the IMS subsystem. The SSM is assigned to the JCL by a parameter on the <TT>EXEC</TT> card. The IMS <TT>SYSGEN</TT> procedure is unaffected by the addition of an IMS-to-DB2 connection.<A NAME="ch18index911"></A><A NAME="ch18index912"></A><A NAME="ch18index913"></A><A NAME="ch18index914"></A></P>
<P class="docText">To establish the connection between IMS/TM and DB2, you must perform the following steps:</P>
<A NAME="ch18pr08"></A>

<div style="font-weight:bold"><OL class="docList" START="1"><LI value="1"><div style="font-weight:normal">Code an SSM line for each DB2 subsystem that must be connected to this IMS/TM region.<BR><BR></div></LI><LI value="2"><div style="font-weight:normal">Place the SSM in the <TT>IMSVS.PROCLIB</TT> PDS defined to the IMS control region and specify the name in the SSM parameter of the <TT>EXEC</TT> statement, for example<BR><BR>
<pre>

</pre><BR><pre>
//IMS        EXEC       IMS . . . ,SSM=SSM1 . . .
//STEPLIB    DD         DSN=IMSVS.RESLIB,DISP=SHR
//           DD         DSN=SYS1.DB2V510.DSNLOAD,DISP=SHR
//           DD         DSN=SYS1.DB2V510.DSNEXIT,DISP=SHR
//PROCLIB    DD         DSN=IMSVS.PROCLIB,DISP=SHR
</pre><BR></div></LI></OL></div>
<P class="docText">The SSM defined to the control region is the default for all dependent regions. If you do not want this default, code a separate SSM for each dependent region that has different IMS-to-DB2 connection needs, and follow the preceding steps for each of the dependent regions.</P>
<P class="docText">If more than one DB2 subsystem will be connected to a single region (control or dependent), the SSM for that region must contain a line for each of the DB2 subsystems. Then a second language interface module must be generated. The standard language interface module is <TT>DFSLI000</TT>; it uses SYS1 as its language interface token (LIT) in the SSM. You can create a second language interface module, <TT>DFSLI002</TT>, for example, by using SYS2 for its LIT.</P>
<P class="docText">You can generate the second language interface module using the <TT>DFSLI</TT> macro provided with IMS/VS. Consider this example:</P>
<pre>

</pre><BR><pre>
DFSLI002   DFSLI   TYPE=DB2,LIT=SYS2
</pre><BR>
<P class="docText">A program executing in any region connected to more than one DB2 subsystem accesses the appropriate DB2 subsystem based on which language interface module the program was link-edited with at program preparation time. In this example, the module would be either <TT>DFSLI000</TT> or <TT>DFSLI002</TT>.</P>
<P class="docText"><TT>CONNECTION</TT>, <TT>PLAN</TT>, and <TT>PROGRAM</TT> are batch parameters and, as such, are invalid when defining the SSM for IMS/TM. Sample online SSM definitions follow. The first is a simple SSM connecting the DB2P subsystem to IMS/TM:</P>
<pre>

</pre><BR><pre>
DB2P,SYS1,DSNMIN10,,R,-
</pre><BR>
<P class="docText">You use the second to connect two DB2 subsystems, DB2A and DB2B, to a single IMS/TM:</P>
<pre>

</pre><BR><pre>
DB2A,SYS1,DSNMIN10,,R,-
DB2B,SYS2,DSNMIN10,,R,+
</pre><BR>
<P class="docText">To access DB2A, <TT>INCLUDE</TT> the <TT>DFSLI000</TT> module (because it is associated with LIT SYS1) in the link-edit step for your programs. <TT>DFSLI002</TT>, on the other hand, is associated with LIT SYS2, so it is link-edited into programs that must access DB2B resources.</P>
<P class="docText">An online IMS/TM program (BMP, MPP, or fast path) must follow standard DB2 program preparation procedures (precompile, compile, link edit, and <TT>BIND</TT>). However, a few special considerations apply:</P>
<UL><LI><P class="docList">The appropriate language interface module (<TT>DFSLI000</TT>, <TT>DFSLI002</TT>, and so on) for the DB2 subsystem to be accessed must be link-edited into the load module.</P></LI><LI><P class="docList">A PSB must be generated for the program to define the IMS databases and online resources that will be accessed by the program.</P></LI><LI><P class="docList">The PSB (and all DBDs accessed by the program) must be included in the ACB for the online IMS/TM subsystem.</P></LI><LI><P class="docList">The appropriate IMS SYSGEN macros must be coded for the transaction and program before it can be executed online.<A NAME="ch18index915"></A><A NAME="ch18index916"></A><A NAME="ch18index917"></A><A NAME="ch18index918"></A></P></LI></UL>
<A NAME="ch18lev2sec23"></A><H4 class="docSection2Title">The Resource Translation Table</H4>
<P class="docText">You can define a resource translation table (RTT) using the <TT>DSNMAPN</TT> assembler macro. An RTT is necessary only when the plan name is not the same as the program name. Consider this example:<A NAME="ch18index919"></A><A NAME="ch18index920"></A><A NAME="ch18index921"></A><A NAME="ch18index922"></A></P>
<pre>

</pre><BR><pre>
DSNMAPN     APN=PROGRAMX,PLAN=PLANX, . . .
</pre><BR>
<P class="docText">This statement assigns the plan name, <TT>PLANX</TT>, to the program <TT>PROGRAMX</TT>. This macro must be linked to the DB2 load library with the name specified in the RTT parameter of the SSM being used.</P>
<A NAME="ch18lev2sec24"></A><H4 class="docSection2Title">IMS/TM Thread Use</H4>
<P class="docText">Two types of threads are used by IMS/TM: command threads and transaction threads. The type of thread is contingent on the type of region it has been created for. Each region can have only one thread at any given time.<A NAME="ch18index923"></A><A NAME="ch18index924"></A></P>
<P class="docText">Threads emanating from IMS/TM are not created until they are needed, even though the IMS-to-DB2 connection has been established. The following process is for a command thread emanating from the control region:</P>
<A NAME="ch18pr09"></A>




<div style="font-weight:bold"><OL class="docList" START="1"><LI value="1"><div style="font-weight:normal">After IMS/TM is brought up, the first DB2 command is issued from a terminal connected to IMS/TM using the <TT>/SSR</TT> IMS command.<BR><BR></div></LI><LI value="2"><div style="font-weight:normal">IMS verifies that the user is permitted to issue the <TT>/SSR</TT> command.<BR><BR></div></LI><LI value="3"><div style="font-weight:normal">IMS issues a <TT>SIGNON</TT> request using that user's userid, if available. If <TT>SIGNON</TT> security is not used, the <TT>LTERM</TT> is used (or, for a non-message-driven BMP, the PSB name is used).<BR><BR></div></LI><LI value="4"><div style="font-weight:normal">IMS requests that DB2 create a thread.<BR><BR></div></LI><LI value="5"><div style="font-weight:normal">When the thread has been created, the command is processed. Subsequent DB2 commands issued from IMS can reuse the thread. <TT>SIGNON</TT> is performed for these subsequent commands.<BR><BR></div></LI></OL></div>
<P class="docText">Additional processing is required for transaction threads. Transaction threads are created from a dependent region that was scheduled by the control region. The procedure for transaction thread creation and its use is shown in <A class="docLink" HREF="#ch18fig28">Figure 18.28</A>.<A NAME="ch18index925"></A><A NAME="ch18index926"></A></P>
<A NAME="ch18fig28"></A><p><CENTER><H5 class="docFigureTitle">Figure 18.28. IMS/DB2 transaction threads.</H5>
<p class="docText"><div class="v1"><a target="_blank" href="images/0672326132/graphics/18fig28_alt.gif">[View full size image]</a></div><IMG BORDER="0"  width="500" height="479" SRC="images/0672326132/graphics/18fig28.gif" ALT="graphics/18fig28.gif"></p></CENTER></p><br>
<A NAME="ch18lev2sec25"></A><H4 class="docSection2Title">Two-Phase Commit</H4>
<P class="docText">Recall that CICS programs commit changes by means of CICS commands and not the normal DB2 <TT>COMMIT</TT> statement. Likewise, changes made in IMS/TM programs are committed and rolled back by means of IMS commands. You code the IMS checkpoint command, which implements a <TT>COMMIT</TT>, as follows:<A NAME="ch18index927"></A><A NAME="ch18index928"></A><A NAME="ch18index929"></A></P>
<pre>

</pre><BR><pre>
CALL    'CBLTDLI' USING NUM-OPS,
                        'CHKP',
                        IO-PCB,
                        CHKP-LENGTH,
                        CHKP-AREA.
</pre><BR>
<P class="docText">You code the IMS rollback command as follows:</P>
<pre>

</pre><BR><pre>
CALL    'CBLTDLI' USING NUM-OPS,
                        'ROLB',
                        IO-PCB,
                        CHKP-LENGTH,
                        CHKP-AREA.
</pre><BR>
<P class="docText">The SQL verbs <TT>COMMIT</TT> and <TT>ROLLBACK</TT> are not valid in IMS/TM programs. An implicit commit is performed when a <TT>GET UNIQUE</TT> is issued to the message queue.</P>
<P class="docText">When a checkpoint is requested in an IMS/TM program, a two-phase commit is performed much like the two-phase commit discussed in the previous section on CICS. The commit is done in two phases to synchronize the updates made to IMS databases with those made to DB2 tables.</P>
<P class="docText">The two-phase commit process for IMS/TM programs is outlined in <A class="docLink" HREF="#ch18fig29">Figure 18.29</A>. A component of IMS/TM called the <span class="docEmphasis">syncpoint coordinator</span> handles the coordination of commits.<A NAME="ch18index930"></A><A NAME="ch18index931"></A><A NAME="ch18index932"></A><A NAME="ch18index933"></A></P>
<A NAME="ch18fig29"></A><p><CENTER><H5 class="docFigureTitle">Figure 18.29. The IMS/TM two-phase commit process.</H5>
<p class="docText"><IMG BORDER="0"  width="500" height="472" SRC="images/0672326132/graphics/18fig29.gif" ALT="graphics/18fig29.gif"></p></CENTER></p><br>
<P class="docText">Phase 1 of the commit process consists of IMS/TM informing each participant that a syncpoint has been reached and that each participant should prepare to commit. The participants can include DB2, DL/I, IMS/TM, and IMS Fast Path. Each participant performs the needed tasks to ensure that a commit is possible for that environment. DB2 updates its log, retains all locks, and informs the IMS syncpoint coordinator that phase 1 has been completed successfully.</P>
<P class="docText">If all other participants signal that the commit can proceed, phase 2 is initiated, whereby each participant is responsible for completing the commit. If any participant signals that phase 1 cannot be completed successfully, the entire unit of work is aborted and the updates are backed out. In phase 2, DB2 logs the commit and releases all locks.</P>
<P class="docText">The two-phase commit process virtually ensures the integrity of DB2 data modified by IMS/TM. If changes cannot be committed in either DB2 or IMS for any reason, they are rolled back in both. In a connection failure of a system crash, however, the commit status of some transactions may be in doubt. They are referred to as <span class="docEmphasis">in-doubt threads</span>. When DB2 and IMS/TM are started after a system failure, and the IMS-to-DB2 connection is reestablished, most in-doubt threads are resolved automatically. If any in-doubt threads remain, you can use the <TT>RECOVER INDOUBT</TT> command to commit or roll back the changes pending for these threads.<A NAME="ch18index934"></A><A NAME="ch18index935"></A><A NAME="ch18index936"></A></P>
<A NAME="ch18lev2sec26"></A><H4 class="docSection2Title">Restart</H4>
<P class="docText">The restart capabilities of IMS/TM can be used by online programs. You code the IMS restart command, <TT>XRST</TT>, as follows:<A NAME="ch18index937"></A><A NAME="ch18index938"></A><A NAME="ch18index939"></A><A NAME="ch18index940"></A></P>
<pre>

</pre><BR><pre>
CALL 'CBLTDLI' USING 'XRST',
                     IO-PCB,
                     IO-LENGTH,
                     IO-AREA,
                     CHKP-LENGTH,
                     CHKP-AREA.
</pre><BR>
<P class="docText"><TT>XRST</TT> reads the last checkpoint from the IMS log and passes the data stored in the checkpoint area to the program issuing the command. The program can use that information to reposition DB2 cursors and reestablish IMS database positioning.</P>
<P class="docText">It is imperative, though, that each checkpoint call passes all requisite information for repositioning each time it is issued. For DB2 cursors, this information should include the name of the cursor, the tables being accessed, and the last key or keys retrieved. For IMS databases, this information includes the name of the database, the segment being accessed, and the complete concatenated key. This information should be saved for every DB2 cursor and IMS database PCB that must be repositioned.</P>
<A NAME="ch18lev2sec27"></A><H4 class="docSection2Title">IMS/DB2 Deadlocks</H4>
<P class="docText">DB2 locks and IMS locks are managed independently. DB2 uses a lock manager called the IRLM. IMS can use the IRLM to control locks, but it can also use a technique known as program isolation. Even if both subsystems use an IRLM to control locks, IMS locks are issued independently from DB2 locks. As a result, a deadlock can occur. A complete description of deadlocks is included in <A class="docLink" HREF="ch23.html#ch23">Chapter 23</A>, "Locking DB2 Data." An example of an IMS and DB2 deadlock is presented in the following processing sequence for two concurrently executing application programs:<A NAME="ch18index941"></A><A NAME="ch18index942"></A></P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="groups" CELLPADDING="5"><COLGROUP><COL width="220"><COL width="99"><COL width="231"></COLGROUP><THEAD><TR><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Program 1</span></P></TH><TH class="bottomBorder thead" align="left" valign="top">&nbsp;</TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Program 2</span></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Update IMS DBD1</P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Update DB2 Table A</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Lock established</P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Lock established</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Intermediate processing</P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Intermediate processing</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Update DB2 Table A</P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Update IMS DBD1</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Lock (wait)</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><span class="docEmphasis">Deadlock</span></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Lock (wait)</P></TD></TR></TABLE></P><br>
<P class="docText">Program 1 requests a lock for DB2 resources that Program 2 holds, and Program 2 requests a lock for IMS resources that Program 1 holds. This deadlock must be resolved before either program can perform subsequent processing. One of the two programs must be targeted as the victim of the deadlock; in other words, it either abends or is timed out.</P>
<P class="docText">The deadlock situation is resolved differently depending on the program and the resource. When an MPP is the victim in a deadlock, it abends with a <TT>U777</TT> abend. When a batch-oriented BMP is the victim in a deadlock, the abend received depends on the type of resource that could not be locked:</P>
<UL><LI><P class="docList">If only DL/I databases are affected, a <TT>U777</TT> abend results.</P></LI><LI><P class="docList">If DL/I databases are affected in conjunction with fast path databases or DB2 tables, the PCB status field is set to <TT>FD</TT>.</P></LI><LI><P class="docList">If fast path databases are involved, the PCB status field is set to <TT>FD</TT>.</P></LI><LI><P class="docList">If DB2 tables are involved, the <TT>SQLCODE</TT> is set to <TT>-911</TT>.<A NAME="ch18index943"></A><A NAME="ch18index944"></A></P></LI></UL>
<A NAME="ch18lev2sec28"></A><H4 class="docSection2Title">IMS SYSGEN Guidelines</H4>
<P class="docText">The following guidelines are useful when performing an IMS SYSGEN for DB2.</P>
<A NAME="ch18lev4sec49"></A><H5 class="docSection3Title">Promote Thread Use with <TT>PROCLIM</TT></H5>
<P class="docText">Specify the <TT>PROCLIM</TT> parameter of the <TT>TRANSACT</TT> macro to be greater than <TT>1</TT> to encourage thread reuse for IMS transactions that access DB2 tables. When multiple transactions are processed during the same PSB schedule, DB2 can reuse the thread, thereby reducing overhead by avoiding thread creation.<A NAME="ch18index945"></A><A NAME="ch18index946"></A><A NAME="ch18index947"></A><A NAME="ch18index948"></A></P>
<A NAME="ch18lev4sec50"></A><H5 class="docSection3Title">Use WFI and Fast Path Only for Critical Transactions</H5>
<P class="docText">Threads are always reused by WFI (Wait For Input) transactions and Fast Path regions. The thread is not terminated unless the WFI or Fast Path region is stopped, so these regions tie up a thread indefinitely. For this reason, use WFI transactions and Fast Path regions for only high-volume, critical transactions. For low-volume transactions, use the <TT>PROCLIM</TT> parameter to control thread reuse.<A NAME="ch18index949"></A><A NAME="ch18index950"></A><A NAME="ch18index951"></A><A NAME="ch18index952"></A><A NAME="ch18index953"></A></P>
<A NAME="ch18lev4sec51"></A><H5 class="docSection3Title">Define the Transaction Mode Carefully</H5>
<P class="docText">You can define a transaction to operate in one of two modes: <TT>MODE=SNGL</TT> or <TT>MODE=MULTI</TT>. <TT>MODE=SNGL</TT> transactions define a unit of work at the transaction level, whereas <TT>MODE=MULTI</TT> transactions string multiple transactions together into a unit of work. Single mode transactions cause a syncpoint when the transaction is completed. Multiple mode transactions do not reach a syncpoint until the program is terminated.<A NAME="ch18index954"></A><A NAME="ch18index955"></A></P>
<P class="docText">As the programmer, you must know the mode of the transaction before coding to implement <TT>CHKP</TT> processing effectively and to reestablish cursor and database positioning properly.</P>
<A NAME="ch18lev4sec52"></A><H5 class="docSection3Title">Use <TT>INQUIRY=YES</TT> for Read-Only Transactions</H5>
<P class="docText">You can define read-only transactions by coding <TT>INQUIRY=YES</TT> for the <TT>TRANSACT</TT> macro. Transactions defined to be read-only cannot update IMS databases. When the transaction accesses DB2, it cannot modify data in DB2 tables. An attempt to issue the following SQL statements in a read-only transaction results in a <TT>-817 SQLCODE</TT>:<A NAME="ch18index956"></A><A NAME="ch18index957"></A><A NAME="ch18index958"></A><A NAME="ch18index959"></A></P>
<BLOCKQUOTE><P><P class="docList"><TT>ALTER</TT></P></P><P><P class="docList"><TT>CREATE</TT></P></P><P><P class="docList"><TT>DELETE</TT></P></P><P><P class="docList"><TT>DROP</TT></P></P><P><P class="docList"><TT>GRANT</TT></P></P><P><P class="docList"><TT>INSERT</TT></P></P><P><P class="docList"><TT>REVOKE</TT></P></P><P><P class="docList"><TT>UPDATE</TT></P></P></BLOCKQUOTE>
<A NAME="ch18lev2sec29"></A><H4 class="docSection2Title">DL/I Batch Interface</H4>
<P class="docText">The DL/I batch interface enables batch IMS programs to access DB2 data. DL/I batch programs access DB2 data under the auspices of the IMS attach facility, which is defined by an SSM. When you're establishing an IMS-to-DB2 connection for a batch program, the JCL used to execute the batch program must contain the SSM parameters. It is assigned to the <TT>DDITV02 DD</TT> name, as shown in the following example:<A NAME="ch18index960"></A><A NAME="ch18index961"></A><A NAME="ch18index962"></A></P>
<pre>

</pre><BR><pre>
//DDITV02   DD  *
DB2T,SYS1,DSNMIN10,,R,-,APPL01,,PGM01
/*
</pre><BR>
<P class="docText">This SSM connects the <TT>PGM01</TT> program to DB2T using a plan with the same name as the program. The program does not abend if DB2 is unavailable. Another SSM example follows:</P>
<pre>

</pre><BR><pre>
//DDITV02   DD  *
DSN,SYS1,DSNMIN10,,A,-,APPL02,PLANNAME,PGM02
/*
</pre><BR>
<P class="docText">This SSM uses plan <TT>PLANNAME</TT> to connect the <TT>PGM02</TT> program to the DB2 subsystem named <TT>DSN</TT>. An abend is forced if DB2 is unavailable. If the <TT>DDITV02 DD</TT> name is missing or specified incorrectly, a connection is not made and the job abends.</P>
<P class="docText">Additionally, you can specify an output data set containing status and processing information by using the <TT>DDOTV02 DD</TT> name. If you do not specify the <TT>DDOTV02 DD</TT> name, processing continues without sending the status and processing information.</P>
<P class="docText">Sample JCL to run a DL/I batch program that accesses DB2 tables is shown in <A class="docLink" HREF="#ch18list04">Listing 18.4</A>. This JCL runs the <TT>BTCHPROG</TT> program using the <TT>BTCHPLAN</TT> plan. Notice that the JCL contains two steps. The first step runs the DL/I batch program, and the second step prints the contents of the <TT>DDOTV02</TT> data set. Printing the <TT>DDOTV02</TT> data set is a good idea because it can contain pertinent information for resolving any processing errors.</P>
<A NAME="ch18list04"></A><H5 class="docExampleTitle">Listing 18.4. JCL to Run a DL/I Batch DB2 Program</H5><A NAME="ch18index963"></A>

<PRE>
//DB2JOBB  JOB (BATCH),'DL/I BATCH',MSGCLASS=X,CLASS=X,
//      NOTIFY=USER,REGION=4096K
//*
//****************************************************************
//*
//*        JCL TO RUN AN IMS/DB2 PROGRAM IN BATCH
//*
//*        PROGRAM NAME    :: BTCHPROG
//*        PLAN NAME       :: BTCHPLAN
//*        CONNECTION NAME :: DB2B0001
//*
//****************************************************************
//*
//JOBLIB     DD DSN=SYS1.DB2V810.DSNLOAD,DISP=SHR
//BATCHPRG   EXEC DLIBATCH,DBRC=Y,LOGT=SYSDA,COND=EVEN,
//           MSGCLASS='X',CLASS='X'
//G.STEPLIB  DD
//           DD
//           DD Add a DD for each DB2, COBOL, and program
//              load library
//G.IEFRDER  DD DSN=IMSLOG,DISP=(NEW,CATLG,CATLG),. . .
//G.STEPCAT  DD DSN=IMSCAT,DISP=SHR
//G.DDOTV02  DD DSN=&amp;DDOTV02,DISP=(NEW,PASS,DELETE),
//           UNIT=SYSDA,DCB=(RECFM=VB,BLKSIZE=4096,LRECL=4092),
//           SPACE=(TRK,(1,1),RLSE)
//G.DDITV02  DD *
  DB2P,SYS1,DSNMIN10,,A,-,DB2B0001,BTCHPLAN,BTCHPROG
/*
//*
//***************************************************************
//*
//*        PRINT THE DDOTV02 DATASET IF THERE ARE PROBLEMS
//*
//****************************************************************
//*
//PRINTOUT   EXEC PGM=DFSERA10,COND=EVEN
//STEPLIB    DD DSN=IMS.RESLIB,DISP=SHR
//SYSPRINT   DD SYSOUT=X
//SYSUT1     DD DSN=&amp;DDOTV02,DISP=(OLD,DELETE)
//SYSIN      DD *
CONTROL     CNTL   K=000,H=8000
OPTION      PRINT
/*
//
</PRE><BR>

<P class="docText">A DL/I batch program must follow standard DB2 program preparation procedures (precompile, compile, link-edit, and bind). However, a few special considerations apply:</P>
<UL><LI><P class="docList">All DL/I batch programs must be link-edited using the <TT>RMODE=24</TT> and <TT>AMODE=24</TT> parameters.</P></LI><LI><P class="docList">The <TT>DFSLI000</TT> language interface module must be link-edited to the load module.</P></LI><LI><P class="docList">A PSB must be generated for the program to define the IMS databases to be accessed.<A NAME="ch18index964"></A><A NAME="ch18index965"></A><A NAME="ch18index966"></A></P></LI></UL>
<A NAME="ch18lev2sec30"></A><H4 class="docSection2Title">IMS/TM Design Guidelines</H4>
<P class="docText">The following techniques should be applied when designing IMS transactions that access DB2 data.</P>
<A NAME="ch18lev4sec53"></A><H5 class="docSection3Title">Avoid DDL</H5>
<P class="docText">Avoid issuing DDL in an IMS/TM program. DDL execution is time intensive and acquires locks on the DB2 Catalog and the DB2 Directory. Because IMS/TM programs should be quick, they should avoid DDL.<A NAME="ch18index967"></A><A NAME="ch18index968"></A></P>
<A NAME="ch18lev4sec54"></A><H5 class="docSection3Title">Copy PCBs Before Each Checkpoint</H5>
<P class="docText">Application programs should save the PCBs for all IMS databases before invoking an IMS <TT>CHKP</TT>. After the <TT>CHKP</TT>, copy the saved PCB back to the original to reestablish positioning in the IMS databases. Otherwise, the IMS database positioning is lost, much like DB2 cursor positioning is lost when a <TT>COMMIT</TT> is performed.<A NAME="ch18index969"></A><A NAME="ch18index970"></A><A NAME="ch18index971"></A></P>
<A NAME="ch18lev4sec55"></A><H5 class="docSection3Title">Be Aware of Cursor Closing Points</H5>
<P class="docText">IMS closes all DB2 cursors in WFI and <TT>MODE=SINGL</TT> transactions when the program does a get unique (<TT>GU</TT>) to the message queue (<TT>IOPCB</TT>). Cursors also are closed when the program issues a <TT>CHKP</TT> call or when the program terminates.<A NAME="ch18index972"></A><A NAME="ch18index973"></A><A NAME="ch18index974"></A></P>
<A NAME="ch18lev4sec56"></A><H5 class="docSection3Title">Use a Scratch Pad Area</H5>
<P class="docText">Use the SPA (Scratch Pad Area) to store temporary work and to implement pseudoconversational programs.<A NAME="ch18index975"></A><A NAME="ch18index976"></A><A NAME="ch18index977"></A><A NAME="ch18index978"></A></P>
<A NAME="ch18lev4sec57"></A><H5 class="docSection3Title">Use Fast Path for Sequential Number Assignment</H5>
<P class="docText">Consider using IMS Fast Path database storage to assign sequential numbers. Accessing sequential numbers for assignment using Fast Path databases is more efficient than other conventional means (for example, reading a table containing the highest number).<A NAME="ch18index979"></A><A NAME="ch18index980"></A><A NAME="ch18index981"></A></P>
<A NAME="ch18lev4sec58"></A><H5 class="docSection3Title">Use Testing Tools</H5>
<P class="docText">Use testing tools such as the Batch Terminal Simulator (BTS). The requirements for using BTS follow:<A NAME="ch18index982"></A><A NAME="ch18index983"></A><A NAME="ch18index984"></A><A NAME="ch18index985"></A></P>
<UL><LI><P class="docList">The user must have <TT>MONITOR2</TT> and <TT>TRACE</TT> authority.</P></LI><LI><P class="docList"><TT>MONITOR</TT> Trace Class 1 must be activated for the plan being tested.</P></LI><LI><P class="docList">The plan must be specified on the <TT>./T</TT> control card.</P></LI><LI><P class="docList">A new control card must be added as follows:</P><pre>

</pre><BR><pre>
./P MBR=BTSCOM00 PA 000C14 PC=DB2T
</pre><BR></LI></UL>
<P class="docText">Note that any valid DB2 subsystem ID can be substituted for DB2T.</P>
<A NAME="ch18lev4sec59"></A><H5 class="docSection3Title">Do Not Share IRLMs</H5>
<P class="docText">The DBRC facility of IMS uses an IRLM to control locking when multiple jobs access shared databases. Never share a single IRLM between DB2 and IMS because doing so results in inefficient locking for both IMS and DB2. Also, a shared IRLM is difficult to monitor and tune. Specify a single IRLM for each DB2 subsystem and an IRLM for the IMS subsystem.<A NAME="ch18index986"></A><A NAME="ch18index987"></A><A NAME="ch18index988"></A></P>
<A NAME="ch18lev4sec60"></A><H5 class="docSection3Title">Consider IMS/ESA Quick Reschedule</H5>
<P class="docText">For very active, critical transactions, use the quick reschedule feature of IMS/ESA. Quick reschedule creates a "hot region" for the execution of MPPs. When quick reschedule is implemented, the MPP region does not terminate when the <TT>PROCLIM</TT> count is reached if the message queue holds a qualifying transaction waiting to execute.<A NAME="ch18index989"></A></P>
<ul></ul></td></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch18lev1sec2.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch18lev1sec4.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
</body>
</html>
