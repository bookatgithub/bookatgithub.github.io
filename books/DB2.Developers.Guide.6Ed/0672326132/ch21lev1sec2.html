<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>How the Optimizer Works</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch21lev1sec1.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch21lev1sec3.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch21lev1sec2"></A><H3 class="docSection1Title">How the Optimizer Works</H3>
<P class="docText">The optimizer performs complex calculations based on a host of information. To simplify the functionality of the optimizer, you can picture it as performing a four-step process:<A NAME="ch21index08"></A></P>
<A NAME="ch21pr01"></A>



<div style="font-weight:bold"><OL class="docList" START="1"><LI value="1"><div style="font-weight:normal">Receive and verify the SQL statement.<BR><BR></div></LI><LI value="2"><div style="font-weight:normal">Analyze the environment and optimize the method of satisfying the SQL statement.<BR><BR></div></LI><LI value="3"><div style="font-weight:normal">Create machine-readable instructions to execute the optimized SQL.<BR><BR></div></LI><LI value="4"><div style="font-weight:normal">Execute the instructions or store them for future execution.<BR><BR></div></LI></OL></div>
<P class="docText">The second step of this process is the most intriguing. How does the optimizer decide how to execute the vast array of SQL statements that can be sent its way?</P>
<P class="docText">The optimizer has many types of strategies for optimizing SQL. How does it choose which of these strategies to use in the optimized access paths? IBM does not publish the exact details and logic used by the optimizer, but the optimizer is cost-based. This means that the optimizer will always attempt to formulate an access path for each query that reduces overall cost. To accomplish this, the DB2 optimizer evaluates and weighs four factors for each potential access path: the CPU cost, the I/O cost, the DB2 Catalog statistics, and the SQL statement itself.<A NAME="ch21index09"></A></P>
<A NAME="ch21lev2sec1"></A><H4 class="docSection2Title">CPU Cost</H4>
<P class="docText">The optimizer tries to determine the cost of execution of each access path strategy for the query being optimized. Based on the serial number of the CPU, the optimizer estimates the CPU time required to accomplish the tasks associated with the access path it is analyzing. As it calculates this cost, it determines the costs involved in applying predicates, traversing pages (index and tablespace), and sorting.<A NAME="ch21index10"></A><A NAME="ch21index11"></A><A NAME="ch21index12"></A></P>
<A NAME="ch21lev2sec2"></A><H4 class="docSection2Title">I/O Cost</H4>
<P class="docText">The optimizer estimates the cost of physically retrieving and writing the data. In so doing, the optimizer estimates the cost of I/O by using a series of formulas based on the following data: DB2 Catalog statistics, the size of the buffer pools, and the cost of work files used (sorting, intermediate results, and so on). These formulas result in a <span class="docEmphasis">filter factor,</span> which determines the relative I/O cost of the query. Filter factors are covered in more detail in the "<A class="docLink" HREF="ch21lev1sec3.html#ch21lev1sec3">Filter Factors</A>" section, later in this chapter.<A NAME="ch21index13"></A><A NAME="ch21index14"></A><A NAME="ch21index15"></A><A NAME="ch21index16"></A><A NAME="ch21index17"></A></P>
<A NAME="ch21lev2sec3"></A><H4 class="docSection2Title">DB2 Catalog Statistics</H4>
<P class="docText">Without the statistics stored in the DB2 Catalog, the optimizer would have a difficult time optimizing anything. These statistics provide the optimizer with information pertinent to the state of the tables that will be accessed by the SQL statement that is being optimized. A complete listing of the DB2 Catalog statistics and values used by the optimizer is in <A class="docLink" HREF="#ch21table01">Table 21.1</A>. Partition-level statistics are used when determining the degree of parallelism for queries using I/O, CP, and Sysplex parallelism.<A NAME="ch21index18"></A><A NAME="ch21index19"></A><A NAME="ch21index20"></A><A NAME="ch21index21"></A></P>
<A NAME="ch21table01"></A><P><TABLE CELLSPACING="0" FRAME="above" RULES="groups" CELLPADDING="5"><CAPTION><h5 class="docTableTitle">Table 21.1. DB2 Catalog Columns Analyzed by the Optimizer</h5></CAPTION><COLGROUP><COL width="152.4752475247525"><COL width="152.4752475247525"><COL width="245.04950495049508"></COLGROUP><THEAD><TR><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Catalog Table</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Column</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Description</span></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top" rowspan="4"><P class="docText"><TT>SYSIBM.SYSTABLES</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CARDF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of rows for the table</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NPAGES</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of pages used by the table</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>EDPROC</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Name of the <TT>EDITPROC</TT> exit routine, if any</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>PCTROWCOMP</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Percentage of active rows compressed for this table<A NAME="ch21index22"></A><A NAME="ch21index23"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top" rowspan="2"><P class="docText"><TT>SYSIBM.SYSTABSTATS</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CARDF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of rows for the partition</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NPAGES</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of pages on which rows of the partition appear<A NAME="ch21index24"></A><A NAME="ch21index25"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SYSIBM.SYSTABLESPACE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NACTIVEF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of allocated, active tablespace pages<A NAME="ch21index26"></A><A NAME="ch21index27"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top" rowspan="3"><P class="docText"><TT>SYSIBM.SYSCOLUMNS</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>LOW2KEY</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Second lowest value for the column (first 2,000 bytes only)<A NAME="ch21index28"></A><A NAME="ch21index29"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>HIGH2KEY</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Second highest value for the column (first 2,000 bytes only)</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>COLCARDF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Estimated number of distinct values for the column</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top" rowspan="6"><P class="docText"><TT>SYSIBM.SYSINDEXES</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CLUSTERRATIOF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Percentage (multiplied by 100) of rows in clustering order</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CLUSTERING</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Whether <TT>CLUSTER YES</TT> was specified when the index was created</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>FIRSTKEYCARDF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of distinct values for the first column of the index key<A NAME="ch21index30"></A><A NAME="ch21index31"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>FULLKEYCARDF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of distinct values for the full index key</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NLEAF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of active leaf pages</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NLEVELS</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of index b-tree levels</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>SYSIBM.SYSINDEXPART</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>LIMITKEY</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The limit key of the partition<A NAME="ch21index32"></A><A NAME="ch21index33"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top" rowspan="6"><P class="docText"><TT>SYSIBM.SYSCOLDIST</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>TYPE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Type of <TT>RUNSTATS</TT> gathered; frequent value (<TT>F</TT>) or cardinality (<TT>C</TT>)</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>COLVALUE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Non-uniform distribution column value<A NAME="ch21index34"></A><A NAME="ch21index35"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>FREQUENCYF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Percentage (multiplied by 100) of rows that contain the value indicated in the <TT>COLVALUE</TT> column</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CARDF</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Number of distinct values for the column</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>COLGROUPCOLNO</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Set of columns for the statistics gathered</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NUMCOLUMNS</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The number of columns associated with the statistics<A NAME="ch21index36"></A><A NAME="ch21index37"></A><A NAME="ch21index38"></A><A NAME="ch21index39"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top" rowspan="5"><P class="docText"><TT>SYSIBM.SYSROUTINES</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>IOS_PER_INVOC</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Estimated number of I/Os per invocation of this routine</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>INSTS_PER_INVOC</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Estimated number of instructions per invocation of this routine<A NAME="ch21index40"></A><A NAME="ch21index41"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>INITIAL_IOS</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Estimated number of I/Os for the first and last time the routine is invoked</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>INITIAL_INSTS</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Estimated number of instructions for the first and last time the routine is invoked</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CARDINALITY</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Predicted cardinality for a table function</P></TD></TR></TABLE></P><br>
<P class="docText">The columns that have an <span class="docEmphStrong"><TT>F</TT></span> at the end of their names were changed from <TT>INTEGER</TT> columns to <TT>FLOAT</TT> columns (as of DB2 V5). This enabled DB2 to store larger values in these columns. The largest value that can be stored in an <TT>INTEGER</TT> column is <TT>2,147,483,647</TT>; a floating point column can store values up to 7.2 x 10<SUP>75</SUP>—a very large number indeed.</P>
<P class="docText"><TT>RUNSTATS</TT> can also keep track of correlated columns. <span class="docEmphasis">Correlated columns</span> have values that are related to one another. An example of a set of correlated columns is <TT>CITY</TT>, <TT>STATE</TT>, and <TT>ZIP_CODE</TT>. For example, the combination of <TT>CHICAGO</TT> for <TT>CITY</TT> and <TT>IL</TT> for <TT>STATE</TT> is much more likely to occur than <TT>CHICAGO</TT> and <TT>AK</TT>. Such correlations are useful for the optimizer to analyze when formulating access paths.<A NAME="ch21index42"></A><A NAME="ch21index43"></A></P>
<P class="docText">The <TT>RUNSTATS</TT> utility also generates information about the frequency of data values. This information is useful to the optimizer because a different access path may be chosen for a predicate when retrieving a value that occurs 40% of the time than for the same predicate when retrieving a value that occurs only 2% of the time.<A NAME="ch21index44"></A><A NAME="ch21index45"></A><A NAME="ch21index46"></A><A NAME="ch21index47"></A></P>
<A NAME="ch21lev2sec4"></A><H4 class="docSection2Title">The SQL Statement</H4>
<P class="docText">The formulation of the SQL statement also enters into the access path decisions made by the optimizer. The complexity of the query, the number and type of predicates used (Stage 1 versus Stage 2), the usage of column and scalar functions, and the presence of ordering clauses (<TT>ORDER BY</TT>, <TT>GROUP BY</TT>, and <TT>DISTINCT</TT>) enter into the estimated cost that is calculated by the optimizer.<A NAME="ch21index48"></A><A NAME="ch21index49"></A></P>
<P class="docText">Additionally, certain SQL formulations are recognized as optimizer tweaks—for example, adding <TT>OR 0=1</TT> to a predicate to affect indexing.</P>
<ul></ul></td></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch21lev1sec1.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch21lev1sec3.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
</body>
</html>
