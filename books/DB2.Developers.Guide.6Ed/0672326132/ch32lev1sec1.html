<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>The COPY Utility</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch32.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch32lev1sec2.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch32lev1sec1"></A><H3 class="docSection1Title">The <TT>COPY</TT> Utility</H3>
<P class="docText">The <TT>COPY</TT> utility is used to create an image copy backup data set for a complete table space, a single partition of a table space, or a complete index space. It can be executed so that a full image copy or an incremental image copy is created. A <span class="docEmphasis">full image copy</span> is a complete copy of all the data stored in the table space, table space partition, or index being copied. An <span class="docEmphasis">incremental image copy</span> is a copy of only the table space pages that have been modified due to inserts, updates, or deletes since the last full or incremental image copy.<A NAME="ch32index01"></A><A NAME="ch32index02"></A><A NAME="ch32index03"></A><A NAME="ch32index04"></A><A NAME="ch32index05"></A></P>
<A NAME="ch32note01"></A><div class="docNote"><p class="docNoteTitle">CAUTION</p>

<P class="docText">For indexes, only full image copies can be created. Incremental image copies are not permitted for indexes. Furthermore, to be able to copy an index it must have been created with the <TT>COPY YES</TT> parameter.</P></div><br>
<P class="docText">The <TT>COPY</TT> utility utilizes the <TT>SYSIBM.SYSCOPY</TT> table to maintain a catalog of image copies. Every successful execution of the <TT>COPY</TT> utility places in this table at least one new row that indicates the status of the image copy. Information stored in the table includes the image copy data set name, the date and time of the <TT>COPY</TT>, the log RBA at the time of the copy, and the volume serial numbers for uncataloged image copy data sets. This information is read by the <TT>RECOVER</TT> utility to enable automated table space and index recovery.<A NAME="ch32index06"></A><A NAME="ch32index07"></A><A NAME="ch32index08"></A><A NAME="ch32index09"></A><A NAME="ch32index10"></A></P>
<P class="docText">The JCL in <A class="docLink" HREF="#ch32list01">Listing 32.1</A> depicts a full image copy for a DB2 table space; the JCL in <A class="docLink" HREF="#ch32list02">Listing 32.2</A> is an incremental image copy. The full image copy takes dual copies, whereas the incremental takes only a single image copy data set.<A NAME="ch32index11"></A><A NAME="ch32index12"></A><A NAME="ch32index13"></A><A NAME="ch32index14"></A><A NAME="ch32index15"></A></P>
<A NAME="ch32list01"></A><H5 class="docExampleTitle">Listing 32.1. Image Copy JCL</H5>

<PRE>
//DB2JOBU JOB (UTILITY),'FULL IMAGE COPY',CLASS=X,MSGCLASS=X,
//         NOTIFY=USER
//*
//****************************************************************
//*
//*        DB2 COPY UTILITY::FULL COPY
//*
//****************************************************************
//*
//COPY EXEC DSNUPROC,SYSTEM=DSN,UID='FULLCOPY',UTPROC="
//*
//DSNUPROC.COPY1 DD DSN=CAT.FULLCOPY.SEQ.DATASET1(+1),
//       DISP=(MOD,CATLG),DCB=SYS1.MODEL,
//       SPACE=(CYL,(5,2),RLSE),UNIT=3390
//DSNUPROC.COPY2 DD DSN=CAT.FULLCOPY.SEQ.DATASET2(+1),
//       DISP=(MOD,CATLG),DCB=SYS1.MODEL,
//       SPACE=(CYL,(5,2),RLSE),UNIT=3390
//DSNUPROC.SYSIN    DD  *
    COPY TABLESPACE DSN8D881A.DSN8S881D
         COPYDDN (COPY1, COPY2)
         SHRLEVEL REFERENCE
         DSNUM ALL   FULL YES
/*
//
</PRE><BR>

<A NAME="ch32list02"></A><H5 class="docExampleTitle">Listing 32.2. Incremental Image Copy JCL</H5>

<PRE>
//DB2JOBU JOB (UTILITY),'INCREMENTAL COPY',CLASS=X,MSGCLASS=X,
//         NOTIFY=USER<A NAME="ch32index16"></A><A NAME="ch32index17"></A><A NAME="ch32index18"></A><A NAME="ch32index19"></A><A NAME="ch32index20"></A>
//*
//****************************************************************
//*
//*        DB2 COPY UTILITY :: INCREMENTAL COPY
//*
//****************************************************************
//*
//COPY EXEC DSNUPROC,SYSTEM=DSN,UID='INCRCOPY',UTPROC="
//*
//DSNUPROC.SYSCOPY DD DSN=CAT.INCRCOPY.SEQ.DATASET(+1),
//       DISP=(MOD,CATLG),DCB=SYS1.MODEL,
//       SPACE=(CYL,(2,2),RLSE),UNIT=3380
//DSNUPROC.SYSIN    DD  *
    COPY TABLESPACE DSN8D881A.DSN8S881D SHRLEVEL REFERENCE
         DSNUM ALL   FULL NO
/*
//
</PRE><BR>

<P class="docText"><A class="docLink" HREF="#ch32list03">Listing 32.3</A> provides sample JCL for taking a full image copy of an index. There are two options that can be used to specify an index in the <TT>COPY SYSIN</TT>—the <TT>INDEX</TT> name or the <TT>INDEXSPACE</TT> name. The <TT>INDEX</TT> name option requires specifying the index as <span class="docEmphasis"><TT>creator.index-name</TT></span>; the <TT>INDEXSPACE</TT> option requires specifying it as <span class="docEmphasis"><TT>database.indexspace-name</TT></span>. Favor using the <TT>INDEXSPACE</TT> option over the <TT>INDEX</TT> name. When using the <TT>INDEX</TT> option DB2 has to resolve the index space name from the index name. If you specify the index space name using the <TT>INDEXSPACE</TT> option, DB2 will already have the index space name.<A NAME="ch32index21"></A><A NAME="ch32index22"></A><A NAME="ch32index23"></A></P>
<A NAME="ch32note02"></A><div class="docNote"><p class="docNoteTitle">NOTE</p>

<P class="docText">It is a good practice to limit the index name to 8 characters. By doing so DB2 will use the index name as the index space name, thereby simplifying administration.</P></div><br>
<A NAME="ch32list03"></A><H5 class="docExampleTitle">Listing 32.3. Index Copy JCL</H5>

<PRE>
//DB2JOBU JOB (UTILITY),INDEX COPY',CLASS=X,MSGCLASS=X,<A NAME="ch32index24"></A><A NAME="ch32index25"></A><A NAME="ch32index26"></A><A NAME="ch32index27"></A><A NAME="ch32index28"></A>
//         NOTIFY=USER
//*
//****************************************************************
//*
//*        DB2 COPY UTILITY :: INDEX COPY
//*
//****************************************************************
//*
//COPY EXEC DSNUPROC,SYSTEM=DSN,UID='INDXCOPY',UTPROC="
//*
//DSNUPROC.SYSCOPY DD DSN=CAT.INDXCOPY.SEQ.DATASET(+1),
//       DISP=(MOD,CATLG),DCB=(SYS1.MODEL,BUFNO=20),
//       SPACE=(CYL,(1,1),RLSE),UNIT=3390
//DSNUPROC.SYSIN    DD  *
    COPY INDEXSPACE DSN8D881A.XPROJ1
         SHRLEVEL REFERENCE
/*
//<A NAME="ch32index29"></A><A NAME="ch32index30"></A><A NAME="ch32index31"></A>
</PRE><BR>

<A NAME="ch32lev2sec1"></A><H4 class="docSection2Title"><TT>COPY</TT> Phases</H4>
<P class="docText">The <TT>COPY</TT> utility has three phases:</P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5"><COLGROUP><COL width="110"><COL width="440"></COLGROUP><THEAD></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>UTILINIT</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Sets up and initializes the <TT>COPY</TT> utility<A NAME="ch32index32"></A><A NAME="ch32index33"></A><A NAME="ch32index34"></A></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REPORT</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Reporting for the <TT>CHANGELIMIT</TT> option</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>COPY</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Copies the table space or index data to the sequential file specified in the <TT>SYSCOPY</TT> DD statement</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>UTILTERM</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Performs the final utility cleanup</P></TD></TR></TABLE></P><br>
<A NAME="ch32lev2sec2"></A><H4 class="docSection2Title">Calculating <TT>SYSCOPY</TT> Data Set Size</H4>
<P class="docText">To create a valid image copy, the <TT>COPY</TT> utility requires that the <TT>SYSCOPY</TT> data set be allocated. The following formula calculates the proper size for this data set:<A NAME="ch32index35"></A><A NAME="ch32index36"></A><A NAME="ch32index37"></A><A NAME="ch32index38"></A><A NAME="ch32index39"></A></P>
<pre>

</pre><BR><pre>
SYSCOPY = (number of formatted pages) x 4096
</pre><BR>
<A NAME="ch32note03"></A><div class="docNote"><p class="docNoteTitle">NOTE</p>

<P class="docText">For segmented table spaces, empty formatted pages are not copied. This will reduce the size of the backup data set.</P></div><br>
<P class="docText">If the table space being copied uses 32K pages, multiply the result of the preceding calculation by 8. The total number of pages used by a table space can be retrieved from the VSAM <TT>LISTCAT</TT> command or from the DB2 Catalog as specified in the <TT>NACTIVEF</TT> column in <TT>SYSIBM.SYSTABLESPACE</TT>. When copying a single partition, use the <TT>NACTIVE</TT> column in <TT>SYSIBM.SYSTABSTATS</TT> to estimate the backup size.</P>
<P class="docText">If you use the DB2 Catalog statistics, ensure that the statistics are current by running the <TT>RUNSTATS</TT> utility (discussed in <A class="docLink" HREF="ch34.html#ch34">Chapter 34</A>, "Catalog Manipulation Utilities").</P>
<P class="docText">After calculating the estimated size in bytes for this data set, convert the number to cylinders, rounding up to the next whole cylinder. Allocating data sets used by DB2 utilities in cylinder increments enhances the utility's performance.<A NAME="ch32index40"></A><A NAME="ch32index41"></A><A NAME="ch32index42"></A><A NAME="ch32index43"></A><A NAME="ch32index44"></A></P>
<table width="90%" border="0" cellspacing="0" cellpadding="1"><tr><td width="60" valign="top"><IMG BORDER="0" width="30" height="18" SRC="images/0672326132/graphics/V7_icon.gif" ALT="graphics/V7_icon.gif"></td><td valign="top"><P class="docText"> Of course, you can choose to use dynamic allocation and templates as of DB2 V7 instead of manually specifying data sets in your utility JCL.</P></td></tr></table><br>
<A NAME="ch32lev2sec3"></A><H4 class="docSection2Title"><TT>COPY</TT> Locking Considerations</H4>
<P class="docText">Copies running against the different partitions of the same table space can run concurrently. Many other utilities can run concurrently with <TT>COPY</TT>, as well.<A NAME="ch32index45"></A><A NAME="ch32index46"></A><A NAME="ch32index47"></A><A NAME="ch32index48"></A></P>
<P class="docText"><TT>COPY TABLESPACE</TT> (whether <TT>SHRLEVEL REFERENCE</TT> or <TT>SHRLEVEL CHANGE</TT>) can run concurrently with the following utilities (each accessing the same object):<A NAME="ch32index49"></A><A NAME="ch32index50"></A><A NAME="ch32index51"></A><A NAME="ch32index52"></A></P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5"><COLGROUP><COL width="341"><COL width="209"></COLGROUP><THEAD></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>BACKUP SYSTEM</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CHECK INDEX</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CHECK LOB</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>COPY INDEXSPACE</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>DIAGNOSE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REBUILD INDEX</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RECOVER INDEX</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REORG INDEX</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REPORT</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REORG UNLOAD ONLY</TT> or <TT>UNLOAD EXTERNAL</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RUNSTATS INDEX</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RUNSTATS TABLESPACE</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>STOSPACE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>UNLOAD</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REPAIR LOCATE (KEY, RID, PAGE, DUMP or VERIFY)</TT></P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD></TR></TABLE></P><br>
<P class="docText">Furthermore, the <TT>COPY TABLESPACE</TT> utility can run concurrently with <TT>REPAIR LOCATE INDEX</TT> (<TT>PAGE REPLACE</TT>) and <TT>QUIESCE</TT>, but only when specifying <TT>SHRLEVEL REFERENCE</TT>.</P>
<P class="docText"><TT>COPY INDEXSPACE</TT> (whether <TT>SHRLEVEL REFERENCE</TT> or <TT>SHRLEVEL CHANGE</TT>) can run concurrently with the following utilities (each accessing the same object):</P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5"><COLGROUP><COL width="363"><COL width="187"></COLGROUP><THEAD></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>BACKUP SYSTEM</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CHECK DATA</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CHECK INDEX</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CHECK LOB</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>COPY TABLESPACE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>DIAGNOSE</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RECOVER TABLESPACE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REPORT</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RUNSTATS INDEX</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>RUNSTATS TABLESPACE</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>STOSPACE</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>UNLOAD</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REORG TABLESPACE UNLOAD ONLY</TT> or <TT>EXTERNAL</TT></P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REPAIR LOCATE</TT> (<TT>KEY</TT>, <TT>RID</TT>, <TT>PAGE</TT>, <TT>DUMP</TT> or <TT>VERIFY</TT>)</P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REPAIR LOCATE TABLESPACE PAGE REPLACE</TT></P></TD><TD class="docTableCell" align="left" valign="top">&nbsp;</TD></TR></TABLE></P><br>
<P class="docText">Furthermore, the <TT>COPY INDEXSPACE</TT> utility can run concurrently with <TT>QUIESCE</TT>, but only when run specifying <TT>SHRLEVEL REFERENCE</TT>.</P>
<P class="docText">The <TT>COPY</TT> utility with the <TT>SHRLEVEL REFERENCE</TT> option drains the write claim class for the table space, partition, or index. This enables concurrent SQL read access. When <TT>SHRLEVEL CHANGE</TT> is specified, the <TT>COPY</TT> utility will claim the read claim class. Concurrent read and write access is permitted with one exception. A <TT>DELETE</TT> with no <TT>WHERE</TT> clause is not permitted on a table in a segmented table space while <TT>COPY SHRLEVEL CHANGE</TT> is running.<A NAME="ch32index53"></A><A NAME="ch32index54"></A><A NAME="ch32index55"></A><A NAME="ch32index56"></A><A NAME="ch32index57"></A><A NAME="ch32index58"></A><A NAME="ch32index59"></A><A NAME="ch32index60"></A></P>
<A NAME="ch32lev2sec4"></A><H4 class="docSection2Title"><TT>COPY</TT> Guidelines</H4>
<P class="docText">You can use the following tips and techniques to ensure that the <TT>COPY</TT> utility is used effectively at your organization.</P>
<A NAME="ch32lev4sec1"></A><H5 class="docSection3Title">Increase Performance Using Inline Copies</H5>
<P class="docText">The IBM DB2 <TT>LOAD</TT> and <TT>REORG</TT> utilities can take inline image copies during regular utility processing. By taking advantage of this capability, overall performance is enhanced because fewer scans of the data are required to produce the image copy data sets.<A NAME="ch32index61"></A><A NAME="ch32index62"></A><A NAME="ch32index63"></A><A NAME="ch32index64"></A></P>
<A NAME="ch32lev4sec2"></A><H5 class="docSection3Title">Balance the Use of Incremental and Full Image Copies</H5>
<P class="docText">For most application table spaces, favor the creation of full image copies over incremental image copies. The time saved by incremental copying is often minimal, but the additional work to recover using incremental copies is usually burdensome.<A NAME="ch32index65"></A><A NAME="ch32index66"></A><A NAME="ch32index67"></A><A NAME="ch32index68"></A><A NAME="ch32index69"></A></P>
<P class="docText">To reduce the batch processing window, use incremental image copies for very large table spaces that incur only a small number of modifications between image copy runs. However, base the decision to use incremental image copies rather than full image copies on the percentage of table space pages that have been modified, not on the number of rows that have been modified. The image copy utility reports on the percentage of pages modified, so you can monitor this number. Consider using incremental image copies if this number is consistently small (for example, less than 20%).</P>
<P class="docText">You should consider incremental copying as the table space becomes larger and the batch window becomes smaller.</P>
<A NAME="ch32lev4sec3"></A><H5 class="docSection3Title">Take Full Image Copies to Encourage Sequential Prefetch</H5>
<P class="docText">Remember that DB2 utilities requiring sequential data access use sequential prefetch, thereby enhancing utility performance. Thus, full image copies can be quicker than incremental image copies. A full image copy sequentially reads every page to create the image copy. An incremental image copy must check page bits to determine whether data has changed, and then access only the changed pages.<A NAME="ch32index70"></A><A NAME="ch32index71"></A><A NAME="ch32index72"></A><A NAME="ch32index73"></A></P>
<P class="docText">When incremental image copying does not use sequential prefetch, full image copying can be more efficient. Extra time is used because of the additional <TT>MERGECOPY</TT> step and the potentially inefficient processing (that is, without sequential prefetch). Compare the performance of incremental and full image copies before deciding to use incremental image copies.</P>
<A NAME="ch32lev4sec4"></A><H5 class="docSection3Title">Take Full Image Copies for Active and Smaller Table Spaces</H5>
<P class="docText">Take full image copies for table spaces in which 40% or more of the pages are modified between executions of the <TT>COPY</TT> utility.<A NAME="ch32index74"></A><A NAME="ch32index75"></A><A NAME="ch32index76"></A><A NAME="ch32index77"></A></P>
<P class="docText">Always take full image copies of table spaces that contain less than 50,000 4K pages. For table spaces with larger page sizes, factor in the page size to arrive at a lower limit—for example, 25,000 8K pages.</P>
<A NAME="ch32lev4sec5"></A><H5 class="docSection3Title">Specify <TT>SHRLEVEL REFERENCE</TT> to Reduce Recovery Time</H5>
<P class="docText"><TT>COPY</TT> specifying <TT>SHRLEVEL REFERENCE</TT> rather than <TT>SHRLEVEL CHANGE</TT>. This reduces the time for table space recovery. See the section titled "<A class="docLink" HREF="ch32lev1sec6.html#ch32lev2sec20"><TT>RECOVER TABLESPACE</TT> Guidelines</A>" later in this chapter.</P>
<P class="docText">Running <TT>COPY</TT> with <TT>SHRLEVEL CHANGE</TT> can cause uncommitted data to be recorded on the copy. For this reason, recovering to a <TT>SHRLEVEL CHANGE</TT> copy using the <TT>TOCOPY</TT> option is not recommended.<A NAME="ch32index78"></A><A NAME="ch32index79"></A><A NAME="ch32index80"></A><A NAME="ch32index81"></A><A NAME="ch32index82"></A><A NAME="ch32index83"></A></P>
<P class="docText">An additional reason to avoid <TT>SHRLEVEL CHANGE</TT> is the impact on the performance of the <TT>COPY</TT> utility. Because other users can access the table space being copied, the performance of the <TT>COPY</TT> utility may degrade because of concurrent access. Note, however, that <TT>SHRLEVEL REFERENCE</TT> has only a performance advantage—not an integrity advantage—over <TT>SHRLEVEL CHANGE</TT>.</P>
<A NAME="ch32note04"></A><div class="docNote"><p class="docNoteTitle">CAUTION</p>

<P class="docText">The integrity of <TT>SHRLEVEL REFERENCE</TT> and <TT>SHRLEVEL CHANGE</TT> backups are the same if the archive logs exist. In practice, test archive logs are not kept for long periods of time. At any rate, if you are using <TT>SHRLEVEL CHANGE</TT> be sure to institute a proper retention period for your archive logs to maintain the viability of the backups.</P></div><br>
<A NAME="ch32lev4sec6"></A><H5 class="docSection3Title">Code JCL Changes to Make <TT>COPY</TT> Restartable</H5>
<P class="docText">To make the <TT>COPY</TT> utility restartable, specify the <TT>SYSCOPY DD</TT> statement as <TT>DISP=(MOD,CATLG,CATLG)</TT>. When restarting the <TT>COPY</TT> utility, change the data set disposition to <TT>DISP=(MOD,KEEP,KEEP)</TT>.<A NAME="ch32index84"></A><A NAME="ch32index85"></A><A NAME="ch32index86"></A><A NAME="ch32index87"></A></P>
<A NAME="ch32lev4sec7"></A><H5 class="docSection3Title">Create a Consistent Recovery Point</H5>
<P class="docText">Be sure to <TT>QUIESCE</TT> all table spaces in the table space set before copying. Do this even when some table spaces do not need to be copied so you can provide a consistent point of recovery for all referentially related table spaces. Do so by creating a batch job stream with the following steps:<A NAME="ch32index88"></A><A NAME="ch32index89"></A><A NAME="ch32index90"></A><A NAME="ch32index91"></A></P>
<A NAME="ch32pr01"></A>



<div style="font-weight:bold"><OL class="docList" START="1"><LI value="1"><div style="font-weight:normal"><TT>START</TT> all table spaces in the table space set using <TT>ACCESS(UT)</TT> or <TT>ACCESS(RO)</TT>. Starting the table spaces in RO mode enables concurrent read access while the <TT>COPY</TT> is running.<BR><BR></div></LI><LI value="2"><div style="font-weight:normal"><TT>QUIESCE</TT> all table spaces in the table space set.<BR><BR></div></LI><LI value="3"><div style="font-weight:normal">Execute the <TT>COPY</TT> utility for all table spaces to be copied.<BR><BR></div></LI><LI value="4"><div style="font-weight:normal"><TT>START</TT> all table spaces in the table space set using <TT>ACCESS(RW)</TT>.<BR><BR></div></LI></OL></div>
<A NAME="ch32note05"></A><div class="docNote"><p class="docNoteTitle">NOTE</p>

<P class="docText">The consistent backup created by this series of steps is ideal for populating a test environment (using <TT>DSN1COPY</TT>).</P></div><br>
<A NAME="ch32lev4sec8"></A><H5 class="docSection3Title">Consider Creating DASD Image Copies</H5>
<P class="docText">Consider using disk rather than tape for image copy <TT>SYSCOPY</TT> data sets that will remain at the local site for recovery. This speeds the <TT>COPY</TT> process; disk is faster than tape, and you eliminate the time it takes the operator (or the automated robot tape loader) to load a new tape on the tape drive.<A NAME="ch32index92"></A><A NAME="ch32index93"></A><A NAME="ch32index94"></A><A NAME="ch32index95"></A></P>
<P class="docText">Be sure to verify that the image copy is placed on a separate DASD volume from the table space or index being copied. Failure to do so can result in a disk failure that affects both the data and its image copy. Also, as a failsafe, consider taking dual image copies where one is made to disk and the other is made to tape.</P>
<A NAME="ch32lev4sec9"></A><H5 class="docSection3Title">Consider Copying Indexes</H5>
<P class="docText">The <TT>REBUILD</TT> process can take a long time to complete for large amounts of data or when multiple indexes exist. As of V6, you can take a full image copy or a concurrent copy of an index. Instead of rebuilding indexes during recovery, you use the <TT>RECOVER</TT> utility to restore the image copy and apply log records.<A NAME="ch32index96"></A><A NAME="ch32index97"></A><A NAME="ch32index98"></A><A NAME="ch32index99"></A><A NAME="ch32index100"></A></P>
<A NAME="ch32note06"></A><div class="docNote"><p class="docNoteTitle">NOTE</p>

<P class="docText">You must specify the <TT>COPY YES</TT> parameter when creating an index to be able to use the <TT>COPY</TT> utility to make image copy backups for the index. The default is <TT>COPY NO</TT>. Existing indexes can be altered to specify the <TT>COPY YES</TT> parameter. If the index is defined using <TT>COPY YES</TT> you can use either the <TT>REBUILD</TT> method or the <TT>COPY</TT> and <TT>RECOVER</TT> method for index recovery.</P></div><br>
<P class="docText">The following utilities can place an index that was defined with the <TT>COPY YES</TT> attribute in the informational <TT>COPY</TT> pending (<TT>ICOPY</TT>) status:</P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5"><COLGROUP><COL width="275"><COL width="275"></COLGROUP><THEAD></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>LOAD TABLE</TT> (<TT>LOG YES</TT> or <TT>NO</TT>)</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REBUILD INDEX</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REORG TABLESPACE</TT> (<TT>LOG YES</TT> or <TT>NO</TT>)</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>REORG INDEX</TT></P></TD></TR></TABLE></P><br>
<P class="docText">To remove the <TT>ICOPY</TT> status, create a full image copy of the index after running these utilities.</P>
<A NAME="ch32lev4sec10"></A><H5 class="docSection3Title">Synchronize Data and Index Copies</H5>
<P class="docText">If you decide to use <TT>COPY</TT> and <TT>RECOVER</TT> for indexes, instead of rebuilding indexes after recovering table spaces, be sure to keep the data and index backups synchronized. When you <TT>COPY</TT> a table space, be sure to also <TT>COPY</TT> any associated indexes defined with <TT>COPY YES</TT>.<A NAME="ch32index101"></A><A NAME="ch32index102"></A><A NAME="ch32index103"></A><A NAME="ch32index104"></A><A NAME="ch32index105"></A><A NAME="ch32index106"></A></P>
<A NAME="ch32lev4sec11"></A><H5 class="docSection3Title">Buffer the <TT>SYSCOPY</TT> Data Set Appropriately</H5>
<P class="docText">For large image copies set the <TT>BUFNO</TT> parameter in the JCL for the <TT>SYSCOPY</TT> DD statement to a number greater than 20. The <TT>BUFNO</TT> parameter creates read and write buffers in main storage for the data set, thereby enhancing the performance of the <TT>COPY</TT> utility. Ensure that sufficient memory (real or expanded) is available, however, before increasing the <TT>BUFNO</TT> specification for your <TT>SYSCOPY</TT> data sets.<A NAME="ch32index107"></A><A NAME="ch32index108"></A><A NAME="ch32index109"></A><A NAME="ch32index110"></A><A NAME="ch32index111"></A><A NAME="ch32index112"></A></P>
<A NAME="ch32lev4sec12"></A><H5 class="docSection3Title">Favor Dual Image Copies</H5>
<P class="docText">Take dual image copies for every table space (and index) being copied to eliminate the possibility of an invalid image copy due to an I/O error or damaged tape.</P>
<P class="docText">Prepare for disasters by sending additional image copies off-site. It is a wise course of action to take dual offsite copies, in addition to dual local image copies.<A NAME="ch32index113"></A><A NAME="ch32index114"></A><A NAME="ch32index115"></A><A NAME="ch32index116"></A></P>
<A NAME="ch32lev4sec13"></A><H5 class="docSection3Title">Compress Image Copies</H5>
<P class="docText">To conserve tapes, consider compressing image copies. Use the silo compression if it's available. Additionally, third-party tools are available to compress data on tape cartridges.<A NAME="ch32index117"></A><A NAME="ch32index118"></A><A NAME="ch32index119"></A><A NAME="ch32index120"></A><A NAME="ch32index121"></A></P>
<P class="docText">Compressing image copy data sets not only saves tapes, but can improve performance. If a backup requires fewer tapes, fewer tape mounts will be required, which should reduce overall elapsed time. The same can be said for the recovery process. If fewer tapes are required to <TT>RECOVER</TT>, elapsed time should improve.</P>
<P class="docText">If your shop does not compress cartridges by default, add the following parameter to the <TT>DCB</TT> specification for the <TT>SYSCOPY DD</TT>:</P>
<pre>

</pre><BR><pre>
DCB=TRTCH=COMP
</pre><BR>
<A NAME="ch32lev4sec14"></A><H5 class="docSection3Title">Use <TT>CHANGELIMIT</TT> to Help with Copies</H5>
<P class="docText">The <TT>CHANGELIMIT</TT> parameter can be specified on the <TT>COPY</TT> utility. When <TT>CHANGELIMIT</TT> is specified, <TT>COPY</TT> analyzes the number of changed pages since the last copy.<A NAME="ch32index122"></A><A NAME="ch32index123"></A><A NAME="ch32index124"></A><A NAME="ch32index125"></A><A NAME="ch32index126"></A></P>
<P class="docText"><TT>CHANGELIMIT</TT> accepts one or two integers (from 0 to 100) as input. Each integer is a percentage. If only one value is specified, an incremental image copy will be created if the percentage of changed pages is greater than 0 and less than the specified value. A full image copy will be created if the percentage of changed pages is greater than or equal to the specified percentage, or if <TT>CHANGELIMIT(0)</TT> is specified. No image copy will be created if there were no changed pages, unless 0 was specified for the <TT>CHANGELIMIT</TT>.</P>
<P class="docText">If two values are specified, an incremental image copy will be created if the percentage of changed pages is greater than the lowest value specified and less than the highest value specified. A full image copy will be created if the percentage of changed pages is equal to or greater than the highest value specified. No image copy will be created if the percentage of changed pages is outside the range of the low percentage and high percentage specified. If the two percentages happen to be the same, it will follow the rules as if one value was specified, as stated previously. When <TT>CHANGELIMIT</TT> is specified with <TT>COPY</TT>, return codes are set as indicated in <A class="docLink" HREF="#ch32table01">Table 32.1</A>.</P>
<A NAME="ch32note07"></A><div class="docNote"><p class="docNoteTitle">CAUTION</p>

<P class="docText">You cannot specify <TT>CHANGELIMIT</TT> when copying a table space or partition defined as <TT>TRACKMOD NO</TT>.<A NAME="ch32index127"></A><A NAME="ch32index128"></A><A NAME="ch32index129"></A><A NAME="ch32index130"></A><A NAME="ch32index131"></A></P></div><br>
<A NAME="ch32table01"></A><P><TABLE CELLSPACING="0" FRAME="hsides" RULES="groups" CELLPADDING="5"><CAPTION><h5 class="docTableTitle">Table 32.1. <TT>COPY/CHANGELIMIT</TT> Return Codes</h5></CAPTION><COLGROUP><COL width="121"><COL width="429"></COLGROUP><THEAD><TR><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Return Code</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Description</span></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>1</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No <TT>CHANGELIMIT</TT> percentage is met; no image copy is recommended or taken.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>2</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The percentage of changed pages is greater than the low <TT>CHANGELIMIT</TT> value, but less than the high <TT>CHANGELIMIT</TT> value; incremental copy is recommended or taken.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>3</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The percentage of changed pages is greater than or equal to the high <TT>CHANGELIMIT</TT> value; full image copy is recommended or taken.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>8</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The <TT>COPY</TT> step failed.</P></TD></TR></TABLE></P><br>
<P class="docText">If <TT>REPORTONLY</TT> is specified, a report of the number of changed pages is produced. Further action can be taken after reviewing the report or checking the return code in the JCL.</P>
<P class="docText">Without the <TT>REPORTONLY</TT> parameter, the <TT>COPY</TT> utility automatically decides whether or not to take an image copy—if it does take an image copy, the <TT>COPY</TT> utility determines if the image is to be incremental or full. Consider using the return code to check the type of <TT>COPY</TT> that was created, and run a <TT>MERGECOPY</TT> step only if the return code indicates an incremental copy was created.<A NAME="ch32index132"></A><A NAME="ch32index133"></A><A NAME="ch32index134"></A><A NAME="ch32index135"></A><A NAME="ch32index136"></A></P>
<A NAME="ch32lev4sec15"></A><H5 class="docSection3Title">Consider Using <TT>LISTDEF</TT> to Copy RI-Related Objects</H5>

<P class="docText">The <TT>LISTDEF</TT> option can be very useful when used with the <TT>COPY</TT> utility. This is especially so when you need to copy a complete set of referentially related table spaces. You can use the <TT>RI</TT> parameter on the <TT>INCLUDE</TT> statement of the <TT>LISTDEF</TT> to cause all tables that are referentially connected to tables specified in the list to also be included. For example:<A NAME="ch32index137"></A><A NAME="ch32index138"></A><A NAME="ch32index139"></A><A NAME="ch32index140"></A><A NAME="ch32index141"></A><A NAME="ch32index142"></A></P>
<pre>

</pre><BR><pre>
LISTDEF LSTR1 INCLUDE TABLESPACES
        TABLESPACE DSN8D81A.DSN8S81E  RI
</pre><BR>
<P class="docText">This list will include all table spaces that include tables referentially related to any tables in the <TT>DSN8S81E</TT> table space of the sample database. This is much easier to manage than a job built to explicitly copy each of these table spaces—and it will include any new related table space as soon as it is created.</P>
<A NAME="ch32lev4sec16"></A><H5 class="docSection3Title">Control System Page Placement</H5>

<P class="docText">As of DB2 V8, you can use the <TT>SYSTEMPAGES</TT> parameter to exert some control over the placement of system pages in your image copy data sets. System pages are necessary when using the <TT>UNLOAD</TT> utility to unload data from an image copy. To ensure that the header, dictionary, and DB2 version system pages are copied at the beginning of the image copy data set, simply code <TT>SYSTEMPAGES YES</TT> on your <TT>COPY</TT> utility control card.<A NAME="ch32index143"></A><A NAME="ch32index144"></A><A NAME="ch32index145"></A><A NAME="ch32index146"></A><A NAME="ch32index147"></A></P>
<A NAME="ch32lev4sec17"></A><H5 class="docSection3Title">Consider Using DFSMS to Make Backup Copies</H5>
<P class="docText">DFSMS can be utilized in the backup and recovery strategy for DB2 table spaces and indexes. DB2 provides the capability to recover from backup copies of DB2 data sets taken using the concurrent copy feature of DFSMS.<A NAME="ch32index148"></A><A NAME="ch32index149"></A><A NAME="ch32index150"></A><A NAME="ch32index151"></A></P>
<P class="docText">DFSMS is invoked under the control of DB2 using the <TT>COPY</TT> utility (as of DB2 V4). This simplifies the process of utilizing DFSMS within your DB2 backup and recovery plan. DFSMS is invoked by specifying the <TT>CONCURRENT</TT> parameter on the <TT>COPY</TT> utility. The image copy data sets created by the <TT>COPY</TT> utility and DFSMS are stored in the DB2 Catalog (<TT>SYSIBM.SYSCOPY</TT>) with an <TT>ICTYPE</TT> of <TT>F</TT> and an <TT>STYPE</TT> of <TT>C</TT>.</P>
<A NAME="ch32note08"></A><div class="docNote"><p class="docNoteTitle">NOTE</p>

<P class="docText">An output data set for DFSMS messages must be specified to the <TT>DSSPRINT DD</TT> card when <TT>CONCURRENT</TT> copy is specified and the <TT>SYSPRINT DD</TT> card is defined to a data set.</P></div><br>
<A NAME="ch32note09"></A><div class="docNote"><p class="docNoteTitle">CAUTION</p><p><table width="90%" border="0" cellspacing="0" cellpadding="1"><tr><td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" width="30" height="18" SRC="images/0672326132/graphics/V8_icon.gif" ALT="graphics/V8_icon.gif"></td><td valign="top"><P class="docText">You cannot use <TT>SHRLEVEL CHANGE</TT> with <TT>CONCURRENT COPY</TT> for table spaces having a page size greater than 4K, unless the page size exactly matches the control interval size of the underlying VSAM data set.</P></td></tr></table></p></div><br>
<A NAME="ch32lev4sec18"></A><H5 class="docSection3Title">Consider Log Suspension</H5>

<P class="docText">As of DB2 V7 (or the V6 refresh), you can issue a <TT>SET LOG SUSPEND</TT> command to effectively suspend all data modification within a DB2 subsystem. The <TT>SET LOG SUSPEND</TT> command externalizes log buffers, takes a system checkpoint, updates the BSDS with the highest written RBA, and takes a log write latch to prevent updates. Subsequent writes from the buffer pool are not externalized until the <TT>SET LOG RESUME</TT> command is issued. This causes the write latch to be released thereby enabling logging and data modification to ensue.<A NAME="ch32index152"></A><A NAME="ch32index153"></A><A NAME="ch32index154"></A><A NAME="ch32index155"></A><A NAME="ch32index156"></A><A NAME="ch32index157"></A><A NAME="ch32index158"></A><A NAME="ch32index159"></A></P>
<P class="docText">By taking a snapshot of the entire system after issuing the <TT>SET LOG SUSPEND</TT> command, you will have created a snapshot that can be used for local or remote site recovery with consistent data. Use this technique only in conjunction with external copying technology such as that provided by RVA SnapShot or ESS FlashCopy.</P>
<P class="docText">The snapshot copy can be used in the event of a disaster to recover the system to a point of consistency. Alternatively, you can use it to provide a quick, consistent copy of your data point-in-time querying.</P>
<P class="docText">However, keep in mind that careful planning is required to minimize application impact of a log suspension. Avoid suspending log activity during periods of heavy data modification.</P>
<ul></ul></td></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch32.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch32lev1sec2.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
</body>
</html>
