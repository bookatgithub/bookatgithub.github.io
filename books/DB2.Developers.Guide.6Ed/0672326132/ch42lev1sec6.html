<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Two-Phase Commit</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch42lev1sec5.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch42lev1sec7.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch42lev1sec6"></A><H3 class="docSection1Title">Two-Phase Commit</H3>
<P class="docText">Distributed two-phase commit enables application programs to update data in multiple RDBMSs within a single unit of work. The two-phase commit process coordinates the commits across the multiple platforms. The two-phase commit provides a consistent outcome, guaranteeing the integrity of the data across platforms, regardless of communication or system failures.<A NAME="ch42index106"></A><A NAME="ch42index107"></A><A NAME="ch42index108"></A></P>
<A NAME="ch42lev2sec9"></A><H4 class="docSection2Title">Two-Phase Commit Terminology</H4>
<P class="docText">A syncpoint tree is built by the coordinator of a unit of work. The syncpoint tree determines which process is in control of the commit/abort decision.</P>
<P class="docText">Each node in the syncpoint tree is the coordinator of its own resources and of the nodes below it on the syncpoint tree. Additionally, a node is a participant of the node directly above it in the syncpoint tree.<A NAME="ch42index109"></A><A NAME="ch42index110"></A><A NAME="ch42index111"></A><A NAME="ch42index112"></A><A NAME="ch42index113"></A></P>
<P class="docText"><A class="docLink" HREF="#ch42fig01">Figure 42.1</A> shows an example of a syncpoint tree. In this example, <TT>DB2V</TT> is the coordinator for <TT>DB2W</TT>, <TT>DB2X</TT>, and <TT>DB2Y</TT>. In addition, <TT>DB2W</TT> is the coordinator for <TT>DB2Z</TT>.</P>
<A NAME="ch42fig01"></A><p><CENTER><H5 class="docFigureTitle">Figure 42.1. A two-phase commit syncpoint tree.</H5>
<p class="docText"><IMG BORDER="0" width="500" height="307" SRC="images/0672326132/graphics/42fig01.gif" ALT="graphics/42fig01.gif"></p></CENTER></p><br>
<P class="docText">Keep these terms in mind as I discuss the two-phase commit process in this chapter.</P>
<A NAME="ch42lev2sec10"></A><H4 class="docSection2Title">What Are the Two Phases?</H4>
<P class="docText">The two phases in the two-phase commit process are</P>
<div style="font-weight:bold"><OL class="docList" TYPE="1"><LI><div style="font-weight:normal"><P class="docList">Preparation</P></div></LI><LI><div style="font-weight:normal"><P class="docList">Actual commit</P></div></LI></OL></div>
<P class="docText">The first phase is the preparation phase. Each participant in the two-phase commit process is informed to get ready to commit. The preparation phase uses the <span class="docEmphasis">presumed abort</span> protocol. All affected modifications at all locations within the unit of work therefore are rolled back if an error is encountered.<A NAME="ch42index114"></A><A NAME="ch42index115"></A><A NAME="ch42index116"></A><A NAME="ch42index117"></A><A NAME="ch42index118"></A><A NAME="ch42index119"></A></P>
<P class="docText">Each participant informs the coordinator when it has successfully written the appropriate log records and is therefore ready to commit (or roll back) all changes. Usually, this process is followed by a commit. However, if any participant fails to commit, the coordinator may need to back out all changes for all participants.</P>
<P class="docText">During phase 1, each participant returns a "vote" on whether commit can proceed. Each participant returns one of the following votes:</P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5"><COLGROUP><COL width="225.5"><COL width="324.5"></COLGROUP><THEAD></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>YES</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The participant and all dependent nodes are ready for <TT>COMMIT</TT> or <TT>ABORT</TT> processing.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>READ-ONLY</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">The participant and all dependent nodes are read-only and do not need to participate in the two-phase commit process.</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>NO</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">One or more nodes in the syncpoint tree failed to return a <TT>YES</TT> or <TT>READ-ONLY</TT> vote. A communication failure or error is recorded as a <TT>NO</TT> vote.</P></TD></TR></TABLE></P><br>
<P class="docText">If all votes are <TT>READ-ONLY</TT>, a <TT>COMMIT</TT> is not necessary because no updates were performed. If all the votes are <TT>YES</TT> and <TT>READ-ONLY</TT>, the <TT>COMMIT</TT> can be processed. If any vote is <TT>NO</TT>, the unit of work is rolled back.</P>
<P class="docText">After all the participants are ready to commit, phase 1 is complete. Therefore, the second phase—the actual commit—is initiated. During phase 2, success is presumed, even in the case of system failure. Because all participants have elected to continue the commit, success can be presumed with no danger of data integrity violations.<A NAME="ch42index120"></A><A NAME="ch42index121"></A><A NAME="ch42index122"></A><A NAME="ch42index123"></A></P>
<P class="docText">The actual commit phase is implemented as a series of communications between the coordinator and its subordinate participants.</P>
<P class="docText">The coordinator specifies that each participant that voted <TT>YES</TT> is free to permanently record the changed data and release all held locks. When the participant successfully completes this work, it responds back to the coordinator indicating that it has successfully committed the unit of work. The coordinator then logs that the participant has successfully committed.</P>
<P class="docText">Additionally, a process called <span class="docEmphasis">resynchronization</span> occurs during phase 2. Resynchronization resolves in-doubt logical units of work. An in-doubt logical unit of work has passed phase 1 but has not passed phase 2. This situation is typically caused by communication failures.<A NAME="ch42index124"></A></P>
<P class="docText">When a communication failure occurs causing in-doubt LUWs, locks may be held, causing system timeouts and deadlocks. For this reason, waiting for the automatic DB2 resynchronization may not be feasible. Therefore, you also can initiate resynchronization manually. You do so by using the <TT>RECOVER INDOUBT</TT> command, as in this example:</P>
<pre>

</pre><BR><pre>
RECOVER INDOUBT ACTION(COMMIT) ID(1031)
</pre><BR>
<P class="docText">This command schedules a commit for the threads identified by the correlation ID of <TT>1031</TT>. The <TT>ACTION</TT> parameter can be either <TT>COMMIT</TT> or <TT>ABORT</TT>. The decision whether to commit or abort must be made by the analyst issuing the <TT>RECOVER</TT>. For this reason, manual resynchronization should be initiated only when absolutely necessary. Automatic DB2 resynchronization is generally more efficient and accurate.<A NAME="ch42index125"></A><A NAME="ch42index126"></A><A NAME="ch42index127"></A><A NAME="ch42index128"></A></P>
<P class="docText">When resynchronization is complete for all the two-phase commit participants, the two-phase commit is complete.</P>
<A NAME="ch42lev3sec4"></A><H5 class="docSection3Title">Multi-Site Updating</H5>
<P class="docText">The presence of the two-phase commit process within DB2 enables multi-site updating capability. The two-phase commit occurs when data at more than one remote location is modified (<TT>INSERT</TT>, <TT>UPDATE</TT>, and/or <TT>DELETE</TT>).<A NAME="ch42index129"></A><A NAME="ch42index130"></A><A NAME="ch42index131"></A><A NAME="ch42index132"></A><A NAME="ch42index133"></A></P>
<P class="docText">The two-phase commit process ensures that data at all remote locations is consistent and recoverable.</P>
<P class="docText">A multi-site update is possible, regardless of how you attach to DB2:</P>
<UL><LI><P class="docList">CAF</P></LI><LI><P class="docList">CICS</P></LI><LI><P class="docList">IMS/TM</P></LI><LI><P class="docList">TSO</P></LI></UL>
<A NAME="ch42lev3sec5"></A><H5 class="docSection3Title">One-Phase or Two-Phase Commit</H5>
<P class="docText">Two-phase commit is optional. However, if you need to implement applications that perform multi-site updates within a single unit of work, two-phase commit is mandatory. The <TT>SYNCLVL=SYNCPT</TT> parameter must be specified on the VTAM <TT>APPL</TT> definition statement to configure DB2's communication support for two-phase commit.<A NAME="ch42index134"></A><A NAME="ch42index135"></A><A NAME="ch42index136"></A><A NAME="ch42index137"></A><A NAME="ch42index138"></A><A NAME="ch42index139"></A></P>
<A NAME="ch42lev2sec11"></A><H4 class="docSection2Title">Distributed Thread Support</H4>
<P class="docText">Successive versions of DB2 have provided enhanced thread support specifically to increase the performance and functionality of distributed applications.</P>
<A NAME="ch42lev3sec6"></A><H5 class="docSection3Title">Inactive DBATS</H5>
<P class="docText">To optimize performance of distributed processing, DB2 inactivates database access threads (DBATs) as needed instead of disconnecting them. Without this capability, each thread would have to repeatedly connect, process, and then disconnect. This would generate a significant amount of overhead.<A NAME="ch42index140"></A><A NAME="ch42index141"></A><A NAME="ch42index142"></A><A NAME="ch42index143"></A><A NAME="ch42index144"></A></P>
<P class="docText">A DBAT becomes inactive when <span class="docEmphasis">all</span> the following are true:</P>
<UL><LI><P class="docList">A commit or rollback was the last task performed.</P></LI><LI><P class="docList">No locks are being held by the thread.</P></LI><LI><P class="docList">The package being executed was bound specifying <TT>RELEASE(COMMIT)</TT>.</P></LI><LI><P class="docList"><TT>INACTIVE</TT> was specified for the DDF <TT>THREAD</TT> install parameter.</P></LI></UL>
<P class="docText">Inactive DBATs become active when they receive a message from VTAM. When the remote application shuts down, the thread is disconnected.</P>
<P class="docText">Keep in mind that the existence of inactive threads may cause the number of concurrent DB2 threads to increase substantially. The overall maximum number of concurrent threads (<TT>MAXDBAT</TT> + <TT>CONDBAT</TT>) can be 25,000, of which only 2,000 (<TT>CTHREAD</TT> + <TT>MAXDBAT</TT>) can be active. Refer to <A class="docLink" HREF="#ch42table02">Table 42.2</A> for a synopsis of the affected <TT>DSNZPARMs</TT>.</P>
<A NAME="ch42table02"></A><P><TABLE CELLSPACING="0" FRAME="hsides" RULES="groups" CELLPADDING="5"><CAPTION><h5 class="docTableTitle">Table 42.2. Thread Parameters</h5></CAPTION><COLGROUP><COL width="247.5"><COL width="302.5"></COLGROUP><THEAD><TR><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><span class="docEmphStrong">Definition</span></P></TH><TH class="bottomBorder thead" align="left" valign="top"><P class="docText"><TT>DSNZPARM</TT></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Local Threads</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CTHREAD</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Active DBATs</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>MAXDBAT</TT></P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">Inactive DBATs</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText"><TT>CONDBAT</TT><A NAME="ch42index145"></A><A NAME="ch42index146"></A><A NAME="ch42index147"></A><A NAME="ch42index148"></A><A NAME="ch42index149"></A></P></TD></TR></TABLE></P><br>
<A NAME="ch42lev3sec7"></A><H5 class="docSection3Title">Database Connection Pooling</H5>
<P class="docText">DB2 V6 added support for database connection pooling. In prior DB2 releases, when an application requester established a connection to DB2, a connection to the DB2 database was also established. For V6 and later releases, DB2 maintains a pool of database connections that can be reused to process requests from DRDA application requesters. The connection pool enables DB2 to support up to 150,000 DRDA connections to DB2. The connections in the pool are DBATs, referred to as type 2 inactive threads.<A NAME="ch42index150"></A><A NAME="ch42index151"></A><A NAME="ch42index152"></A><A NAME="ch42index153"></A><A NAME="ch42index154"></A><A NAME="ch42index155"></A></P>
<P class="docText">DB2 supports two types of inactive threads—type 1 and type 2. Type 2 inactive threads are only available for DRDA connections and use less storage than type 1 inactive threads. Type 2 inactive threads use a pool of DBATs that can be switched among connections as needed.</P>
<P class="docText">If you have a requirement to support more inbound remote connections than you have database access threads, you should consider using DDF inactive thread support. The following sections provide information on inactive thread support.</P>
<P class="docText">DB2 favors making inactive threads type 2. However, certain scenarios prohibit type 2 inactive threads. After a <TT>COMMIT</TT> or <TT>ROLLBACK</TT>, DB2 determines whether a thread can become inactive, and, if it can, whether it can become a type 1 or type 2 inactive thread. Refer to <A class="docLink" HREF="#ch42table03">Table 42.3</A> for a breakdown of when inactive threads can be type 2 or not.</P>
<A NAME="ch42table03"></A><P><TABLE CELLSPACING="0" FRAME="hsides" RULES="groups" CELLPADDING="5"><CAPTION><h5 class="docTableTitle">Table 42.3. Type 1 and Type 2 Inactive Threads</h5></CAPTION><COLGROUP><COL width="343.0693069306931"><COL width="103.46534653465348"><COL width="103.46534653465348"></COLGROUP><THEAD><TR><TH class="bottomBorder thead" align="left" valign="bottom"><P class="docText"><span class="docEmphStrong">Condition</span></P></TH><TH class="bottomBorder thead" align="left" valign="bottom"><P class="docText"><span class="docEmphStrong">Thread can beType 1</span></P></TH><TH class="bottomBorder thead" align="left" valign="bottom"><P class="docText"><span class="docEmphStrong">Thread can beType 2</span></P></TH></TR></THEAD><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">A hop to another location</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Yes</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Yes</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">A connection using DB2 private-protocol access</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Yes</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">A package that is bound specifying <TT>RELEASE(COMMIT)</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Yes</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Yes</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">A package that is bound specifying <TT>RELEASE(DEALLOCATE)</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">Yes</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">A held cursor or a held LOB locator</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No</P></TD></TR><TR><TD class="docTableCell" align="left" valign="top"><P class="docText">A package that is bound specifying <TT>KEEPDYNAMIC(YES)</TT></P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No</P></TD><TD class="docTableCell" align="left" valign="top"><P class="docText">No</P></TD></TR></TABLE></P><br>
<P class="docText">When a "Yes" is listed for a condition in <A class="docLink" HREF="#ch42table03">Table 42.3</A>, the thread can become inactive as the indicated type of inactive thread when a <TT>COMMIT</TT> is issued. After a <TT>ROLLBACK</TT>, a thread can become inactive, even if it had open cursors defined <TT>WITH HOLD</TT> or a held LOB locator because <TT>ROLLBACK</TT> closes all cursors and LOB locators.</P>
<P class="docText">If a thread is eligible to become a type 2 inactive thread, the thread is made inactive and the DBAT is eligible to be used by another connection. If the thread must become a type 1 inactive thread, DB2 first determines that the number of inactive threads will not exceed the installation limit set in <TT>DSNZPARMs</TT>. If the limit is not exceeded, the thread becomes inactive; if the limit would be exceeded, the thread remains active. If too many active threads exist, DB2 may terminate the thread and its connection.<A NAME="ch42index156"></A><A NAME="ch42index157"></A><A NAME="ch42index158"></A><A NAME="ch42index159"></A><A NAME="ch42index160"></A><A NAME="ch42index161"></A></P>
<ul></ul></td></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr style="background-image: url(images/tile_back.gif);">
<td class="v2" align="left" width="30%">
<a href="ch42lev1sec5.html"><img src="images/previous.gif" width="70" height="19" border="0" align="absmiddle" alt="Previous Section"></a>
</td>
<td class="v2" align="center" width="40%">
<a href="main.html" style="color:white;text-decoration:none;text-underline:none">&nbsp;&lt;&nbsp;Day Day Up&nbsp;&gt;&nbsp;</a>
</td>
<td class="v2" align="right" width="30%">
<a href="ch42lev1sec7.html"><img src="images/next.gif" width="70" height="19" border="0" align="absmiddle" alt="Next Section"></a>
</td>
</tr>
</table>
</body>
</html>
