<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="10.5 JPython: The Felicitous Union of Python and Java"-->
<LINK REL="stylesheet" href="FILES/sbolM.css">
</HEAD>
<BODY link="#354278" vlink="#000066" alink="#000080" topmargin="0">
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#CCCCCC">
<td><font color="black" size=1>I l<font color="#FF0000">@</font>ve RuBoard</td>
<td valign="top" class="v2" align="right"><a href="lpython_snode108.html"><img src="FILES/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a> <a href="lpython_snode110.html"><img src="FILES/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a></td></table>
<FONT>
<h3>10.5
JPython: The Felicitous Union of Python and Java</h3>


<p>
<a NAME="idx862"></a>JPython is a
recently released version of Python written entirely in Java by Jim
<a naME="idx863"></A>
<A name="idx864"></A>Hugunin.
JPython is a very exciting development for both the Python community
and the Java community. Python users are happy that their current
Python knowledge can transfer to Java-based development environments;
Java programmers are happy that they can use the Python scripting
language as a way to control their Java systems, test libraries, and
learn about Java libraries from an interpreted environment.</P>



<P>JPython is available from
<A target="_blank" href="http://www.python.org/jpython">http://www.python.org/jpython</a>, with license and
distribution terms similar to those of CPython (which is what the
reference implementation of Python is called when contrasted with
JPython).</p>



<p>The<a name="idx865"></a>
JPython installation includes several parts:</p>



<Ul>
<Li><p><tT cLAsS="monofont"> jpython</Tt>: The equivalent of the Python program
used throughout the book.</P>
</lI>
<LI><P><tt clASS="monofont"> jpythonc</Tt>: Takes a JPython program and compiles it
to Java class files. The resulting Java class files can be used as
any Java class file can, for example as applets, as servlets, or as
beans.</p>
</li>
<LI><P>A set of modules that provide the JPython user with the vast majority
of the modules in the standard Python library.</P>
</li>
<li><P>	A few programs demonstrating various aspects of JPython programming.</P>
</LI>
</ul>
<p>Using JPython is very similar to using Python:</p>



<pre class="monofont">~/book&gt; <b>jpython</b></pre>

<pre ClAss="monofont">JPython 1.0.3 on java1.2beta4
Copyright 1997-1998 Corporation for National Research Initiatives
&gt;&gt;&gt; <b>2 + 3</B></pRE>

<pRE cLaSS="monofont">5</PRe>


<p>In fact, JPython works almost identically to CPython. For an
up-to-date listing of the differences between the two, see
<a tARGEt="_blank" hreF="http://www.python.org/jpython/differences.html">http://www.python.org/jpython/differences.html</A>.
The most important differences are:</P>



<Ul>
<li><p>JPython is currently slower than CPython. How much slower depends on
the test code used and on the Java Virtual Machine JPython is using.
JPython's author has, on the other hand, explored very
promising optimizations, which could make future versions of JPython
as fast or faster than CPython.</P>
</LI>
<Li><p>Some of the built-ins or library modules aren't available for
JPython. For example, the <tt class="monofont">os.system()</tt> call is not
implemented yet, as doing so is difficult given Java's
interaction with the underlying operating system. Also, some of the
largest extension modules such as the Tkinter GUI framework
aren't available, because the underlying tools (the Tk/Tcl
toolkit, in the case of Tkinter) aren't available in Java.</p>
</li>
</ul>

<h4>10.5.1
JPython Gives Python Programmers Access to Java Libraries</h4>


<p>The most important difference between JPython and CPython, however,
is that <a NaMe="idx866"></a>JPython offers the Python programmer
seamless access to Java libraries. Consider the following program,
<i>jpythondemo.py,</I> the output of which is shown in
<a href="lpython_snode109.html#2">Figure 10.5</A>.</p>



<CeNTER>
<h5>
<a naME="2"></A>Figure 10.5. The output of jpythondemo.py </H5>

<img bORDEr="0" widTH="503" HEight="66" src="FILES/lpy_1005.gif" alt="figs/lpy_1005.gif"></center>


<pre cLaSs="monofont">from pawt import swing
import java

def exit(e): java.lang.System.exit(0)

frame = swing.JFrame('Swing Example', visible=1)
button = swing.JButton('This is a Swinging button!', actionPerformed=exit)
frame.contentPane.add(button)
frame.pack()</prE>


<p>This simple program demonstrates how easy it is to write a Python
program that uses the Swing Java GUI<A NaME="idx867"></a> framework.<FoNT SIze="1"><suP><A HRef="#FOOTNOTE-7">[7]</a></sUP></FOnt>
 The first line imports the
<tt CLASs="monofont">swing</tt> Java package (the <tt class="monofont">pawt</tt>
module figures out the exact location of Swing, which can be in
<tt class="monofont">java.awt.swing</tT>, in
<tT claSs="monofont">com.sun.java.swing</TT>, or maybe in
<tT ClAsS="monofont">javax.swing</TT>). The second line imports the
<Tt claSS="monofont">java</TT> package that we need for the
<tt clASS="monofont">java.lang.System.exit()</Tt> call. The fourth line
creates a <tt cLASS="monofont">JFrame</tt>, setting its bean property
<tt class="monofont">visible</tt> to true. The fifth line creates a
<tt class="monofont">JButton</tt> with a label and specifies what function
should be called when the button is clicked. Finally, the last two
lines put the <Tt ClasS="monofont">JButton</tT> in the
<Tt CLaSs="monofont">JFrame</TT> and make them both visible.</P>


<BlockQUOTe><fonT SIZe="1">
<p clASS="footnote">
<Sup><a name="FOOTNOTE-7">[7]</a></sup>
Documentation for Swing and the Java Foundation Classes is
available online at <a target="_blank" hrEf="http://../java.sun.com/products/jfc/index.html">http://java.sun.com/products/jfc/index.html</A>.
Alternatively, Robert Eckstein, Marc Loy, and Dave Wood have
published a thorough review of the Swing toolkit for Java,
<i>Java Swing</i>, published by O'Reilly &amp;
Associates.</p>
</FoNT></bLOcKqUOTE>





<p>Experienced Java programmers might be a bit surprised at some of the
code in <i>jpythondemo.py</i>, as it has some
differences from the equivalent Java program. In order to make using
Java libraries as easy as possible for Python users, JPython performs
a lot of work behind the scenes. For example, when JPython imports a
Java package, it actively tracks down the appropriate package, and
then, using the Java Reflection API, finds the contents of packages,
and the signatures of classes and methods. JPython also performs
on-the-fly conversion between Python types and Java types. In
<i>jpythondemo.py</I>, for example, the text of the
button (<TT Class="monofont">'This is a Swinging example!'</TT>) is a Python
string. Before the constructor for <TT clasS="monofont">JButton</TT> is
called, JPython finds which variant of the constructor can be used
(e.g., by rejecting the version that accepts an
<Tt class="monofont">Icon</tt> as a first argument), and automatically
converts the Python string object to a Java string object. More
sophisticated mechanisms allow the convenient
<tt class="monofont">actionPerformed=exit</tt> keyword argument to the
<tt cLaSs="monofont">JButton</tt> constructor. This idiom isn't
possible in Java, since Java can't manipulate functions (or
methods) as first-class objects. JPython makes it unnecessary to
create an <Tt CLaSS="monofont">ActionListener</tT> class with a single
<tT CLAss="monofont">actionPerformed</tt> method, although you can use the
more verbose form if you wish.</P>







<H4>10.5.2
JPython as a Java Scripting Language</H4>


<P>
<a namE="idx868"></A>JPython is gaining in popularity
because it allows programmers to explore the myriad Java libraries
that are becoming available in an interactive, rapid turnaround
environment. It also is proving useful to embed Python as a scripting
language in Java frameworks, for customization, testing, and other
programming tasks by end users (as opposed to systems developers).
For an example of a Python interpreter embedded in a Java program,
see the program in the <I>demo/embed</I> directory of
the JPython distribution.</p>







<a naME="idx968"></A><A name="idx969"></a><h4>10.5.3
A Real JPython/Swing Application: <i>grapher.py</i>
</h4>


<p>The <i>grapher.py</i> program (output shown in <a href="lpython_snode109.html#7">Figure 10.6</a>) allows users to graphically explore the
behavior of mathematical functions. It's also based on the
Swing GUI toolkit. There are two text-entry widgets in which Python
code should be entered. The first is an arbitrary Python program
that's invoked before the function is drawn; it imports the
needed modules and defines any functions that might be needed in
computing the value of the function. The second text area (labeled
<tt ClAss="monofont">Expression</tT>:) should be a Python expression (as in
<tT ClASs="monofont">sin(x)</Tt>), not a statement. It's called for
each data point, with the value of the variable <TT CLass="monofont">x</tT>
set to the horizontal coordinate.</P>



<CEnter>
<H5>
<A NAme="7"></a>Figure 10.6. Output of grapher.py</h5>

<IMG Border="0" width="503" height="388" src="FILES/lpy_1006.gif" aLt="figs/lpy_1006.gif"></CentEr>


<P>The user can control whether to draw a line graph or a filled graph,
the number of points to plot, and what color to plot the graph in.
Finally, the user can save configurations to disk and reload them
later (using the <Tt CLaSs="monofont">pickle</TT> module) Here is the
<I>grapher.py</I> program:</p>



<pre CLASs="monofont">from pawt import swing, awt, colors, GridBag
RIGHT = swing.JLabel.RIGHT
APPROVE_OPTION = swing.JFileChooser.APPROVE_OPTION
import java.io
import pickle, os

<b>default_setup = """from math import *</b>
<b>def squarewave(x,order):</B>
<B>    total = 0.0</B>
<B>    for i in range(1, order*2+1, 2):</b>
<b>        total = total + sin(x*i/10.0)/(float(i))</b>
<b>    return total</B>
<B>"""</B>
default_expression = "squarewave(x, order=3)"

class Chart(awt.Canvas):
    color = colors.darkturquoise
    style = 'Filled'

    def getPreferredSize(self):
        return awt.Dimension(600,300)

    def paint(self, graphics):
        clip = self.bounds
        graphics.color = colors.white
        graphics.fillRect(0, 0, clip.width, clip.height)

        width = int(clip.width * .8)
        height = int(clip.height * .8)
        x_offset = int(clip.width * .1)
        y_offset = clip.height - int(clip.height * .1)

        N = len(self.data); xs = [0]*N; ys = [0]*N

        xmin, xmax = 0, N-1
        ymax = max(self.data)
        ymin = min(self.data)

        zero_y = y_offset - int(-ymin/(ymax-ymin)*height)
        zero_x = x_offset + int(-xmin/(xmax-xmin)*width)

        for i in range(N):
            xs[i] = int(float(i)*width/N) + x_offset
            ys[i] = y_offset - int((self.data[i]-ymin)/(ymax-ymin)*height)
        graphics.color = self.color
        if self.style == "Line":
            graphics.drawPolyline(xs, ys, len(xs))
        else:
            xs.insert(0, xs[0]); ys.insert(0, zero_y)
            xs.append(xs[-1]); ys.append(zero_y)
            graphics.fillPolygon(xs, ys, len(xs))

        # draw axes
        graphics.color = colors.black
        graphics.drawLine(x_offset,zero_y, x_offset+width, zero_y)
        graphics.drawLine(zero_x, y_offset, zero_x, y_offset-height)

        # draw labels
        leading = graphics.font.size
        graphics.drawString("%.3f" % xmin, x_offset, zero_y+leading)
        graphics.drawString("%.3f" % xmax, x_offset+width, zero_y+leading)
        graphics.drawString("%.3f" % ymin, zero_x-50, y_offset)
        graphics.drawString("%.3f" % ymax, zero_x-50, y_offset-height+leading)

class GUI:
    def __init__(self):
        self.numelements = 100
        self.frame = swing.JFrame(windowClosing=self.do_quit)

        # build menu bar
        menubar = swing.JMenuBar()
        file = swing.JMenu("File")
        file.add(swing.JMenuItem("Load", actionPerformed = self.do_load))
        file.add(swing.JMenuItem("Save", actionPerformed = self.do_save))
        file.add(swing.JMenuItem("Quit", actionPerformed = self.do_quit))
        menubar.add(file)
        self.frame.JMenuBar = menubar

        # create widgets
        self.chart = Chart(visible=1)
        <B>self.execentry = swing.JTextArea(default_setup, 8, 60)</b>
<b>        self.evalentry = swing.JTextField(default_expression,</b>
<b>                                          actionPerformed = self.update)</b>

        # create options panel
        optionsPanel = swing.JPanel(awt.FlowLayout(
            alignment=awt.FlowLayout.LEFT))

        # whether the plot is a line graph or a filled graph
        self.filled = swing.JRadioButton("Filled",
                                         actionPerformed=self.set_filled)
        optionsPanel.add(self.filled)
        self.line = swing.JRadioButton("Line",
                                       actionPerformed=self.set_line)
        optionsPanel.add(self.line)
        styleGroup = swing.ButtonGroup()
        styleGroup.add(self.filled)
        styleGroup.add(self.line)

        # color selection
        optionsPanel.add(swing.JLabel("Color:", RIGHT))
        colorlist = filter(lambda x: x[0] != '_', dir(colors))
        self.colorname = swing.JComboBox(colorlist)
        self.colorname.itemStateChanged = self.set_color
        optionsPanel.add(self.colorname)

        # number of points
        optionsPanel.add(swing.JLabel("Number of Points:", RIGHT))
        self.sizes = [50, 100, 200, 500]
        self.numpoints = swing.JComboBox(self.sizes)
        self.numpoints.selectedIndex = self.sizes.index(self.numelements)
        self.numpoints.itemStateChanged = self.set_numpoints
        optionsPanel.add(self.numpoints)

        # do the rest of the layout in a GridBag
        self.do_layout(optionsPanel)

    def do_layout(self, optionsPanel):
        bag = GridBag(self.frame.contentPane, fill='BOTH',
                      weightx=1.0, weighty=1.0)
        bag.add(swing.JLabel("Setup Code: ", RIGHT))
        bag.addRow(swing.JScrollPane(self.execentry), weighty=10.0)
        bag.add(swing.JLabel("Expression: ", RIGHT))
        bag.addRow(self.evalentry, weighty=2.0)
        bag.add(swing.JLabel("Output: ", RIGHT))
        bag.addRow(self.chart, weighty=20.0)
        bag.add(swing.JLabel("Options: ", RIGHT))
        bag.addRow(optionsPanel, weighty=2.0)
        self.update(None)  
        self.frame.visible = 1
        self.frame.size = self.frame.getPreferredSize()

        self.chooser = swing.JFileChooser()
        self.chooser.currentDirectory = java.io.File(os.getcwd())

    def do_save(self, event=None):
        self.chooser.rescanCurrentDirectory()
        returnVal = self.chooser.showSaveDialog(self.frame)
        if returnVal == APPROVE_OPTION:
            object = (self.execentry.text,  self.evalentry.text,
                      self.chart.style,
                      self.chart.color.RGB,
                      self.colorname.selectedIndex, 
                      self.numelements)
            file = open(os.path.join(self.chooser.currentDirectory.path,
                        self.chooser.selectedFile.name), 'w')
            pickle.dump(object, file)
            file.close()

    def do_load(self, event=None):
        self.chooser.rescanCurrentDirectory()    
        returnVal = self.chooser.showOpenDialog(self.frame)
        if returnVal == APPROVE_OPTION:
            file = open(os.path.join(self.chooser.currentDirectory.path,
                     self.chooser.selectedFile.name))
            (setup, each, style, color, 
             colorname, self.numelements) = pickle.load(file)
            file.close()
            self.chart.color = java.awt.Color(color)
            self.colorname.selectedIndex = colorname
            self.chart.style = style
            self.execentry.text = setup
            self.numpoints.selectedIndex = self.sizes.index(self.numelements)
            self.evalentry.text = each
            self.update(None)

    def do_quit(self, event=None): 
        import sys
        sys.exit(0)

    def set_color(self, event):
        self.chart.color = getattr(colors, event.item)
        self.chart.repaint()

    def set_numpoints(self, event):
        self.numelements = event.item
        self.update(None)

    def set_filled(self, event):
        self.chart.style = 'Filled'
        self.chart.repaint()

    def set_line(self, event):
        self.chart.style = 'Line'
        self.chart.repaint()

    def update(self, event):
        <b>context = {}</b>
<b>        exec self.execentry.text in context</b>
<b>        each = compile(self.evalentry.text, '&lt;input&gt;', 'eval')</b>
<b>        numbers = [0]*self.numelements</b>
<b>        for x in xrange(self.numelements):</b>
<b>            context['x'] = float(x)</b>
<b>            numbers[x] = eval(each, context)</b>
        self.chart.data = numbers
        if self.chart.style == 'Line':
            self.line.setSelected(1)
        else:
            self.filled.setSelected(1)
        self.chart.repaint()

GUI()</pRe>


<P>The<a naMe="idx869"></A> logic of this
program is fairly straightforward, and the class and method names
make it easy to follow the flow of control. Most of this program
could have been written in fairly analogous (but quite a bit longer)
Java code. The parts in bold, however, show the power of having
Python available: at the top of the module, default values for the
<Tt CLaSs="monofont">Setup</TT> and <TT clasS="monofont">Expression</TT> text
widgets are defined. The former imports the functions in the
<Tt claSS="monofont">math</TT> module and defines a function called
<tt clASS="monofont">squarewave</Tt>. The latter specifies a call to this
function, with a specific <tt class="monofont">order</tt> parameter (as that
parameter grows, the resulting graph looks more and more like a
square wave, hence the name of the function). If you have Java,
Swing, and JPython installed, feel free to play around with other
possibilities for both the <tt class="monofont">Setup</tt> and
<tT cLass="monofont">Expression</Tt> text widgets.</P>



<P>The key asset of using
<a NAmE="idx870"></a>JPython instead of Java in this example
is in the <TT CLass="monofont">update</tT> method: it simply calls the
standard Python <TT Class="monofont">exec</TT> statement with the
<TT clasS="monofont">Setup</TT> code as an argument, and then calls
<Tt class="monofont">eval</tt> with the compiled version of the
<tt class="monofont">Expression</tt> code for each coordinate. The user is
free to use any part of Python in these text widgets!</p>



<p>JPython is still very much a work in progress; Jim
<a NaMe="idx871"></a>Hugunin is
constantly refining the interface between Python and Java and
optimizing it. JPython, by being the second implementation of Python,
is also forcing Guido<a NaME="idx872"></a> van Rossum to decide what aspects of
Python are core to the language and what aspects are features of his
implementation. Luckily, Jim and Guido seem to be getting along and
agreeing on most points.<A NaMe="idx873"></A></P>


</FOnt>
 
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#CCCCCC">
<td><font color="black" size=1>I l<font color="#FF0000">@</font>ve RuBoard</td>
<td valign="top" class="v2" align="right"><a href="lpython_snode108.html"><img src="FILES/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a> <a href="lpython_snode110.html"><img src="FILES/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a></td></table>
</BODY></HTML>