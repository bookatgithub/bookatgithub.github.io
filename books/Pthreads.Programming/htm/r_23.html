
<HTML>
<HEAD>
<TITLE> Pthreads ProgrammingChapter 2 - Designing Threaded Programs</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">

</HEAD>
<BODY  LINK="#122EB2"  LEFTMARGIN=0 TOPMARGIN=5 >






<A NAME="toppage"></A><TABLE BORDER="0" CELLSPACING="1" CELLPADDING="1"><TR ALIGN="right"><TD  HEIGHT="44"><A HREF="../toc.html"  BORDER="0"><IMG SRC="../img/vb_toc.gif" WIDTH="114" HEIGHT="17" BORDER="0"></A><A HREF="bookmark.html+bkid=232&chnkid=23.html"  BORDER="0"><IMG SRC="../img/bookmark_create.gif" WIDTH="115" HEIGHT="17" BORDER="0"></A><A HREF="bookshelf.html+bkid=232&chnkid=23&addbk=1.html"  BORDER="0"><IMG SRC="../img/vblue_add_book.gif" WIDTH="106" HEIGHT="17" ALT="Add Book to My Bookshelf" TITLE="Add Book to My Bookshelf" BORDER="0"></A><A HREF="buybook.html+bkid=232.html" TARGET="_top" BORDER="0"><IMG SRC="../img/vb_purchase.gif" WIDTH="108" HEIGHT="17" ALT="Purchase This Book Online" TITLE="Purchase This Book Online" BORDER="0"></A></TD></TR><TR VALIGN="top"><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="1"><TR VALIGN="top" HEIGHT=5><TD ROWSPAN="3"  VALIGN=top ALIGN=left WIDTH="100" HEIGHT="110"><IMG SRC="../img/1565921151.gif" WIDTH="79" HEIGHT="103" ALIGN=Left BORDER="0"></TD><TD><FONT FACE="Arial, Helvetica, sans-serif" SIZE="3"><H3>Chapter 2 - Designing Threaded Programs</H3></FONT></TD></TR><TR><TD><FONT FACE="Arial, Helvetica" SIZE="2">Pthreads Programming</FONT></TD></TR><TR VALIGN=top><TD HEIGHT="30"><FONT FACE="Arial, Helvetica" SIZE="2">Bradford Nichols, Dick Buttlar and Jacqueline Proulx Farrell</FONT></TD></TR></TABLE></TD></TR><TR><TD><TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%"><TR><TD WIDTH="176" VALIGN="top"></TD><TD WIDTH="120" VALIGN="top"><FONT FACE="Arial, Helvetica" SIZE="1" COLOR="#122EB2">&nbsp;</FONT></TD><TD WIDTH="249" ALIGN="right" VALIGN="top"><FONT FACE="Arial, Helvetica" SIZE="2">Copyright © 1996 O'Reilly & Associates, Inc.</FONT></TD></TR></TABLE></TD></TR><TR VALIGN="middle"><TD HEIGHT="32" WIDTH="470"><TABLE WIDTH="545" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="545" COLSPAN=2><HR WIDTH="100%" ALIGN="left" SIZE="1" NOSHADE></TD><TD WIDTH="0" ALIGN="right"></TD></TR></TABLE></TD></TR></TABLE><A HREF="r_705026553.html" BORDER="0"></A><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=265483></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="000080"><B>Example: An ATM Server</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=265631></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><A HREF=#281330><FONT SIZE="2" FACE="Arial" COLOR="008000">Example 2-6</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000"> is a client/server program that implements an imaginary automated teller machine (ATM) application. This server will give us an opportunity to exercise our thinking about multithreaded program design and explore more realistic—and more complicated—thread handling applications.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=265885></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">As shown in Figure 2-6, the example is made up of a client that provides a user interface</FONT><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"> and a server that processes requests from the client. On disk, the server stores a database of bank accounts, each including an account ID, password, and balance.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=266088></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=1% VALIGN=TOP><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"></FONT></TD><TD WIDTH=1%></TD><TD WIDTH=94% VALIGN=TOP ALIGN=left><SUP></SUP><FONT SIZE="2" FACE="Arial" COLOR="000000">The client for an ATM application should be an actual machine, but, for the purposes of this book, we'll just make it a command-line program that accepts typed-in requests. (Unfortunately, this type of client isn't realistic enough to spit out ten dollar bills.)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=266334></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=11%></TD><TD WIDTH=87% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>
     <A HREF=../img/02FIG06_0.gif><IMG SRC=../img/02FIG06_65.gif WIDTH=325 HEIGHT=235 BORDER=NO></A></B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=266468></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=11%></TD><TD WIDTH=87% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100"><B>Figure 2-6</B></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">: The ATM and bank database server example</FONT></TD><TD WIDTH=2%></TD></TR><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=266580></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In a typical ATM operation, a customer chooses a withdrawal from a menu presented by the client and enters the amount to be withdrawn. The client packages this information into a request that it sends to the server. The server spawns a thread that checks the user's password against the one in the database, decrements the amount of money in the user's account, and sends back an indication of whether the operation succeeded. The client and server process communicate using UNIX sockets. The client reports any information returned from the server back to the user. Multiple clients can run simultaneously.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=266975></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We want the server to be capable of overlapping I/O, because the account data is stored in secondary storage and its access will require a significant amount of time. The environment is asynchronous because multiple clients may exist simultaneously, sending requests of unpredictable type, order, and frequency.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=267191></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In the following sections of this chapter, we'll discuss two different implementations of this program: a serial version and a multithreaded version that uses Pthreads</FONT><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"> The multithreaded version of the program uses the boss/worker model inside the server. The boss looks at the first field of each request, then spawns a thread or process to handle that request. When the worker completes the request, it communicates the results directly back to the client program.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=267447></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=1% VALIGN=TOP><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"></FONT><A HREF=viewer_r.html+bkid=232&destid=1166241.html#1166241><FONT SIZE="2" FACE="Arial" COLOR="008000"></FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000"></FONT></TD><TD WIDTH=1%></TD><TD WIDTH=94% VALIGN=TOP ALIGN=left><SUP></SUP><FONT SIZE="2" FACE="Arial" COLOR="000000">You can obtain the complete source code for all versions of the ATM example, including that for the multiprocess version used in our performance testing in </FONT><A HREF=viewer_r.html+bkid=232&destid=1166241.html#1166241><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 6</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">, from our ftp site. Throughout this chapter, we'll show only those interfaces and routines pertinent to the current discussion.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=267688></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">For simplicity's sake, we've partitioned the client and server into modules. The interfaces between these modules will remain unchanged throughout all versions of our example. We'll change only the dispatch and service routine module from one version to another. Table 2-1 shows the contents of the client and server modules.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=278654></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Table 2-1: The ATM Example Program Modules</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=278758></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100"><B><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD BGCOLOR=000080><IMG WIDTH=1 HEIGHT=2 SRC=_.gif></TD></TR></TABLE></B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=278891></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Module</B></FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Component</B></FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Description</B></FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=279070></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100"><B><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD BGCOLOR=000080><IMG WIDTH=1 HEIGHT=2 SRC=_.gif></TD></TR></TABLE></B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=279201></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Client program</FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">User interface (</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">)</FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Prompts a customer for a request, parses the response, and makes a remote procedure call (RPC) to access the server.</FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=279438></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">RPC</FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Includes a procedure for each possible type of request. Each procedure copies its arguments into a buffer and passes the buffer to the communication module for transmission to the server. When a response arrives from the server, the procedure checks its return values.</FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=279712></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Communication </FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Finds and passes buffers to and from the server using UNIX sockets.</FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=279905></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Server program</FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Communication</FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Receives and transmits buffers to clients using UNIX sockets.</FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=280108></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Dispatch (and service) routines (</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main)</I></FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Obtains input buffers from clients by means of the communication module, identifies the request type and copies out arguments, and calls the service routine that handles the requested operation. Together, the dispatch and service routines make up the server-side procedures of the client's RPC. When request processing is complete, the dispatch routine prepares and transmits a response buffer to the client.</FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=280494></A><TD WIDTH=27% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=10%></TD><TD WIDTH=85% VALIGN=TOP ALIGN=left></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=26% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=94% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Database routines</FONT></TD><TD WIDTH=5%></TD></TR></TABLE></TD><TD WIDTH=3%></TD><TD WIDTH=36% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Reads from and writes to the account database file using standard file I/O.</FONT></TD><TD WIDTH=3%></TD></TR></TABLE></TD><TD WIDTH=3%></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=280685></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100"><B><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD BGCOLOR=000080><IMG WIDTH=1 HEIGHT=2 SRC=_.gif></TD></TR></TABLE></B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=280816></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="800000"><B>The Serial ATM Server</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=280951></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">If we didn't have threads, what would be the simplest implementation of the ATM server? One that comes to mind is a program that runs in a loop, processing available requests serially. If a request is available, the program processes it in a request-specific service routine and sends a response to the client. The </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine for this version of the server is shown in Example 2-6.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281207></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 2-6: Serial ATM Server: main Routine (atm_svr_serial.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281330></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp; extern int</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281417></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; main(argc, argv)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281501></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int argc;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281569></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; char **argv;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281633></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281695></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; char req_buf[COMM_BUF_SIZE], resp_buf[COMM_BUF_SIZE];</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281789></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; int&nbsp; conn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281860></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; int&nbsp; trans_id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281925></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; int&nbsp; done=0;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=281998></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282058></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; atm_server_init(argc, argv);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282123></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282183></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /* loop forever */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282258></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; for(;;) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282329></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282389></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_comm_get_request(&amp;conn, req_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282473></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sscanf(req_buf, "%d", &amp;trans_id);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282545></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282605></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(trans_id) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282688></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282748></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case CREATE_ACCT_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282838></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; create_account(resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=282931></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283005></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283065></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case DEPOSIT_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283139></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; deposit(req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283225></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283299></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283359></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WITHDRAW_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283446></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; withdraw(req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283532></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283606></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283666></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case BALANCE_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283752></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; balance(req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283838></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283912></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=283972></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case SHUTDOWN:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284053></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (shutdown_req(req_buf, resp_buf)) done = 1;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284171></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284245></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284305></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284375></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; handle_bad_trans_id(req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284474></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284548></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284608></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284676></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284736></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_comm_send_response(conn, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284811></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284871></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(done) break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=284947></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285007></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285071></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285131></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; server_comm_shutdown();</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285198></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285260></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">return 0;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285321></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285381></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The serial version of our ATM server can process only a single request at a time, no matter how many clients are requesting service.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285509></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>Handling asynchronous events: blocking with select</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=285654></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The server handles the asynchronous arrival of requests from clients by waiting. When the server's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine calls </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>server_comm_get_request</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, the server's communication layer uses a UNIX </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>select </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">call to determine which channels have data on them waiting to be read. If none do, the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>select</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> call (and consequently the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>server_comm_get_request </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">call) blocks until data arrives.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=294924></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>Handling file I/O: blocking with read/write</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=295075></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The server in </FONT><A HREF=#281330><FONT SIZE="2" FACE="Arial" COLOR="008000">Example 2-6</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000"> does nothing but block when performing file operations. When it issues a </FONT><FONT SIZE="2" FACE="Arial" COLOR="000000"><I>read </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="000000">or </FONT><FONT SIZE="2" FACE="Arial" COLOR="000000"><I>write</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="000000"> call to the file, the server waits until the operating system completes the operation and the call returns.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=295271></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The server could have used UNIX signals to access the file without blocking. If so, it would need to establish a signal handler that processes the results of its I/O requests and to register this handler with the operating system such that it takes control when the completion of an I/O request is signaled. This would allow the server to make asynchronous I/O calls that return immediately. When the request completes at a later time, the server is interrupted and put into its signal handler to process the results.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=295520></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The big drawback for using asynchronous I/O in a serial server is in the complicated state management and synchronization problems that arise between the server and its signal handler. The program must keep track of the state of all in-progress requests. It must create and maintain locks for various resources (such as account records) so that they are not simultaneously accessed in program and signal contexts. Finally, the clean division of the program into modules breaks down. The communication, server, and database modules all get mixed together.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=295834></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">All in all, the experiment of using asynchronous I/O in a serial ATM server is a good argument for designing such a server to use threads. It's much cleaner to let a single thread wait for I/O to complete than it is to manage the complexity of signals and synchronization.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=296037></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The serial version of our ATM server works—in fact, it works quite well—when the input stream of requests is light. However, the performance of the serial server degrades rapidly as more and more clients request access to its data. Clients begin to see longer and longer delays in the processing of their requests because all are blocked by server access to the database. In </FONT><A HREF=viewer_r.html+bkid=232&destid=1166241.html#1166241><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 6</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">, we'll run some tests on single-threaded and multithreaded versions of the server that show the point at which it becomes inefficient to use the serial version.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=296373></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">What can we do to improve the performance of our server underload? It can help a lot to allow it to move on to another client request while its I/O to the database is proceeding. The next versions of our server will do just that.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=296560></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="800000"><B>The Multithreaded ATM Server</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=296690></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Let's add threads to our example. We'll begin by identifying those tasks we want individual threads to process. Having each request processed by a separate thread may or may not be a good starting point.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=296869></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Before we pursue our design, let's step back and look again at the general criteria for selecting tasks for threads. In general we'd like to select tasks for our ATM server's threads based on whether:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297042></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">They are independent of each other.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297148></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">If we assume that simultaneous accesses to the same account are rare, it makes sense to have each request processed by a separate thread. Threads will not compete for account data. No individual thread will rely on the work accomplished by another thread to complete its work.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297365></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">They can become blocked in potentially long waits.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297485></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">This is true of all requests to our server, because any access to the account database could involve disk access to a file.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297619></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">They can use a lot of CPU cycles.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297728></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Our server contains no tasks that can be defined as compute intensive.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297848></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">They must respond to asynchronous events.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=297962></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">This is true of the manner in which the communication layer of our server accepts client requests.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298100></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">They require scheduling.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298197></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In our first pass at a multithreaded version of our ATM server we won't use scheduling. But we can imagine that certain operations could be given higher priority than others. A thread handling a shutdown request might be given priority over other requests. If we used the database to generate monthly account statements, we could give those requests lower priority than direct customer requests to bank accounts.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298461></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We must also bear in mind some key constraints our ATM server places on our program design:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298594></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We must maintain correctness.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298698></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">For the multithreaded version of our ATM server to produce correct and consistent results, we must ensure that two threads don't corrupt an account by writing information to it simultaneously. Thus, we'll use locks to protect the account data.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298882></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We must maintain the liveliness of the threads.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=298996></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We must avoid those types of programming bugs in which a worker thread obtains a lock on account data and then exits without releasing the lock. Other worker threads that subsequently attempt to obtain the lock on the same data will deadlock, waiting forever.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=299195></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We must minimize overhead.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=299302></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Our threads can't spend all their time synchronizing with each other or they are not worth their overhead. As a simplification, we'll start out in our example by allocating a thread for each request. We can later enhance it by allowing threads to remain active, waiting for new requests (that is, we could use a thread pool).</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=299559></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>Model: boss/worker model</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=299694></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Because it's a classic server program, we'll use the boss/worker model for our ATM server. A boss thread accepts input from remote clients through the communication module. Worker threads handle each client account request.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=299864></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Figure 2-7 shows the structure of our ATM example program using the boss/worker ATM server. The boss thread is neatly encapsulated by the server's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine. Each worker thread runs one service routine: deposit, withdraw, and so on.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300041></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=11%></TD><TD WIDTH=87% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>
     <A HREF=../img/02FIG07_0.gif><IMG SRC=../img/02FIG07_65.gif WIDTH=325 HEIGHT=168 BORDER=NO></A></B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300170></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=11%></TD><TD WIDTH=87% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100"><B>Figure 2-7:</B></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> The boss/worker Pthreads ATM Server</FONT></TD><TD WIDTH=2%></TD></TR><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300271></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>The boss thread</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300403></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We'll start building our multithreaded ATM server's boss thread from our serial server's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine. The boss thread simply manages the receipt of incoming requests using the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>server_comm_get_request </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine. After it obtained each request from the communication module, the serial server's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine unpacked it and called the appropriate service routine. The boss thread's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine will create a worker thread to which it will pass the request. The worker thread begins by executing a generic request-processing routine called </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>process_request</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, as shown in Example 2-7.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300747></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 2-7: Multithreaded ATM Server: boss Thread (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300846></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp; typedef struct workorder{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=300947></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int conn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311339></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char req_buf[COMM_BUF_SIZE];</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311436></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } workorder_t;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311517></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; extern int</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311580></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; main(argc, argv)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311643></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int argc;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311711></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; char **argv;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311775></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311837></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; workorder_t *workorderp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311902></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; pthread_t&nbsp;&nbsp; *worker_threadp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=311967></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; int&nbsp; conn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312038></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; int&nbsp; trans_id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312103></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312163></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; atm_server_init(argc, argv);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312228></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312288></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; for(;;) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312359></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312419></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /*** Wait for a request ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312488></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; workorderp = (workorder_t *)malloc(sizeof(workorder_t));</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312557></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_comm_get_request(&amp;workorderp-&gt;conn, workorderp-&gt;req_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312624></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312684></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sscanf(workorderp-&gt;req_buf, "%d", &amp;trans_id);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312751></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (trans_id == SHUTDOWN) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312843></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312918></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=312993></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313068></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313144></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313219></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313279></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /*** Spawn a thread to process this request ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313367></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worker_threadp=(pthread_t *)malloc(sizeof(pthread_t));</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313468></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_create(worker_threadp, NULL, process_request, (void *)workorderp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313574></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313634></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_detach(*worker_threadp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313719></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free(worker_threadp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313805></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313869></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313929></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; server_comm_shutdown();</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=313996></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; return 0;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=314061></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=314123></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=314183></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>Dynamically detaching a thread</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=314325></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In the code for our boss thread's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine, we've introduced a new Pthreads call—</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>pthread_detach</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">. The </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>pthread_detach</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> function notifies the Pthreads library that we don't want to join our worker threads: that is, we will never request their exit status. If we don't explicitly tell the Pthreads library that we don't care about a thread's exit status, it'll keep the shadow of the thread alive indefinitely after the thread terminates (in the same way that UNIX keeps the status of zombie processes around). Detaching our worker threads frees the Pthreads library from storing this information, thus saving space and time. We are still responsible for freeing any space we dynamically allocated to hold the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>pthread_t</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> itself.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=314780></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Aside from using </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>pthread_detach</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> on an existing thread, you can create threads already in the detached state. We'll discuss this method in </FONT><A HREF=viewer_r.html+bkid=232&destid=676161.html#676161><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 4, </FONT><FONT SIZE="2" FACE="Arial" COLOR="008000"><I>Managing Pthreads</I></FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=314924></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>A worker thread</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315054></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In our multithreaded ATM server, each worker thread begins its life in a new request-parsing routine called </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>process_request</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">. This is a generic request-parsing routine that all workers use regardless of which requests they actually process. Because different service routines process different requests, the primary job of </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>process_request </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">is to select the proper service routine. We accomplish this by means of a simple case statement, shown in Example 2-8.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315353></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 2-8: Multithreaded ATM Server: Worker Thread process_request</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315452></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp; void process_request(workorder_t *workorderp)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315539></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315622></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; char resp_buf[COMM_BUF_SIZE];</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315687></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; int&nbsp; trans_id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315752></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; sscanf(workorderp-&gt;req_buf, "%d", &amp;trans_id);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315817></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315877></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; switch(trans_id) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=315958></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316018></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case CREATE_ACCT_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316108></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; create_account(resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316201></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316275></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316335></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case DEPOSIT_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316409></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; deposit(workorderp-&gt;req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316507></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316581></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316641></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WITHDRAW_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316728></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; withdraw(workorderp-&gt;req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316826></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316900></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=316960></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case BALANCE_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317046></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; balance(workorderp-&gt;req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317144></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317218></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317278></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317348></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; handle_bad_trans_id(workorderp-&gt;req_buf, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317459></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317533></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317601></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317661></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317721></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; server_comm_send_response(workorderp-&gt;conn,</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317803></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317891></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=317951></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; free(workorderp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=318016></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=318076></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=318138></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=318198></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In our ATM example, the boss thread is always active. It creates worker threads, as needed, to process requests. Each active worker could be processing a request on a different account, or each worker could be performing a separate operation on the same account. It shouldn't matter to our program. The boss thread limits the number of active worker threads in the server.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=318403></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">At any given time in the ATM example, a request could be in one of three places:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=318503></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Queued at the server's communication module, waiting to be picked up by the boss thread</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=327731></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In the boss thread's hands, about to be passed off to a worker thread</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=327831></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In the hands of a worker thread, being processed</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=327920></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>Synchronization: what's needed</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=328070></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">So far, we haven't shown any synchronization between the threads in our multithreaded ATM server. We'll go into the details in </FONT><A HREF=viewer_r.html+bkid=232&destid=366376.html#366376><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 3, </FONT><FONT SIZE="2" FACE="Arial" COLOR="008000"><I>Synchronizing Pthreads</I></FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">, and </FONT><A HREF=viewer_r.html+bkid=232&destid=676161.html#676161><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 4</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=328263></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Right now we'll just list what synchronization we'll need:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=328349></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Accounts</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=328447></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Now that we have multiple workers accessing the database through the service routines (</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>deposit</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>withdraw</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, and </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>balance</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">), we'll need to deal with the possibility that two routines may try to manipulate the same account balance at the same time. To prevent simultaneous access, we'll protect database accesses with a mutex variable.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=328689></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Limiting the number of workers</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=328792></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">To keep from overloading the CPUs, the boss must limit the number of worker threads that can exist concurrently. It must maintain an ongoing count of worker threads and decrement the count as threads exit. We'll do that and add a check for exiting worker threads.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=329002></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Server shutdown</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=329096></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The ATM client lets privileged users shut down the server. To make our server more robust, we must ensure that the server has completed the requests that are already in progress before it stops accepting new requests and shuts itself down. We'll do this by adding code so that the boss can tell when threads are active.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=329356></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="3" FACE="Arial" COLOR="010100"><B>Future enhancements</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=329499></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We'll add the synchronization we discussed to our multithreaded ATM server in </FONT><A HREF=viewer_r.html+bkid=232&destid=366376.html#366376><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 3</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">. We'll also enhance our server throughout the remainder of this book. Among the design refinements we'll consider are: </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=329707></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Thread pools</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=329802></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Our ATM server creates a worker thread each time it receives a request and pays the cost of thread creation each time. What if we allowed our server to reuse worker threads? When the server starts, it can create a predetermined number of workers in an idle state. Each worker thread could take requests off a queue and return to an idle state (instead of exiting) after completing each request. The reduction in overhead would pay off in performance.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=330133></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Cancellation</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=330225></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In a couple of situations it would be useful if the boss thread could interrupt and terminate a worker thread: to cancel an in-progress request that is no longer wanted or to support a quick shutdown.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=330433></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Scheduling</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=330525></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=5%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We could give some threads—possibly shutdown threads and deposit threads—priority over other threads. When a CPU becomes available, we could give these threads first crack at it.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><A NAME="{B4AC29EB-8775-11D4-A9C0-0008C791A32F}"></A><TABLE WIDTH="545" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="509" COLSPAN="3"><HR WIDTH="100%" ALIGN="left" SIZE="1" NOSHADE></TD><TD WIDTH="36" ALIGN="right"><A HREF="#toppage" BORDER="0"><IMG SRC="../img/to_top.gif" WIDTH="25" HEIGHT="11" BORDER="0"></A></TD></TR><TR><TD WIDTH="36"></TD><TD WIDTH="236" HEIGHT="25" VALIGN="top" ALIGN="left"><A HREF="r_22.html" BORDER="0"><IMG SRC="../img/vb_prev.gif" WIDTH="65" HEIGHT="17" ALT="Previous Section" TITLE="Previous Section" BORDER="0"></A></TD><TD WIDTH="236" HEIGHT="25" VALIGN="top" ALIGN="right"><A HREF="r_24.html" BORDER="0"><IMG SRC="../img/vb_next.gif" WIDTH="65" HEIGHT="17" ALT="Next Section" TITLE="Next Section" BORDER="0"></A></TD><TD WIDTH="36"></TD></TR></TABLE><TABLE BORDER="0" WIDTH="550" CELLSPACING="0" CELLPADDING="0"><TR><TD COLSPAN="2" ALIGN="Left" VALIGN="Bottom" HEIGHT="20"><IMG SRC="../img/blackdot.gif" WIDTH="550" HEIGHT="1"></TD></TR><TR><TD HEIGHT="11" WIDTH="100%"><FONT FACE="Arial, Helvetica, sans-serif" SIZE="1">Books24x7.com, Inc © 2000&nbsp;–&nbsp;&nbsp;<A HREF="feedback.html+fb=1&bkid=232&chnkid=23.html"  BORDER="0"><FONT COLOR="#333333">Feedback</FONT></A></FONT></TD></TR></TABLE>

</BODY>
</HTML>
