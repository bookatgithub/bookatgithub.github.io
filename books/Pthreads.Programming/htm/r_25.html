
<HTML>
<HEAD>
<TITLE> Pthreads ProgrammingChapter 3 - Synchronizing Pthreads</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">

</HEAD>
<BODY  LINK="#122EB2"  LEFTMARGIN=0 TOPMARGIN=5 >






<A NAME="toppage"></A><TABLE BORDER="0" CELLSPACING="1" CELLPADDING="1"><TR ALIGN="right"><TD  HEIGHT="44"><A HREF="../toc.html"  BORDER="0"><IMG SRC="../img/vb_toc.gif" WIDTH="114" HEIGHT="17" BORDER="0"></A><A HREF="bookmark.html+bkid=232&chnkid=25.html"  BORDER="0"><IMG SRC="../img/bookmark_create.gif" WIDTH="115" HEIGHT="17" BORDER="0"></A><A HREF="bookshelf.html+bkid=232&chnkid=25&addbk=1.html"  BORDER="0"><IMG SRC="../img/vblue_add_book.gif" WIDTH="106" HEIGHT="17" ALT="Add Book to My Bookshelf" TITLE="Add Book to My Bookshelf" BORDER="0"></A><A HREF="buybook.html+bkid=232.html" TARGET="_top" BORDER="0"><IMG SRC="../img/vb_purchase.gif" WIDTH="108" HEIGHT="17" ALT="Purchase This Book Online" TITLE="Purchase This Book Online" BORDER="0"></A></TD></TR><TR VALIGN="top"><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="1"><TR VALIGN="top" HEIGHT=5><TD ROWSPAN="3"  VALIGN=top ALIGN=left WIDTH="100" HEIGHT="110"><IMG SRC="../img/1565921151.gif" WIDTH="79" HEIGHT="103" ALIGN=Left BORDER="0"></TD><TD><FONT FACE="Arial, Helvetica, sans-serif" SIZE="3"><H3>Chapter 3 - Synchronizing Pthreads</H3></FONT></TD></TR><TR><TD><FONT FACE="Arial, Helvetica" SIZE="2">Pthreads Programming</FONT></TD></TR><TR VALIGN=top><TD HEIGHT="30"><FONT FACE="Arial, Helvetica" SIZE="2">Bradford Nichols, Dick Buttlar and Jacqueline Proulx Farrell</FONT></TD></TR></TABLE></TD></TR><TR><TD><TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%"><TR><TD WIDTH="176" VALIGN="top"></TD><TD WIDTH="120" VALIGN="top"><FONT FACE="Arial, Helvetica" SIZE="1" COLOR="#122EB2">&nbsp;</FONT></TD><TD WIDTH="249" ALIGN="right" VALIGN="top"><FONT FACE="Arial, Helvetica" SIZE="2">Copyright © 1996 O'Reilly & Associates, Inc.</FONT></TD></TR></TABLE></TD></TR><TR VALIGN="middle"><TD HEIGHT="32" WIDTH="470"><TABLE WIDTH="545" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="545" COLSPAN=2><HR WIDTH="100%" ALIGN="left" SIZE="1" NOSHADE></TD><TD WIDTH="0" ALIGN="right"></TD></TR></TABLE></TD></TR></TABLE><A HREF="r_113387664.html" BORDER="0"></A><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=366376></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=24 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="5" FACE="Arial" COLOR="000000"><B>Chapter 3:</B></FONT><FONT SIZE="5" FACE="Arial" COLOR="800000"><B> Synchronizing Pthreads</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=366448></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="000080"><B>Overview</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=366580></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Creating threads is the easy part. It's harder to get them to share data properly. We're tempted to make the obvious analogy to children. To prevent damage to the Nintendo (and the children), we'll only let the one who folds the laundry that evening play Donkey Kong. Similarly, to make threads share data safely, we must ensure that threads that would otherwise behave independently access shared data in an orderly and controlled way. This concept is called </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>synchronization</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">.(The other concept is called good parenting.)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=376844></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Sooner or later, you'll probably make a programming error and fail to synchronize threads. It would be nice if you could get a feel for the symptoms of synchronization failures so that you can react quickly and expertly to such a disaster. Unfortunately, as we'll see, almost any type of quirky behavior might be regarded as a symptom of a synchronization failure. Worse, you may see problems only every so often when you run your program; at other times, if the threads in the program just happen to access data in the right order in a particular run, the program may run fine. So you may notice incorrect output at random times—perhaps in one run out of a hundred. In fact, this come-and-go quality of errors may be the best indicator that your bug is in the way in which you've handled thread synchronization.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=377370></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Let's suppose we forgot to include synchronization in the ATM server we created in </FONT><A HREF=viewer_r.html+bkid=232&destid=197663.html#197663><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 2, </FONT><FONT SIZE="2" FACE="Arial" COLOR="008000"><I>Designing Threaded Programs</I></FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">. When one of our imaginary bank's customers deposits money in an account, she expects that, ultimately, her account balance will be its original value plus the amount she deposited. She probably can't even conceive of anything our bank could do to interfere with her transaction and cause her end balance to be any different than she expects. In other words, she assumes that her deposit is a single, indivisible transaction (if she were a software engineer, she'd know that the word for that type of transaction is </FONT><FONT SIZE="2" FACE="Arial" COLOR="000000"><I>atomic</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="000000">)that occurs in isolation from other transactions. It's anything but. Her deposit may consist of many, many separate tasks: disk reads, memory reads, calculations, data modifications, memory writes, disk writes, and more. Worse, without synchronization in our ATM server, we'll allow a similar transaction to preempt her deposit at any step—before all of the steps required to make it a deposit have completed.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=378065></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">But it's likely she'll have no problems until, for instance, she tries to withdraw $50 from her account at the same time her husband across town also tries to withdraw $50. This type of problem is known as a </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>race condition</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">. A race condition is illustrated in Figure 3-1.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=378300></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=11%></TD><TD WIDTH=87% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>
     <A HREF=../img/03FIG01_0.gif><IMG SRC=../img/03FIG01_65.gif WIDTH=325 HEIGHT=105 BORDER=NO></A></B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=378429></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=11%></TD><TD WIDTH=87% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100"><B>Figure 3-1: </B></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">ATM race condition with two withdraw threads</FONT></TD><TD WIDTH=2%></TD></TR><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=378538></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In a race condition, two or more threads access the same resource at the same time. In Figure 3-1, Thread 1 and Thread 2 simultaneously attempt a withdrawal from the same bank account. Thread1 reads the current balance of the account—$125. However, before it can proceed with the other steps that complete the withdrawal (the arithmetic, the storing of the new result, and the dispensing of cash), it is preempted by Thread 2. Thread 2 also reads the account balance—$125, but Thread 2 continues on to complete the transaction. It subtracts $50 from$125, stores the new balance, $75, in the account database, and hands the customer a $50 bill. Sometime thereafter, Thread 1 resumes, subtracts $50from $125 (which is what it thinks is the account balance), stores the new balance, $75, in the account database, and hands the other customer a$50 bill. Nothing looks wrong to either thread, but in actuality, we've allowed one thread to clobber the write of another. We've subtracted a total of $100 from $125 and have come up with $75. A bank could lose a lot of money if this was allowed to happen.</FONT><SUP>*</SUP></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=379253></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=1% VALIGN=TOP><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"></FONT></TD><TD WIDTH=1%></TD><TD WIDTH=94% VALIGN=TOP ALIGN=left><SUP></SUP><FONT SIZE="2" FACE="Arial" COLOR="000000">Actually, the error just happened to be in the customer's favor because the operations were both withdrawals. If the operations were deposits, the error would be in the bank's favor.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=379441></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The problem with our ATM server is that the three key steps in the withdraw transaction—the reading of the balance, the calculation of the new balance, and the storing of the new balance in the account database—should be atomic. Either all of the steps are performed together without interruption, or none of them are.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><A NAME="{B4AC29EB-8775-11D4-A9C0-0008C791A32F}"></A><TABLE WIDTH="545" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="509" COLSPAN="3"><HR WIDTH="100%" ALIGN="left" SIZE="1" NOSHADE></TD><TD WIDTH="36" ALIGN="right"><A HREF="#toppage" BORDER="0"><IMG SRC="../img/to_top.gif" WIDTH="25" HEIGHT="11" BORDER="0"></A></TD></TR><TR><TD WIDTH="36"></TD><TD WIDTH="236" HEIGHT="25" VALIGN="top" ALIGN="left"><A HREF="r_24.html" BORDER="0"><IMG SRC="../img/vb_prev.gif" WIDTH="65" HEIGHT="17" ALT="Previous Section" TITLE="Previous Section" BORDER="0"></A></TD><TD WIDTH="236" HEIGHT="25" VALIGN="top" ALIGN="right"><A HREF="r_26.html" BORDER="0"><IMG SRC="../img/vb_next.gif" WIDTH="65" HEIGHT="17" ALT="Next Section" TITLE="Next Section" BORDER="0"></A></TD><TD WIDTH="36"></TD></TR></TABLE><TABLE BORDER="0" WIDTH="550" CELLSPACING="0" CELLPADDING="0"><TR><TD COLSPAN="2" ALIGN="Left" VALIGN="Bottom" HEIGHT="20"><IMG SRC="../img/blackdot.gif" WIDTH="550" HEIGHT="1"></TD></TR><TR><TD HEIGHT="11" WIDTH="100%"><FONT FACE="Arial, Helvetica, sans-serif" SIZE="1">Books24x7.com, Inc © 2000&nbsp;–&nbsp;&nbsp;<A HREF="feedback.html+fb=1&bkid=232&chnkid=25.html"  BORDER="0"><FONT COLOR="#333333">Feedback</FONT></A></FONT></TD></TR></TABLE>

</BODY>
</HTML>
