
<HTML>
<HEAD>
<TITLE> Pthreads ProgrammingChapter 3 - Synchronizing Pthreads</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">

</HEAD>
<BODY  LINK="#122EB2"  LEFTMARGIN=0 TOPMARGIN=5 >






<A NAME="toppage"></A><TABLE BORDER="0" CELLSPACING="1" CELLPADDING="1"><TR ALIGN="right"><TD  HEIGHT="44"><A HREF="../toc.html"  BORDER="0"><IMG SRC="../img/vb_toc.gif" WIDTH="114" HEIGHT="17" BORDER="0"></A><A HREF="bookmark.html+bkid=232&chnkid=30.html"  BORDER="0"><IMG SRC="../img/bookmark_create.gif" WIDTH="115" HEIGHT="17" BORDER="0"></A><A HREF="bookshelf.html+bkid=232&chnkid=30&addbk=1.html"  BORDER="0"><IMG SRC="../img/vblue_add_book.gif" WIDTH="106" HEIGHT="17" ALT="Add Book to My Bookshelf" TITLE="Add Book to My Bookshelf" BORDER="0"></A><A HREF="buybook.html+bkid=232.html" TARGET="_top" BORDER="0"><IMG SRC="../img/vb_purchase.gif" WIDTH="108" HEIGHT="17" ALT="Purchase This Book Online" TITLE="Purchase This Book Online" BORDER="0"></A></TD></TR><TR VALIGN="top"><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="1"><TR VALIGN="top" HEIGHT=5><TD ROWSPAN="3"  VALIGN=top ALIGN=left WIDTH="100" HEIGHT="110"><IMG SRC="../img/1565921151.gif" WIDTH="79" HEIGHT="103" ALIGN=Left BORDER="0"></TD><TD><FONT FACE="Arial, Helvetica, sans-serif" SIZE="3"><H3>Chapter 3 - Synchronizing Pthreads</H3></FONT></TD></TR><TR><TD><FONT FACE="Arial, Helvetica" SIZE="2">Pthreads Programming</FONT></TD></TR><TR VALIGN=top><TD HEIGHT="30"><FONT FACE="Arial, Helvetica" SIZE="2">Bradford Nichols, Dick Buttlar and Jacqueline Proulx Farrell</FONT></TD></TR></TABLE></TD></TR><TR><TD><TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%"><TR><TD WIDTH="176" VALIGN="top"></TD><TD WIDTH="120" VALIGN="top"><FONT FACE="Arial, Helvetica" SIZE="1" COLOR="#122EB2">&nbsp;</FONT></TD><TD WIDTH="249" ALIGN="right" VALIGN="top"><FONT FACE="Arial, Helvetica" SIZE="2">Copyright © 1996 O'Reilly & Associates, Inc.</FONT></TD></TR></TABLE></TD></TR><TR VALIGN="middle"><TD HEIGHT="32" WIDTH="470"><TABLE WIDTH="545" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="545" COLSPAN=2><HR WIDTH="100%" ALIGN="left" SIZE="1" NOSHADE></TD><TD WIDTH="0" ALIGN="right"></TD></TR></TABLE></TD></TR></TABLE><A HREF="r_986087076.html" BORDER="0"></A><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=548300></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="000080"><B>Synchronization in the ATM Server</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557068></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">To wrap up our discussion of mutex and condition variables, we'll return to our ATM example. In our discussion of mutexes earlier in this chapter, we added a single mutex to the example to protect the bank account database. As we noted at the time, this isn't the best way to impose synchronization inasmuch as it allows only one thread to access the database at a time. </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557323></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In this section, we'll provide a more optimal solution to our ATM server's synchronization problems. We'll focus on the following three areas:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557442></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Synchronizing access to the bank account database</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557559></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Limiting the number of concurrent worker threads</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557643></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=2% VALIGN=TOP><FONT SIZE="2" FACE="Arial" COLOR="010100">•</FONT></TD><TD WIDTH=1%></TD><TD WIDTH=93% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Controlling the shutdown of the server</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557741></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We'll continue to use mutex variables to synchronize access to account data. Imposing a limit on the number of simultaneously active worker threads and controlling server shutdown are event-driven tasks; we'll use both mutexes and condition variables when implementing them.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=557934></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We first encountered the ATM server example in </FONT><A HREF=viewer_r.html+bkid=232&destid=197663.html#197663><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 2</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">. We designed it according to the classic boss/worker model for a multithreaded program. In our server, the boss creates a new thread for each request it receives (be it a deposit, withdrawal, or balance inquiry), and the worker thread processes the request independently of the boss or any other worker thread. We've done only half the job by creating threads and adding concurrency to the server. Now we'll finish up by adding robust and efficient synchronization mechanisms.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=558252></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="800000"><B>Synchronizing Access to Account Data</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=558411></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Our multithreaded ATM server must contend with many potential race conditions between worker threads accessing account data. We expect its deposit and withdraw operations to be atomic. Because of this, in </FONT><A HREF=viewer_r.html+bkid=232&destid=397338.html#397338><FONT SIZE="2" FACE="Arial" COLOR="008000">Example 3-1</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000"> we added a single mutex to the server to protect the integrity of the accounts database.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=558618></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Although simple, this approach has major performance limitations. Because every worker thread accesses the database and only one at a time can lock the mutex, only one thread can be executing each time an account balance changes. When the server is heavily loaded, the new result is that it behaves very like a single-threaded program. Because different requests frequently access different accounts in the database, multiple requests could often execute at the same time without interfering with each other. In this light, the single-mutex approach is overly conservative.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=558943></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">A much more appropriate solution would be to use finer-grained locking on our data. Thus, we'll associate a mutex with each database account.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559066></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The cleanest way to proceed with this decision would be to redesign the ATM server's database module to include mutexes in the account structures themselves. For our purposes, let's assume that the database module is legacy code and we can't—or don't want to—modify it. Instead, we'll place the mutex in a separate structure outside the database module.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559294></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In the code fragment in Example 3-15, we'll implement our locking scheme. We'll globally define an array of mutex variables, called </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>account_mutex</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, that has an element for each account. Because accounts have IDs between zero and MAX_NUM_ACCOUNTS, we'll use the account ID as an index into the mutex array. The server's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine will initialize the mutex array by calling </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>atm_server_init</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559554></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-15: Initializing per-account locks for the ATM database (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559665></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">pthread_mutex_t account_mutex[MAX_NUM_ACCOUNTS];</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559776></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559857></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559917></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=559977></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">void atm_server_init(int argc, char **argv)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560041></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560101></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560163></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560225></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560287></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; for (i = 0; i &lt; MAX_NUM_ACCOUNTS; i++)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560365></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; pthread_mutex_init(&amp;account_mutex[i], NULL);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560452></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560514></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560576></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560638></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560698></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560758></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Now, with this set of mutexes, a worker thread need lock only the mutex for the specific account it is accessing. It no longer needs to lock up the entire database; other threads can concurrently lock other mutexes and access other accounts, as shown in Example 3-16.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=560939></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-16: Using Per-Account Locks for the ATM Database (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561061></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">void deposit(char *req_buf, char *resp_buf)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561160></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561241></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int rtn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561308></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int temp, id, password, amount;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561394></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; account_t *accountp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561457></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561517></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; /* Parse input string */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561584></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; sscanf(req_buf, "%d %d %d %d ", &amp;temp, &amp;id, &amp;password, &amp;amount);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561670></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561730></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; /* Check inputs */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561795></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; if ((id &lt; 0) || (id &gt;= MAX_NUM_ACCOUNTS)) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561885></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; sprintf(resp_buf, "%d %s", TRANS_FAILURE, ERR_MSG_BAD_ACCOUNT);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=561956></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; return;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562022></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562084></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562144></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_lock(&amp;account_mutex[id]);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562226></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562286></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; /* Retrieve account from database */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562351></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; if ((rtn = retrieve_account( id, &amp;accountp)) &lt; 0) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562432></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; sprintf(resp_buf, "%d %s", TRANS_FAILURE, atm_err_tbl[-rtn]);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562518></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562582></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562646></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562710></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /* Code to update and access account balance. */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562802></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562862></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562924></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=562984></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_unlock(&amp;account_mutex[id]);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=563066></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=563126></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=563186></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=563246></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The thread that runs our</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I> create_open</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine to create a new account poses a special problem. Which mutex should it lock? The account doesn't exist yet, and the worker thread has no account ID to use!</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=573452></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Let's look at how the database layer of our ATM server actually creates a new account.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=573553></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The database contains a list of potential accounts, each with a flag indicating whether or not it's in use. The </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>new_account </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine looks for the first account whose in-use flag is clear, sets the flag, and plugs in the information about the new account.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=573753></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Here is fertile ground for a classic race condition. If two threads execute </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>new_account</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> concurrently, they could interleave their flag-reading and flag-setting. Both could return with the same account ID for two different customer accounts—not a good idea. To remove this hazard, we'll need an additional mutex.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=573995></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">The revision of the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>create_account </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">routine in Example 3-17 shows the new mutex. Any thread wishing to add an account must hold this mutex (which we've globally defined) before proceeding.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574160></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-17: A Special Mutex for Opening New Accounts (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574284></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">pthread_mutex_t create_account_mutex = PTHREAD_MUTEX_INITIALIZER;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574390></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574471></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574531></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574591></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">void create_account(char *resp_buf)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574681></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574741></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574807></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int rtn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574874></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; account_t *accountp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574937></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=574997></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_lock(&amp;create_account_mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575082></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575142></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; /* Get a new account */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575218></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; if ((rtn = new_account(&amp;id, &amp;accountp)) &lt; 0) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575307></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; sprintf(resp_buf, "%d %d %d %s", TRANS_FAILURE, -1, -1, atm_err_tbl[-rtn]);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575407></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575471></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575535></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575599></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575661></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575721></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_unlock(&amp;create_account_mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575806></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575866></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=575926></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Note that deleting an account will work the same way. There is symmetry in creating an object and destroying an object: both require the same kind of protection.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=576114></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="800000"><B>Limiting the Number of Worker Threads</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=576267></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Our next synchronization task will be to limit the number of worker threads that can exist at a single time. There are some good reasons for doing so. On some operating systems, the kernel manages threads as separate contenders for the CPU, just as it manages processes. These systems must limit the number of threads each user may run at a time. Even if your system imposes no limit or an extremely high one, you reach a practical limit at the point you find that you're getting diminishing returns by creating more and more threads.</FONT><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"> We'll examine this phenomenon further in our performance measurements in </FONT><A HREF=viewer_r.html+bkid=232&destid=1166241.html#1166241><FONT SIZE="2" FACE="Arial" COLOR="008000">Chapter 6</FONT></A><FONT SIZE="2" FACE="Arial" COLOR="000000">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=576683></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%>&nbsp;</TD><TD WIDTH=1% VALIGN=TOP><SUP>*</SUP><FONT SIZE="2" FACE="Arial" COLOR="000000"></FONT></TD><TD WIDTH=1%></TD><TD WIDTH=94% VALIGN=TOP ALIGN=left><SUP></SUP><FONT SIZE="2" FACE="Arial" COLOR="000000">Thread pools don't have this problem. The number of worker threads is determined and fixed at initialization. At this point, the worker threads are created, and they live for the duration of the program.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=576856></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">To limit the number of worker threads, we'll need to keep a count of them. Both boss and worker threads must access this counter. The boss thread increments it when it creates a new worker, and each worker decrements it when it exits. We'll synchronize access to the counter using a mutex.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577064></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In Example 3-18, we'll modify our ATM to add a </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>worker_info </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">structure. It'll include a counter (</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>num_active</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">), a mutex (</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>num_active_mutex</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">), and a condition variable (</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">). The server's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine will set the counter to zero and initialize the mutex and the condition variable.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577310></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-18: Limiting the Number of Worker Threads—Boss (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577434></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">#define MAX_NUM_THREADS 10</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577536></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577617></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577677></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577737></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">typedef struct {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577805></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; num_active;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577891></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_cond_t&nbsp; thread_exit_cv;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=577958></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_t mutex;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578024></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}thread_info_t;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578094></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578154></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">thread_info_t worker_info;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578231></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578291></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578351></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">extern int</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578412></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">main(argc, argv)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578473></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">int argc;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578539></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">char **argv;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578601></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578661></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; workorder_t *workorderp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578724></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_t&nbsp;&nbsp; *worker_threadp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578787></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int&nbsp; conn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578856></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int&nbsp; trans_id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578919></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=578979></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; atm_server_init(argc, argv);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579042></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579102></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; for(;;) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579171></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579231></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /*** Wait for a request ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579298></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; workorderp = (workorder_t *)malloc(sizeof(workorder_t));</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579365></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; server_comm_get_request(&amp;workorderp-&gt;conn, workorderp-&gt;req_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579430></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579494></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579558></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579622></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /*** Have we exceeded our limit of active threads ? ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579728></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; pthread_mutex_lock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579793></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; while (worker_info.num_active == MAX_NUM_THREADS) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579902></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_cond_wait(&amp;worker_info.thread_exit_cv,</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=579996></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=580056></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=580151></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=589836></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; worker_info.num_active++;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=589920></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; pthread_mutex_unlock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=589985></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590045></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /*** Spawn a thread to process this request ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590131></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; pthread_create(worker_threadp, ...</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590216></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590280></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590344></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590408></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590469></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; server_comm_shutdown();</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590534></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; return 0;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590597></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590657></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=590717></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Now, when the boss thread receives a request, it locks the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>worker_info </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">mutex and checks the count of active workers before creating a new worker thread. If the number of active workers has not yet reached its limit, the boss increments the counter, unlocks the mutex, and continues. If the limit has been reached, the boss waits on the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">condition variable. When the condition is signaled the boss wakes up and rechecks the counter. If the count of active workers is now below the limit, the boss increments the counter, unlocks the mutex, and continues.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591070></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In Example 3-19, we'll adjust the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>process_request </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">code our worker threads execute.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591164></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-19: Limiting the Number of Worker Threads—Workers (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591291></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">void process_request(workorder_t *workorderp)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591375></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591456></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; char resp_buf[COMM_BUF_SIZE];</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591519></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int&nbsp; trans_id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591582></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591642></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; sscanf(workorderp-&gt;req_buf, "%d", &amp;trans_id);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591705></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; switch(trans_id) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591784></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case OPEN_ACCT_TRANS:</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591870></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; open_account(resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=591953></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592025></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592096></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592167></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592238></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592304></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592364></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; server_comm_send_response(workorderp-&gt;conn, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592427></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592487></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; free(workorderp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592550></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592610></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_lock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592673></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; worker_info.num_active--;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592755></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; if (worker_info.num_active == (MAX_NUM_THREADS - 1))</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592846></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp; pthread_cond_signal(&amp;worker_info.thread_exit_cv);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592912></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_unlock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=592975></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=593035></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=593095></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">Each worker thread must decrement the active worker count when it exits. It does this in the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>process_request</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine. If it finds that it has decremented the counter to one less than the limit, it calls </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>pthread_cond_signal </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">to signal the</FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> condition variable to the waiting boss thread.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=593313></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="4" FACE="Arial" COLOR="800000"><B>Synchronizing a Server Shutdown</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=593463></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">In the current version of our ATM server, the boss thread runs our program's </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine. When the boss thread finishes </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, the system terminates the process and all its threads, including those worker threads that are still processing active requests. We can't allow this to happen, so our final synchronization task will be to handle server shutdown more gracefully.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=593704></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">To make sure that all worker threads get to complete active tasks before the boss thread exits </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">, we'll reuse the active worker counter and the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> condition variable. When we used them to control the number of concurrent workers, the boss thread requested a signal when the active worker count was one less than the active worker limit. This time, the boss will request the signal when the active worker count reaches zero. (Of course, at some time, the boss will stop creating new threads so that this can eventually happen.) We'll modify the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>main</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine in the boss thread, as shown in Example 3-20.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594019></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-20: Processing a Shutdown in the Boss Thread (atm_svr.c) </B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594134></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">extern int</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594218></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">main(argc, argv)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594300></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">int argc;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594366></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">char **argv;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594428></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594488></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; workorder_t *workorderp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594551></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_t&nbsp;&nbsp; *worker_threadp;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594614></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int&nbsp; conn;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594683></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; int&nbsp; trans_id;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594746></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594806></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; atm_server_init(argc, argv);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594869></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594929></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; for(;;) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=594998></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595058></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /*** Wait for a request ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595125></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; workorderp = (workorder_t *)malloc(sizeof(workorder_t));</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595192></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; server_comm_get_request(&amp;workorderp-&gt;conn, workorderp-&gt;req_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595257></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595317></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /*** Is it a shutdown request? ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595402></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; sscanf(workorderp-&gt;req_buf, "%d", &amp;trans_id);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595467></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; if (trans_id == SHUTDOWN)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595555></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char resp_buf[COMM_BUF_SIZE];</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595622></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595682></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_mutex_lock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595749></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595809></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Wait for in-progress requests threads to finish */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595886></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (worker_info.num_active &gt; 0) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=595982></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_cond_wait(&amp;worker_info.thread_exit_cv, &amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596102></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596168></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_mutex_unlock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596235></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596295></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* process it here with main() thread */</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596383></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (shutdown_req(workorderp-&gt;req_buf, resp_buf)) {</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596451></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_comm_send_response(workorderp-&gt;conn, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596524></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free(workorderp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596597></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596670></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596736></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596800></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=596860></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; /*** Have we exceeded our limit of active threads ? ***/</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606251></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; pthread_mutex_lock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606316></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606380></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606444></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp;&nbsp;&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606508></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; }</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606570></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; server_comm_shutdown();</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606635></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; return 0;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606698></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=606758></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">When the boss thread receives a shutdown request, it locks the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>worker_info</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> mutex and checks the active worker counter. If the active worker counter is zero, the boss unlocks the mutex, runs a cleanup function, and leaves the main loop, thus terminating the program. If the counter is greater than zero, the boss must wait for the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">condition variable to be signaled. When it's awakened, the boss rechecks the active worker count. If the final worker has exited, the count is zero, and the boss proceeds to shut down the program. If not, the boss must wait on the condition variable again. </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607115></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">We'll modify our </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>process_request</I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"> routine in Example 3-21 so that each worker thread signals the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">condition variable before it exits, as well as when it decrements the worker count to one below the limit. </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607274></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=12 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="800000"><B>Example 3-21: Processing a Shutdown in the Worker Thread (atm_svr.c)</B></FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607386></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">process_request(...)</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607475></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">{</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607556></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607618></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607680></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; .</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607742></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; server_comm_send_response(workorderp-&gt;conn, resp_buf);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607805></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607865></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; free(workorderp);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607928></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100"> </FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=607988></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_lock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=608051></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; worker_info.num_active--;</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=608133></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_cond_signal(&amp;worker_info.thread_exit_cv);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=608196></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">&nbsp; pthread_mutex_unlock(&amp;worker_info.mutex);</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=608259></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Courier New" COLOR="010100">}</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=550><TR><A NAME=608319></A><TD WIDTH=98% VALIGN=TOP>
<TABLE border=0 cellspacing=0 cellpadding=0 WIDTH=100%><TR><TD><IMG HEIGHT=6 WIDTH=1 SRC=_.gif></TD></TR><TR><TD WIDTH=2%></TD><TD WIDTH=96% VALIGN=TOP ALIGN=left><FONT SIZE="2" FACE="Arial" COLOR="010100">This works fine but is a bit inefficient. Although the boss can proceed with program shutdown only when the last worker has exited, each exiting worker thread will wake it up (and it will go right back to sleep) until the last worker decrements the active worker counter to 0. If ten worker threads are active when their boss receives the shutdown request, the boss will wake up and reenter its wait nine times before it can finally do something useful! We could fix this. Instead of using the </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>thread_exit_cv </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">condition variable for shutdown handling, we could define a new condition variable to indicate when the active worker count reaches zero. As it exits, each worker would call </FONT><FONT SIZE="2" FACE="Arial" COLOR="010100"><I>pthread_cond_signal </I></FONT><FONT SIZE="2" FACE="Arial" COLOR="010100">on our new condition variable if it notices that the count has become zero. If the boss thread is waiting on the condition, it will wake up and shut down the program.</FONT></TD><TD WIDTH=2%></TD></TR></TABLE></TD></TR></TABLE><A NAME="{B4AC29EB-8775-11D4-A9C0-0008C791A32F}"></A><TABLE WIDTH="545" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="509" COLSPAN="3"><HR WIDTH="100%" ALIGN="left" SIZE="1" NOSHADE></TD><TD WIDTH="36" ALIGN="right"><A HREF="#toppage" BORDER="0"><IMG SRC="../img/to_top.gif" WIDTH="25" HEIGHT="11" BORDER="0"></A></TD></TR><TR><TD WIDTH="36"></TD><TD WIDTH="236" HEIGHT="25" VALIGN="top" ALIGN="left"><A HREF="r_29.html" BORDER="0"><IMG SRC="../img/vb_prev.gif" WIDTH="65" HEIGHT="17" ALT="Previous Section" TITLE="Previous Section" BORDER="0"></A></TD><TD WIDTH="236" HEIGHT="25" VALIGN="top" ALIGN="right"><A HREF="r_31.html" BORDER="0"><IMG SRC="../img/vb_next.gif" WIDTH="65" HEIGHT="17" ALT="Next Section" TITLE="Next Section" BORDER="0"></A></TD><TD WIDTH="36"></TD></TR></TABLE><TABLE BORDER="0" WIDTH="550" CELLSPACING="0" CELLPADDING="0"><TR><TD COLSPAN="2" ALIGN="Left" VALIGN="Bottom" HEIGHT="20"><IMG SRC="../img/blackdot.gif" WIDTH="550" HEIGHT="1"></TD></TR><TR><TD HEIGHT="11" WIDTH="100%"><FONT FACE="Arial, Helvetica, sans-serif" SIZE="1">Books24x7.com, Inc © 2000&nbsp;–&nbsp;&nbsp;<A HREF="feedback.html+fb=1&bkid=232&chnkid=30.html"  BORDER="0"><FONT COLOR="#333333">Feedback</FONT></A></FONT></TD></TR></TABLE>

</BODY>
</HTML>
