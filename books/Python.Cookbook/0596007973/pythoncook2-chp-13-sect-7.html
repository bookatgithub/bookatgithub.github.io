<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Recipe&nbsp;13.7.&nbsp;Unpacking a Multipart MIME Message</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="toc.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=pythoncook2-chp-13-sect-6.html><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href=pythoncook2-chp-13-sect-8.html><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</div></td></tr></table>
<br><table width="100%" border="0" cellspacing="0" cellpadding="0"><TR><td valign="top"><a name="pythoncook2-CHP-13-SECT-7"></a>
<h3 class="docSection1Title">Recipe 13.7. Unpacking a Multipart MIME Message</h3>

<p class="docText"><span class="docEmphasis">Credit: Matthew Cowles</span></p>

<a name="pythoncook2-CHP-13-SECT-7.1"></a>
<h4 class="docSection2Title">Problem</h4>

<p class="docText"><a name="pythoncook2-CHP-13-ITERM-2842"></a>You want to unpack a multipart MIME
message.</P>


<a name="pythoncook2-CHP-13-SECT-7.2"></a>
<h4 class="docSection2Title">Solution</H4>

<p class="docText">The <tt>walk</tt> method of message objects generated by
the <tt>email</tt> package makes this task really easy.
Here is a script that uses <tt>email</tt> to solve the task
posed in the "Problem":</p>

<pre>import email.Parser
import os, sys
def main( ):
    if len(sys.argv) != 2:
        print "Usage: %s filename" % os.path.basename(sys.argv[0])
        sys.exit(1)
    mailFile = open(sys.argv[1], "rb")
    p = email.Parser.Parser( )
    msg = p.parse(mailFile)
    mailFile.close( )
    partCounter = 1
    for part in msg.walk( ):
        if part.get_main_type( ) == "multipart":
            continue
        name = part.get_param("name")
        if name == None:
            name = "part-%i" % partCounter
        partCounter += 1
        # In real life, make sure that name is a reasonable filename 
        # for your OS; otherwise, mangle that name until it is!
        f = open(name, "wb")
        f.write(part.get_payload(decode=1))
        f.close( )
        print name
if _ _name_ _=="_ _main_ _":
    main( )</pre><BR>



<a name="pythoncook2-CHP-13-SECT-7.3"></a>
<h4 class="docSection2Title">Discussion</H4>

<p class="docText">The <tt>email</tt> package makes parsing MIME messages
reasonably easy. This recipe shows how to unbundle a
<tt>MIME</tt> message with the <tt>email</tt>
package by using the <tt>walk</tt> method of message
objects.</P>

<p class="docText">You can create a message object in several ways. For example, you can
instantiate the <tt>email.Message.Message</tt> class and
build the message object's contents with calls to
its methods. In this recipe, however, I need to read and analyze an
existing message, so I work the other way around, calling the
<tt>parse</tt> method of an
<tt>email.Parser.Parser</tt> instance. The
<tt>parse</tt> method takes as its only argument a
file-like object (in the recipe, I pass it a real file object that I
just opened for binary reading with the built-in
<tt>open</tt> function) and returns a message object, on
which you can call message object methods.</p>

<p class="docText">The <tt>walk</tt> method is a generator (i.e., it returns
an iterator object on which you can loop with a
<tt>for</tt> statement). You usually will use this method
exactly as I use it in this recipe:</P>

<pre>for part in msg.walk( ):</pre><BR>


<p class="docText">The iterator sequentially returns (depth-first, in case of nesting)
the parts that make up the message. If the message is not a container
of parts (i.e., has no attachments or
alternates<tt>message.is_multipart</tt> returns
false), no problem: the <tt>walk</tt> method will then
return an iterator with a single elementthe message itself. In
any case, each element of the iterator is also a message object (an
instance of <tt>email.Message.Message</tt>), so you can
call on it any of the methods that a message object supplies.</p>

<p class="docText">In a multipart message, parts with a type of
'<tt>multipart/something</tt>' (i.e., a main type of
'<tt>multipart</tt>') may be present. In this recipe, I
skip them explicitly since they're just glue holding
the true parts together. I use the <tt>get_main_type</tt>
method to obtain the main type and check it for equality with
'<tt>multipart</tt>'; if equality holds, I skip this part
and move to the next one with a <tt>continue</tt>
statement. When I know I have a real part in hand, I locate its name
(or synthesize one if it has no name), open that name as a file, and
write the message's contents (also known as the
message's <i>payload</i>), which I
get by calling the <tt>get_payload</tt> method, into the
file. I use the <tt>decode=1</tt> argument to ensure that
the payload is decoded back to a binary content (e.g., an image, a
sound file, a movie) if needed, rather than remaining in text form.
If the payload is not encoded, <tt>decode=1</tt> is
innocuous, so I don't have to check before I pass
it.</p>


<a name="pythoncook2-CHP-13-SECT-7.4"></a>
<H4 class="docSection2Title">See Also</h4>

<p class="docText"><a class="docLink" href="pythoncook2-CHP-13-SECT-6.html#pythoncook2-CHP-13-SECT-6">Recipe 13.6</a>; documentation
for the standard library package <tt>email</tt> in the
<span class="docEmphasis">Library Reference</span>.<a name="pythoncook2-CHP-13-ITERM-2843"></a></p>



<a href="5991535.html"><img src="images/pixel.gif" alt="" width="1" height="1" border="0"></a><UL></ul></TD></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="toc.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=pythoncook2-chp-13-sect-6.html><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href=pythoncook2-chp-13-sect-8.html><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</div></td></tr></table>
</body></html>