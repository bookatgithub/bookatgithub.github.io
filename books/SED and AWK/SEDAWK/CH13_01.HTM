<HTML
><HEAD
>
<TITLE>[Chapter 13] A Miscellany of Scripts</TITLE>
<META
NAME="DC.title"
CONTENT="sed &amp; awk"><META
NAME="DC.creator"
CONTENT="Dale Dougherty &amp; Arnold Robbins"><META
NAME="DC.publisher"
CONTENT="O'Reilly &amp; Associates, Inc."><META
NAME="DC.date"
CONTENT="1998-08-03T21:04:59Z"><META
NAME="DC.type"
CONTENT="Text.Monograph"><META
NAME="DC.format"
CONTENT="text/html"
SCHEME="MIME"><META
NAME="DC.source"
CONTENT="1-56592-225-5"
SCHEME="ISBN"><META
NAME="DC.language"
CONTENT="en-US"><META
NAME="generator"
CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINK
REV="made"
HREF="mailto:online-books@oreilly.com"
TITLE="Online Books Comments"><LINK
REL="up"
HREF="index.htm"
TITLE="sed &amp; awk"><LINK
REL="prev"
HREF="ch12_03.htm"
TITLE="12.3 Spare Details of the masterindex Program"><LINK
REL="next"
HREF="ch13_02.htm"
TITLE="13.2 phonebill&nbsp;- Track Phone Usage"></HEAD
><BODY
BGCOLOR="#FFFFFF"
TEXT="#000000"
><DIV
CLASS="htmlnav"
><H1
><IMG
SRC="gifs/smbanner.gif"
ALT="sed &amp; awk"
USEMAP="#srchmap"
BORDER="0"></H1
><MAP
NAME="srchmap"
><AREA
SHAPE="RECT"
COORDS="0,0,466,65"
HREF="index.htm"
ALT="sed &amp; awk"><AREA
SHAPE="RECT"
COORDS="467,0,514,18"
HREF="../search/ssrch.htm"
ALT="Search this book"></MAP
><TABLE
WIDTH="515"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="SECT1"
HREF="ch12_03.htm"
TITLE="12.3 Spare Details of the masterindex Program"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 12.3 Spare Details of the masterindex Program"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="171"
><B
><FONT
FACE="ARIEL,HELVETICA,HELV,SANSERIF"
SIZE="-1"
>Chapter 13</FONT
></B
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="SECT1"
HREF="ch13_02.htm"
TITLE="13.2 phonebill&nbsp;- Track Phone Usage"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 13.2 phonebill&nbsp;- Track Phone Usage"
BORDER="0"></A
></TD
></TR
></TABLE
>&nbsp;<HR
ALIGN="LEFT"
WIDTH="515"
TITLE="footer"></DIV
><DIV
CLASS="CHAPTER"
><H1
CLASS="chapter"
><A
CLASS="title"
NAME="SEDAWK-CH-13"
>13. A Miscellany of Scripts</A
></H1
><DIV
CLASS="htmltoc"
><P
><B
>Contents:</B
><BR><A
CLASS="sect1"
HREF="#AUTOID-11215"
TITLE="13.1 uutot.awk&nbsp;- Report UUCP Statistics"
>uutot.awk&nbsp;- Report UUCP Statistics</A
><BR><A
CLASS="sect1"
HREF="ch13_02.htm"
TITLE="13.2 phonebill&nbsp;- Track Phone Usage"
>phonebill&nbsp;- Track Phone Usage</A
><BR><A
CLASS="sect1"
HREF="ch13_03.htm"
TITLE="13.3 combine&nbsp;- Extract Multipart uuencoded Binaries"
>combine&nbsp;- Extract Multipart uuencoded Binaries</A
><BR><A
CLASS="sect1"
HREF="ch13_04.htm"
TITLE="13.4 mailavg&nbsp;- Check Size of Mailboxes"
>mailavg&nbsp;- Check Size of Mailboxes</A
><BR><A
CLASS="sect1"
HREF="ch13_05.htm"
TITLE="13.5 adj&nbsp;- Adjust Lines for Text Files"
>adj&nbsp;- Adjust Lines for Text Files</A
><BR><A
CLASS="sect1"
HREF="ch13_06.htm"
TITLE="13.6 readsource&nbsp;- Format Program Source Files for troff"
>readsource&nbsp;- Format Program Source Files for troff</A
><BR><A
CLASS="sect1"
HREF="ch13_07.htm"
TITLE="13.7 gent&nbsp;- Get a termcap Entry"
>gent&nbsp;- Get a termcap Entry</A
><BR><A
CLASS="sect1"
HREF="ch13_08.htm"
TITLE="13.8 plpr&nbsp;- lpr Preprocessor"
>plpr&nbsp;- lpr Preprocessor</A
><BR><A
CLASS="sect1"
HREF="ch13_09.htm"
TITLE="13.9 transpose&nbsp;- Perform a Matrix Transposition"
>transpose&nbsp;- Perform a Matrix Transposition</A
><BR><A
CLASS="sect1"
HREF="ch13_10.htm"
TITLE="13.10 m1&nbsp;- Simple Macro Processor"
>m1&nbsp;- Simple Macro Processor</A
></P
><P
></P
></DIV
><P
CLASS="para"
>This chapter contains a miscellany of scripts contributed by Usenet
users.<A
CLASS="indexterm"
NAME="CH13.SCRIPT"
></A
>
Each program is introduced with a brief description
by the program's author.
Our comments are placed inside brackets [like this].
Then the full program listing is shown.  If the author
did not supply an example, we generate one 
and describe it after the listing. 
Finally, in a section called &quot;Program Notes,&quot;
we talk briefly about the program, highlighting some interesting points.
Here is a summary of the scripts:

<DL
CLASS="variablelist"
><DT
CLASS="term"
><KBD
CLASS="command"
>uutot.awk</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Report UUCP statistics.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>phonebill</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Track phone usage.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>combine</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Extract multipart uuencoded binaries.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>mailavg</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Check size of mailboxes.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>adj</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Adjust lines for text files.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>readsource</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Format program source files for <KBD
CLASS="command"
>troff</KBD
>.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>gent</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Get a termcap entry.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>plpr</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
><KBD
CLASS="command"
>lpr</KBD
> preprocessor.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>transpose</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>Perform a matrix transposition.</P
></DD
><DT
CLASS="term"
><KBD
CLASS="command"
>m1</KBD
></DT
><DD
CLASS="listitem"
><P
CLASS="para"
>A very simple macro processor.</P
></DD
></DL
></P
><DIV
CLASS="sect1"
><H2
CLASS="sect1"
><A
CLASS="title"
NAME="AUTOID-11215"
>13.1 uutot.awk&nbsp;- Report UUCP Statistics</A
></H2
><P
CLASS="para"
><EM
CLASS="emphasis"
>Contributed by Roger A. Cornelius</EM
></P
><P
CLASS="para"
><A
CLASS="indexterm"
NAME="CH13.UUTOT"
></A
>Here's something I wrote in nawk in response to all the C versions 
of the same thing which were posted to <EM
CLASS="emphasis"
>alt.sources</EM
> awhile back.
Basically, it summarizes statistics of <KBD
CLASS="command"
>uucp</KBD
> connections (connect time,
throughput, files transmitted, etc.).  It only supports HDB-style log
files, but will show statistics on a site-by-site, or on an overall
(all sites), basis.
[It also works with <I
CLASS="filename"
>/usr/spool/uucp/SYSLOG</I
>.]</P
><P
CLASS="para"
>I use a shell wrapper which calls &quot;awk -f&quot; to run this, but it's not
necessary.  Usage information is in the header.
(Sorry about the lack of comments.)</P
><BLOCKQUOTE
CLASS="screen"
><PRE
CLASS="screen"
># @(#) uutot.awk - display uucp statistics - requires new awk
# @(#) Usage:awk -f uutot.awk [site ...] /usr/spool/uucp/.Admin/xferstats
# Author: Roger A. Cornelius (rac@sherpa.uucp)

#       dosome[];               # site names to work for - all if not set
#       remote[];               # array of site names
#       bytes[];                # bytes xmitted by site
#       time[];	               # time spent by site
#       files[];                # files xmitted by site
BEGIN {
	doall = 1;
	if (ARGC &gt; 2) {
		doall = 0;
		for (i = 1; i &lt; ARGC-1; i++) {
			dosome[ ARGV[i] ];
			ARGV[i] = &quot;&quot;;
		}
	}

	kbyte = 1024	# 1000 if you're not picky
	bang = &quot;!&quot;;
	sending = &quot;-&gt;&quot;;
	xmitting = &quot;-&gt;&quot; &quot;|&quot; &quot;&lt;-&quot;;

	hdr1 = &quot;Remote     K-Bytes   K-Bytes   K-Bytes &quot; \
		&quot;Hr:Mn:Sc Hr:Mn:Sc AvCPS AvCPS    #    #\n&quot;;
	hdr2 = &quot;SiteName      Recv      Xmit     Total     &quot; \
		&quot;Recv     Xmit  Recv  Xmit Recv Xmit\n&quot;;
	hdr3 = &quot;-------- --------- --------- --------- -------- &quot; \
		&quot;-------- ----- ----- ---- ----&quot;;
	fmt1 = &quot;%-8.8s %9.3f %9.3f %9.3f %2d:%02d:%02.0f &quot; \
		&quot;%2d:%02d:%02.0f %5.0f %5.0f %4d %4d\n&quot;;
	fmt2 = &quot;Totals   %9.3f %9.3f %9.3f %2d:%02d:%02.0f &quot; \
		&quot;%2d:%02d:%02.0f %5.0f %5.0f %4d %4d\n&quot;;
}
{
	if ($6 !~ xmitting)		# should never be
		next;
	direction = ($6 == sending ? 1 : 2)

	site = substr($1,1,index($1,bang)-1);
	if (site in dosome || doall) {
		remote[site];
		bytes[site,direction] += $7;
		time[site,direction] += $9;
		files[site,direction]++;
	}
}
END {
	print hdr1 hdr2 hdr3;
	for (k in remote) {
		rbyte += bytes[k,2];	sbyte += bytes[k,1];
		rtime += time[k,2];	stime += time[k,1];
		rfiles += files[k,2];	sfiles += files[k,1];
		printf(fmt1, k, bytes[k,2]/kbyte, bytes[k,1]/kbyte,
			(bytes[k,2]+bytes[k,1])/kbyte,
			time[k,2]/3600, (time[k,2]%3600)/60, time[k,2]%60,
			time[k,1]/3600, (time[k,1]%3600)/60, time[k,1]%60,
			bytes[k,2] &amp;&amp; time[k,2] ? bytes[k,2]/time[k,2] : 0,
			bytes[k,1] &amp;&amp; time[k,1] ? bytes[k,1]/time[k,1] : 0,
			files[k,2], files[k,1]);
	}

	print hdr3
	printf(fmt2, rbyte/kbyte, sbyte/kbyte, (rbyte+sbyte)/kbyte,
		rtime/3600, (rtime%3600)/60, rtime%60,
		stime/3600, (stime%3600)/60, stime%60,
		rbyte &amp;&amp; rtime ? rbyte/rtime : 0,
		sbyte &amp;&amp; stime ? sbyte/stime : 0,
		rfiles, sfiles);
}</PRE
></BLOCKQUOTE
><P
CLASS="para"
>A test file was generated to test Cornelius' program. 
Here are a few lines extracted
from <I
CLASS="filename"
>/usr/spool/uucp/.Admin/xferstats</I
> (because
each line in this file is too long to print on a page, we have broken
the line following the directional arrow for display purposes only):</P
><BLOCKQUOTE
CLASS="screen"
><PRE
CLASS="screen"
>isla!nuucp S (8/3-16:10:17) (C,126,25) [ttyi1j] -&gt;
                     1131/4.880 secs, 231 bytes/sec
isla!nuucp S (8/3-16:10:20) (C,126,26) [ttyi1j] -&gt;
                     149/0.500 secs, 298 bytes/sec
isla!sue S (8/3-16:10:49) (C,126,27) [ttyi1j] -&gt;
                     646/25.230 secs, 25 bytes/sec
isla!sue S (8/3-16:10:52) (C,126,28) [ttyi1j] -&gt;
                     145/0.510 secs, 284 bytes/sec
uunet!uisla M (8/3-16:15:50) (C,951,1) [cui1a] -&gt;
                     1191/0.660 secs, 1804 bytes/sec
uunet!uisla M (8/3-16:15:53) (C,951,2) [cui1a] -&gt;
                     148/0.080 secs, 1850 bytes/sec
uunet!uisla M (8/3-16:15:57) (C,951,3) [cui1a] -&gt;
                     1018/0.550 secs, 1850 bytes/sec
uunet!uisla M (8/3-16:16:00) (C,951,4) [cui1a] -&gt;
                     160/0.070 secs, 2285 bytes/sec
uunet!daemon M (8/3-16:16:06) (C,951,5) [cui1a] &lt;-
                     552/2.740 secs, 201 bytes/sec
uunet!daemon M (8/3-16:16:09) (C,951,6) [cui1a] &lt;-
                     102/1.390 secs, 73 bytes/sec</PRE
></BLOCKQUOTE
><P
CLASS="para"
>Note that there are 12 fields; however, the program really only
uses fields 1, 6, 7, and 9.
Running the program on the sample input produces the following results:</P
><BLOCKQUOTE
CLASS="screen"
><PRE
CLASS="screen"
>$ <CODE
CLASS="userinput"
><B
>nawk -f uutot.awk uutot.test</B
></CODE
>
Remote     K-Bytes   K-Bytes   K-Bytes Hr:Mn:Sc Hr:Mn:Sc AvCPS AvCPS    #    #
SiteName      Recv      Xmit     Total     Recv     Xmit  Recv  Xmit Recv Xmit
-------- --------- --------- --------- -------- -------- ----- ----- ---- ----
uunet        0.639     2.458     3.097  0:04:34  2:09:49     2     0    2    4
isla         0.000     2.022     2.022  0:00:00  0:13:58     0     2    0    4
-------- --------- --------- --------- -------- -------- ----- ----- ---- ----
Totals       0.639     4.480     5.119  0:04:34  2:23:47     2     1    2    8</PRE
></BLOCKQUOTE
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="SEDAWK-CH-13-SECT-0.0.0.1"
>13.1.1 Program Notes for uutot.awk</A
></H3
><P
CLASS="para"
>This nawk application is an excellent example of a clearly written
awk program. 
It is also a typical example of using awk to change a rather
obscure UNIX log into a useful report.</P
><P
CLASS="para"
>Although Cornelius apologizes for the lack of comments that explain
the logic of the program, the usage of the program is clear
from the initial comments.  Also, he uses
variables to define search patterns and the report's layout.
This helps to simplify conditional and print statements in
the body of the program.
It also helps that the variables have names which aid
in immediately recognizing their purpose.</P
><P
CLASS="para"
>This program has a three-part structure, as
we emphasized in <A
CLASS="xref"
HREF="ch07_01.htm"
TITLE="Writing Scripts for awk"
>Chapter 7, Writing Scripts for awk</A
>.  It consists of a <KBD
CLASS="command"
>BEGIN</KBD
>
procedure, in which variables are defined; the body,
in which each line of data from the log file is processed;
and the <KBD
CLASS="command"
>END</KBD
> procedure, in which the output for the report
is generated.</P
></DIV
><A
CLASS="indexterm"
NAME="AUTOID-11241"
></A
></DIV
></DIV
><DIV
CLASS="htmlnav"
><P
></P
><HR
ALIGN="LEFT"
WIDTH="515"
TITLE="footer"><TABLE
WIDTH="515"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="SECT1"
HREF="ch12_03.htm"
TITLE="12.3 Spare Details of the masterindex Program"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 12.3 Spare Details of the masterindex Program"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="171"
><A
CLASS="book"
HREF="index.htm"
TITLE="sed &amp; awk"
><IMG
SRC="../gifs/txthome.gif"
ALT="sed &amp; awk"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="SECT1"
HREF="ch13_02.htm"
TITLE="13.2 phonebill&nbsp;- Track Phone Usage"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 13.2 phonebill&nbsp;- Track Phone Usage"
BORDER="0"></A
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="172"
>12.3 Spare Details of the masterindex Program</TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="171"
><A
CLASS="index"
HREF="index/idx_0.htm"
TITLE="Book Index"
><IMG
SRC="../gifs/index.gif"
ALT="Book Index"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="172"
>13.2 phonebill&nbsp;- Track Phone Usage</TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="515"
TITLE="footer"><IMG
SRC="../gifs/smnavbar.gif"
USEMAP="#map"
BORDER="0"
ALT="The UNIX CD Bookshelf Navigation"><MAP
NAME="map"
><AREA
SHAPE="RECT"
COORDS="0,0,73,21"
HREF="../index.htm"
ALT="The UNIX CD Bookshelf"><AREA
SHAPE="RECT"
COORDS="74,0,163,21"
HREF="../upt/index.htm"
ALT="UNIX Power Tools"><AREA
SHAPE="RECT"
COORDS="164,0,257,21"
HREF="../unixnut/index.htm"
ALT="UNIX in a Nutshell"><AREA
SHAPE="RECT"
COORDS="258,0,321,21"
HREF="../vi/index.htm"
ALT="Learning the vi Editor"><AREA
SHAPE="RECT"
COORDS="322,0,378,21"
HREF="index.htm"
ALT="sed &amp; awk"><AREA
SHAPE="RECT"
COORDS="379,0,438,21"
HREF="../ksh/index.htm"
ALT="Learning the Korn Shell"><AREA
SHAPE="RECT"
COORDS="439,0,514,21"
HREF="../lrnunix/index.htm"
ALT="Learning the UNIX Operating System"></MAP
></DIV
></BODY
></HTML
>
